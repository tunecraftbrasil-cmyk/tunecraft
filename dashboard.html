<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Cliente | TuneCraft</title>
  <link rel="stylesheet" href="chat.css" />

  <!-- Supabase JS (apenas UMA vez) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
/* =========================================================
   ‚úÖ TUNECRAFT DASHBOARD ‚Äî CSS LIMPO (SAFE)
   - Mant√©m: modais, cards, toasts, player, tabbar mobile, FAB
   - Adiciona: header mobile sticky (app-like)
   ========================================================= */

/* ========== BASE ========== */
*{ margin:0; padding:0; box-sizing:border-box; }

:root{
  --bg:#070b14;
  --surface:#0b1220;
  --surface-2:#0f1a2e;
  --border:rgba(148,163,184,.22);

  --text:#e5e7eb;
  --text-2:#cbd5e1;
  --muted:#94a3b8;

  --brand:#00d9ff;
  --brand-2:#6366f1;

  --success:#10b981;
  --warn:#f59e0b;
  --danger:#ef4444;

  --shadow:0 18px 60px rgba(0,0,0,.45);
}

html, body{ height:100%; }
body{
  font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  height:100vh;
  overflow:hidden;
}

/* ========== SIDEBAR (DESKTOP) ========== */
.sidebar{
  width:260px;
  background:linear-gradient(180deg, #070b14 0%, #0a0e27 100%);
  color:var(--text);
  display:flex;
  flex-direction:column;
  padding:20px;
  flex-shrink:0;
  overflow:hidden;
  border-right:1px solid rgba(255,255,255,.06);
}

.logo-container{
  margin-bottom:40px;
  display:flex;
  align-items:center;
  gap:10px;
  min-height:50px;
}

/* menu */
.menu-item{
  padding:15px;
  margin-bottom:6px;
  border-radius:10px;
  cursor:pointer;
  transition:.25s;
  display:flex;
  align-items:center;
  gap:10px;
  color:var(--muted);
  user-select:none;
  -webkit-tap-highlight-color:transparent;
}

.menu-item:hover{
  background:rgba(255,255,255,.10);
  color:var(--text);
}

.menu-item.active{
  background:rgba(255,255,255,.10);
  color:var(--text);
  border-left:3px solid var(--brand);
}

.menu-icon{
  width:24px;
  height:24px;
  object-fit:contain;
  display:block;
  opacity:.86;
}
.menu-item.active .menu-icon{
  opacity:1;
  filter:brightness(1.15);
}

/* bot√£o nova m√∫sica (desktop) */
.new-music-btn{
  margin-top:auto;
  background:linear-gradient(135deg, var(--brand), var(--brand-2));
  color:#fff;
  padding:15px;
  border-radius:12px;
  text-align:center;
  font-weight:900;
  transition:.25s;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:8px;
  cursor:pointer;
  border:none;
  box-shadow:0 12px 26px rgba(0,217,255,.18);
}
.new-music-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 16px 34px rgba(0,217,255,.22);
}

/* ========== MAIN CONTENT ========== */
.main-content{
  flex:1;
  overflow-y:auto;
  padding:30px;
  position:relative;
  min-width:0;
  background:
    radial-gradient(1200px 700px at 30% 0%, rgba(0,217,255,.10), transparent 60%),
    radial-gradient(900px 600px at 80% 20%, rgba(99,102,241,.10), transparent 60%),
    var(--bg);
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:30px;
  gap:12px;
  flex-wrap:wrap;
}

.user-profile{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}

.avatar{
  width:40px;
  height:40px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(148,163,184,.18);
  border-radius:999px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:900;
  color:var(--text-2);
  flex:0 0 auto;
}

/* sections */
.section{ display:none; animation:fadeIn .25s; }
.section.active{ display:block; }

@keyframes fadeIn{
  from{ opacity:0; transform:translateY(10px); }
  to{ opacity:1; transform:translateY(0); }
}

/* ========== CARDS ========== */
.card{
  background:rgba(15,26,46,.82);
  border-radius:12px;
  padding:25px;
  margin-bottom:20px;
  border:1px solid rgba(148,163,184,.18);
  box-shadow:0 10px 28px rgba(0,0,0,.28);
  color:var(--text);
  backdrop-filter:blur(8px);
}

.card-header{
  display:flex;
  justify-content:space-between;
  margin-bottom:15px;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}

.card h2, .card h3, .card h4{ color:var(--text); }

/* status */
.status-badge{
  padding:5px 12px;
  border-radius:20px;
  font-size:.75rem;
  font-weight:900;
  text-transform:uppercase;
  border:1px solid rgba(255,255,255,.10);
}
.status-pending{ background:rgba(245,158,11,.14); color:#fbbf24; }
.status-production{ background:rgba(59,130,246,.14); color:#93c5fd; }
.status-completed{ background:rgba(16,185,129,.14); color:#6ee7b7; }
.status-awaiting{ background:rgba(245,158,11,.16); color:#fcd34d; }
.status-draft{ background:rgba(190,24,93,.16); color:#f9a8d4; }

/* draft */
.draft-summary{
  background:rgba(255,255,255,.04);
  border-radius:10px;
  padding:15px;
  margin-bottom:15px;
  border-left:4px solid #be185d;
}
.draft-summary p{
  margin:8px 0;
  font-size:.95rem;
  color:var(--text-2);
  word-break:break-word;
}
.draft-summary p strong{ color:var(--text); }

/* lyrics */
.lyrics-box{
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  background:rgba(255,255,255,.04);
  padding:20px;
  border-radius:10px;
  border:1px solid rgba(148,163,184,.22);
  white-space:pre-wrap;
  margin:15px 0;
  max-height:300px;
  overflow-y:auto;
  word-break:break-word;
  color:var(--text-2);
}

/* compara√ß√£o */
.comparison-container{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
  margin:20px 0;
  min-width:0;
}
.version-card{
  border:1px solid rgba(148,163,184,.22);
  border-radius:12px;
  padding:20px;
  background:rgba(255,255,255,.03);
  min-width:0;
}
.version-changelog{
  background:rgba(245,158,11,.10);
  border-left:3px solid rgba(245,158,11,.85);
  padding:10px;
  margin:10px 0;
  font-size:.9rem;
  border-radius:6px;
  word-break:break-word;
  color:var(--text-2);
}

/* actions + bot√µes */
.action-row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}

.btn{
  padding:10px 20px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  font-weight:900;
  transition:.2s;
}

.btn-approve{
  background:var(--success);
  color:#062012;
}
.btn-approve:hover{ filter:brightness(1.05); }
.btn-approve:disabled{
  background:rgba(148,163,184,.35);
  cursor:not-allowed;
}

.btn-revise{
  background:transparent;
  border:2px solid rgba(245,158,11,.75);
  color:#fbbf24;
}
.btn-revise:hover{ background:rgba(245,158,11,.12); }
.btn-revise:disabled{
  background:rgba(255,255,255,.03);
  color:rgba(148,163,184,.8);
  border-color:rgba(148,163,184,.25);
  cursor:not-allowed;
}

.btn-download{
  background:#0b1020;
  border:1px solid rgba(148,163,184,.22);
  color:var(--text);
  display:inline-flex;
  align-items:center;
  gap:6px;
  text-decoration:none;
  padding:10px 14px;
  border-radius:10px;
}

.btn-select{
  background:linear-gradient(135deg, var(--brand), var(--brand-2));
  color:#001018;
  width:100%;
  margin-top:10px;
}

/* ========== PROFILE / FORMS ========== */
.profile-form label{
  display:block;
  margin-top:15px;
  font-weight:800;
  font-size:.9rem;
  color:var(--text);
}
.profile-form input{
  width:100%;
  padding:10px;
  border:2px solid rgba(148,163,184,.18);
  border-radius:10px;
  margin-top:6px;
  max-width:420px;
  background:rgba(255,255,255,.04);
  color:var(--text);
}
#profEmail{
  background:rgba(255,255,255,.03) !important;
  color:var(--muted) !important;
}
.btn-save-profile{
  margin-top:20px;
  background:linear-gradient(135deg, var(--brand), var(--brand-2));
  color:#fff;
  border:none;
  padding:10px 25px;
  border-radius:10px;
  cursor:pointer;
  font-weight:900;
}

/* ========== EMPTY STATE PREMIUM ========== */
.tc-empty{
  display:flex;
  justify-content:center;
  align-items:center;
  padding:44px 16px;
}
.tc-empty-card{
  width:min(560px, 100%);
  background:rgba(15,26,46,.65);
  border:1px solid rgba(148,163,184,.18);
  border-radius:18px;
  padding:26px 22px;
  text-align:center;
  box-shadow:0 18px 60px rgba(0,0,0,.35);
  backdrop-filter:blur(10px);
}
.tc-empty-logo{
  width:76px;
  height:76px;
  margin:6px auto 14px;
  display:grid;
  place-items:center;
  border-radius:18px;
  background:
    radial-gradient(circle at 30% 20%, rgba(0,217,255,.18), transparent 55%),
    radial-gradient(circle at 70% 80%, rgba(99,102,241,.18), transparent 55%),
    rgba(255,255,255,.03);
  border:1px solid rgba(148,163,184,.16);
}
.tc-empty-logo img{
  width:56px;
  height:56px;
  object-fit:contain;
  filter:drop-shadow(0 10px 20px rgba(0,217,255,.15));
}
.tc-empty-title{
  font-size:1.15rem;
  font-weight:900;
  color:var(--text);
  margin-bottom:6px;
  letter-spacing:.2px;
}
.tc-empty-sub{
  color:rgba(203,213,225,.80);
  font-size:.98rem;
  line-height:1.35;
  margin-bottom:18px;
}
.tc-empty-cta{
  width:100%;
  max-width:340px;
  margin:0 auto;
  border:none;
  cursor:pointer;
  font-weight:900;
  font-size:1rem;
  padding:14px 16px;
  border-radius:14px;
  color:#061018;
  background:linear-gradient(135deg, var(--brand), var(--brand-2));
  box-shadow:0 14px 30px rgba(0,217,255,.16);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  transition:.2s ease;
}
.tc-empty-cta:hover{
  transform:translateY(-2px);
  box-shadow:0 18px 38px rgba(0,217,255,.22);
}
.tc-empty-hint{
  margin-top:12px;
  font-size:.85rem;
  color:rgba(148,163,184,.85);
}

/* ========== TOASTS ========== */
@keyframes slideInRight{
  from{ transform:translateX(400px); }
  to{ transform:translateX(0); }
}

.toast-message,
.edit-draft-toast{
  position:fixed;
  bottom:20px;
  right:20px;
  padding:14px 20px;
  border-radius:12px;
  box-shadow:0 14px 40px rgba(0,0,0,.35);
  display:none;
  z-index:9999;
  animation:slideInRight .25s;
  max-width:calc(100vw - 40px);
  word-break:break-word;
}
.toast-message{ background:#3b82f6; color:#fff; }
.toast-message.error{ background:var(--danger); }
.toast-message.success{ background:var(--success); color:#062012; }
.toast-message.info{ background:#3b82f6; }

.edit-draft-toast{ z-index:10001; background:#3b82f6; color:#fff; }
.edit-draft-toast.error{ background:var(--danger); }
.edit-draft-toast.success{ background:var(--success); color:#062012; }
.edit-draft-toast.info{ background:#3b82f6; }

/* ========== MODAIS (ALTERAR + LETRA + EDIT) ========== */
.alterar-modal,
.edit-draft-modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.72);
  z-index:10000;
  align-items:center;
  justify-content:center;
  padding:16px;
}
.alterar-modal.active,
.edit-draft-modal.active{ display:flex; }

.alterar-content,
.edit-draft-content{
  background:rgba(11,18,32,.96);
  border:1px solid rgba(148,163,184,.20);
  border-radius:18px;
  width:90%;
  max-width:900px;
  max-height:90vh;
  overflow-y:auto;
  padding:26px;
  box-shadow:var(--shadow);
  color:var(--text);
}

.alterar-header,
.edit-draft-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:18px;
  gap:10px;
}

.alterar-close,
.edit-draft-close{
  background:none;
  border:none;
  font-size:28px;
  cursor:pointer;
  color:var(--muted);
  line-height:1;
}
.alterar-close:hover,
.edit-draft-close:hover{ color:var(--text); }

/* alterar modal fields */
.alterar-step{ margin-bottom:18px; }
.alterar-step h3{ margin-bottom:10px; color:var(--text); }

.alterar-step textarea{
  width:100%;
  min-height:120px;
  padding:12px;
  border:2px solid rgba(148,163,184,.18);
  border-radius:12px;
  font-size:15px;
  font-family:inherit;
  resize:vertical;
  background:rgba(255,255,255,.04);
  color:var(--text);
}
.alterar-step textarea:focus{
  outline:none;
  border-color:rgba(0,217,255,.85);
  box-shadow:0 0 0 3px rgba(0,217,255,.14);
}

.char-count{
  text-align:right;
  font-size:.85rem;
  color:var(--muted);
  margin-top:6px;
}

.alterar-buttons{
  display:flex;
  gap:10px;
  margin-top:18px;
  flex-wrap:wrap;
}

.btn-alterar-cancel{
  flex:1;
  padding:12px;
  border:2px solid rgba(148,163,184,.25);
  background:transparent;
  border-radius:12px;
  cursor:pointer;
  font-weight:900;
  color:var(--text-2);
  min-width:180px;
}
.btn-alterar-submit{
  flex:2;
  padding:12px;
  border:none;
  background:linear-gradient(135deg, var(--brand), var(--brand-2));
  color:#fff;
  border-radius:12px;
  cursor:pointer;
  font-weight:900;
  min-width:220px;
}
.btn-alterar-submit:disabled{
  background:rgba(148,163,184,.35);
  cursor:not-allowed;
}

/* edit draft */
.edit-draft-header{
  padding-bottom:16px;
  border-bottom:2px solid rgba(148,163,184,.16);
  flex-wrap:wrap;
}
.edit-draft-header h2{ color:var(--text); font-size:22px; margin:0; }
.edit-draft-header-info{ font-size:.85rem; color:var(--muted); margin-top:6px; }

.edit-draft-loading{
  display:flex;
  align-items:center;
  justify-content:center;
  height:200px;
  font-size:16px;
  color:var(--muted);
}

.edit-draft-section-title{
  font-size:15px;
  font-weight:900;
  color:var(--text);
  margin-top:22px;
  margin-bottom:12px;
  padding:10px 0;
  border-bottom:2px solid rgba(148,163,184,.16);
}

.edit-draft-form-group{
  margin-bottom:16px;
  padding:14px;
  background:rgba(255,255,255,.03);
  border-radius:12px;
  border-left:4px solid var(--brand);
}
.edit-draft-form-group label{
  display:block;
  margin-bottom:8px;
  font-weight:900;
  color:var(--text);
  font-size:.9rem;
}
.edit-draft-form-group .field-name{
  font-size:.75rem;
  color:var(--muted);
  margin-bottom:6px;
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  word-break:break-word;
}
.edit-draft-form-group input,
.edit-draft-form-group textarea,
.edit-draft-form-group select{
  width:100%;
  padding:10px;
  border:2px solid rgba(148,163,184,.18);
  border-radius:10px;
  font-size:14px;
  font-family:inherit;
  transition:.2s;
  min-width:0;
  background:rgba(255,255,255,.04);
  color:var(--text);
}
.edit-draft-form-group textarea{ resize:vertical; min-height:90px; }
.edit-draft-form-group input:focus,
.edit-draft-form-group textarea:focus,
.edit-draft-form-group select:focus{
  outline:none;
  border-color:rgba(0,217,255,.85);
  box-shadow:0 0 0 3px rgba(0,217,255,.14);
}

.edit-draft-actions{
  display:flex;
  gap:12px;
  margin-top:22px;
  padding-top:18px;
  border-top:2px solid rgba(148,163,184,.16);
  justify-content:flex-end;
  flex-wrap:wrap;
}
.edit-draft-btn{
  padding:12px 22px;
  border:none;
  border-radius:12px;
  font-weight:900;
  cursor:pointer;
  transition:.25s;
  font-size:14px;
}
.edit-draft-btn-cancel{
  background:transparent;
  border:2px solid rgba(148,163,184,.25);
  color:var(--text-2);
}
.edit-draft-btn-cancel:hover{ background:rgba(255,255,255,.04); }
.edit-draft-btn-save{
  background:linear-gradient(135deg, var(--brand), var(--brand-2));
  color:#fff;
}
.edit-draft-btn-save:hover{
  transform:translateY(-2px);
  box-shadow:0 10px 20px rgba(0,217,255,.18);
}
.edit-draft-btn-save:disabled{
  background:rgba(148,163,184,.35);
  cursor:not-allowed;
  transform:none;
}

/* Letra modal textarea */
#lyricsModalText{
  background:rgba(255,255,255,.04);
  color:var(--text);
  border:2px solid rgba(148,163,184,.18);
  border-radius:12px;
  padding:12px;
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  resize:vertical;
}

/* ========== RESPONSIVO: TABLET ========== */
@media (max-width:1024px){
  .main-content{ padding:22px; }
  .card{ padding:20px; }
  .sidebar{ width:240px; }
}

/* ========== DESKTOP COMPACT SIDEBAR (769‚Äì1100) ========== */
@media (min-width:769px) and (max-width:1100px){
  .sidebar{
    width:92px;
    padding:18px 10px;
    align-items:center;
  }
  .logo-container{ display:none; }
  .menu-item{
    justify-content:center;
    padding:14px 10px;
  }
  .menu-item span{ display:none; }
  .new-music-btn{
    width:56px;
    height:56px;
    border-radius:999px;
    padding:0;
    font-size:0;
    margin:14px 0 0 0;
    position:static;
    transform:none;
  }
  .new-music-btn::before{
    content:"+";
    font-size:30px;
    font-weight:900;
    color:#fff;
    line-height:1;
  }
}

/* ========== MOBILE: TAB BAR + FAB + HEADER STICKY ========== */
@media (max-width:768px){
  body{ flex-direction:column; height:100vh; }

  /* header app-like */
  .header{
    position:sticky;
    top:0;
    z-index:60;
    padding:14px 14px;
    margin-bottom:12px;
    background:rgba(7,11,20,.72);
    backdrop-filter:blur(10px);
    -webkit-backdrop-filter:blur(10px);
    border-bottom:1px solid rgba(255,255,255,.06);
  }

  /* sidebar vira tab bar */
  .sidebar{
    position:fixed;
    left:0; right:0; bottom:0;
    width:100%;
    height:calc(74px + env(safe-area-inset-bottom));
    padding:8px 10px calc(8px + env(safe-area-inset-bottom));
    z-index:9998;

    background:rgba(10,14,39,.92);
    backdrop-filter:blur(10px);
    -webkit-backdrop-filter:blur(10px);
    border-top:1px solid rgba(255,255,255,.08);
    border-right:none;

    flex-direction:row;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }

  .logo-container{ display:none; }

  .sidebar nav{
    width:100%;
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    align-items:center;
    gap:0;
    padding:0;
    overflow:hidden;
  }

  .menu-item{
    position:relative; /* ‚úÖ necess√°rio pro ::after */
    margin:0;
    padding:8px 4px;
    border-radius:12px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:6px;
    text-align:center;
    white-space:nowrap;
    min-width:0;
    border-left:none;
    background:transparent;
    color:rgba(203,213,225,.72);
  }

  .menu-item.active{
    color:#fff;
    background:rgba(0,217,255,.12);
  }

  .menu-item.active::after{
    content:"";
    position:absolute;
    top:6px;
    width:6px;
    height:6px;
    border-radius:999px;
    background:var(--brand);
    box-shadow:0 0 14px rgba(0,217,255,.55);
  }

  .menu-icon{ width:28px; height:28px; }

  .menu-item span{
    display:block;
    font-size:11px;
    line-height:1.05;
    opacity:.92;
    max-width:100%;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* FAB central com diamante */
  .new-music-btn{
    position:fixed;
    left:50%;
    transform:translateX(-50%);
    bottom:calc(74px + env(safe-area-inset-bottom) + 14px);
    width:60px;
    height:60px;
    border-radius:999px;
    padding:0;
    z-index:9999;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:0; /* esconde texto */
  }

  /* remove o + e coloca diamante */
  .new-music-btn::before{ content:""; }
  .new-music-btn::after{
    content:"";
    width:28px;
    height:28px;
    background:url("./images/diamante.png") center/contain no-repeat;
    filter:drop-shadow(0 10px 18px rgba(0,217,255,.25));
    display:block;
  }

  .new-music-btn:hover{ transform:translateX(-50%); }

  .main-content{
    padding:16px;
    padding-bottom:calc(74px + env(safe-area-inset-bottom) + 90px);
    height:100vh;
    overflow-y:auto;
  }

  .header h2{ font-size:1.15rem; }
  .avatar{ width:36px; height:36px; }

  .card{ padding:18px; }
  .btn{ width:100%; justify-content:center; }
  .btn-download{ width:100%; justify-content:center; }
  .comparison-container{ grid-template-columns:1fr; gap:14px; }
  .lyrics-box{ max-height:260px; padding:14px; }

  .alterar-content, .edit-draft-content{
    width:100%;
    padding:18px;
    border-radius:16px;
  }

  /* toast acima da tab bar */
  .toast-message,
  .edit-draft-toast{
    bottom:calc(74px + env(safe-area-inset-bottom) + 18px);
    right:14px;
    left:14px;
    max-width:calc(100vw - 28px);
  }
}

@media (max-width:420px){
  .sidebar{ height:calc(70px + env(safe-area-inset-bottom)); }
  .new-music-btn{
    width:56px; height:56px;
    bottom:calc(70px + env(safe-area-inset-bottom) + 14px);
  }
  .main-content{
    padding:14px;
    padding-bottom:calc(70px + env(safe-area-inset-bottom) + 90px);
  }
}

/* ========== SCROLLBAR (WEBKIT) ========== */
::-webkit-scrollbar{ width:10px; height:10px; }
::-webkit-scrollbar-track{ background:rgba(255,255,255,.03); }
::-webkit-scrollbar-thumb{ background:rgba(148,163,184,.22); border-radius:999px; }
::-webkit-scrollbar-thumb:hover{ background:rgba(148,163,184,.35); }

/* =========================================================
   ‚úÖ TUNECRAFT AUDIO PLAYER
========================================================= */
.tc-player{
  background:rgba(255,255,255,.03);
  border:1px solid rgba(148,163,184,.18);
  border-radius:14px;
  padding:12px;
  display:grid;
  grid-template-columns:auto 1fr auto;
  gap:12px;
  align-items:center;
}

.tc-btn{
  width:44px;
  height:44px;
  border-radius:12px;
  border:1px solid rgba(148,163,184,.22);
  background:rgba(11,18,32,.9);
  color:var(--text);
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  transition:.2s;
}
.tc-btn:hover{ transform:translateY(-1px); border-color:rgba(0,217,255,.45); }

.tc-btn.play{
  border:none;
  background:linear-gradient(135deg, var(--brand), var(--brand-2));
  color:#fff;
  box-shadow:0 12px 24px rgba(0,217,255,.14);
}

.tc-main{ min-width:0; display:grid; gap:8px; }
.tc-top{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:baseline;
  min-width:0;
}
.tc-title{
  font-weight:900;
  color:var(--text);
  font-size:.95rem;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.tc-time{
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-size:.82rem;
  color:var(--muted);
  flex:0 0 auto;
}

.tc-bar{
  position:relative;
  height:10px;
  border-radius:999px;
  background:rgba(148,163,184,.16);
  overflow:hidden;
  cursor:pointer;
}
.tc-progress{
  position:absolute;
  left:0; top:0; bottom:0;
  width:0%;
  border-radius:999px;
  background:linear-gradient(135deg, var(--brand), var(--brand-2));
}
.tc-dot{
  position:absolute;
  top:50%;
  transform:translate(-50%, -50%);
  width:12px; height:12px;
  border-radius:999px;
  background:#fff;
  box-shadow:0 0 0 4px rgba(0,217,255,.18);
  left:0%;
  pointer-events:none;
}

.tc-actions{ display:flex; gap:8px; align-items:center; }
.tc-mini{
  width:44px;
  height:44px;
  border-radius:12px;
  border:1px solid rgba(148,163,184,.22);
  background:rgba(11,18,32,.85);
  color:var(--text);
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  transition:.2s;
}
.tc-mini:hover{ border-color:rgba(0,217,255,.45); transform:translateY(-1px); }
.tc-vol{ width:92px; accent-color:var(--brand); }

@media (max-width:768px){
  .tc-player{
    grid-template-columns:auto 1fr;
    grid-template-rows:auto auto;
  }
  .tc-actions{
    grid-column:1 / -1;
    justify-content:space-between;
  }
  .tc-vol{ width:120px; }
}


</style>

</head>
<body>

  <!-- Chat Modal (criar nova m√∫sica) -->
  <div class="chat-modal" id="chatModal">
    <div class="chat-container">
      <div class="chat-header">
        <h2>üéµ Criar Nova M√∫sica</h2>
        <button class="close-chat" onclick="closeChat()">√ó</button>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-section" id="inputSection"></div>
    </div>
  </div>

  <!-- ‚úÖ Modal de Altera√ß√£o de Letra -->
  <div class="alterar-modal" id="alterarModal">
    <div class="alterar-content">
      <div class="alterar-header">
        <h2>‚úèÔ∏è Alterar Letra</h2>
        <button class="alterar-close" onclick="fecharAlterarModal()">√ó</button>
      </div>

      <div class="alterar-step">
        <h3>O que voc√™ gostaria de mudar na letra? üéµ</h3>
        <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 10px;">
          üí° Exemplos: "Tornar o refr√£o mais animado", "Adicionar men√ß√£o a Dourados", "Mudar o tom de rom√¢ntico para alegre"
        </p>
        <textarea
          id="mudancasDesejadas"
          placeholder="Ex: Gostaria que o refr√£o fosse mais energ√©tico e mencionasse nossa viagem para o Rio..."
          maxlength="500"
          oninput="updateAlterarCharCount('mudancasDesejadas', 'count1')"
        ></textarea>
        <div class="char-count"><span id="count1">0</span>/500</div>
      </div>

      <div class="alterar-step">
        <h3>H√° algo espec√≠fico que DEVE permanecer? üîí</h3>
        <textarea
          id="manterElementos"
          placeholder="Ex: Mantenha as refer√™ncias a Dourados e o nome 'Aline'..."
          maxlength="300"
          oninput="updateAlterarCharCount('manterElementos', 'count2')"
        ></textarea>
        <div class="char-count"><span id="count2">0</span>/300</div>
      </div>

      <div class="alterar-step">
        <h3>Observa√ß√µes finais sobre o tom ou estilo? üé® (Opcional)</h3>
        <textarea
          id="observacoesFinais"
          placeholder="Ex: Quero que seja mais emocionante, menos melanc√≥lica..."
          maxlength="200"
          oninput="updateAlterarCharCount('observacoesFinais', 'count3')"
        ></textarea>
        <div class="char-count"><span id="count3">0</span>/200</div>
      </div>

      <div class="alterar-buttons">
        <button class="btn-alterar-cancel" onclick="fecharAlterarModal()">Cancelar</button>
        <button class="btn-alterar-submit" id="btnSubmitAlteracao" onclick="submitAlteracao()">
          Enviar Altera√ß√µes ‚ú®
        </button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ MODAL DE EDI√á√ÉO DE RASCUNHO -->
  <div class="edit-draft-modal" id="editDraftModal">
    <div class="edit-draft-content">
      <div class="edit-draft-header">
        <div>
          <h2>‚úèÔ∏è Editar Rascunho</h2>
          <div class="edit-draft-header-info" id="editDraftHeaderInfo">Carregando...</div>
        </div>
        <button class="edit-draft-close" onclick="closeEditDraftModal()">√ó</button>
      </div>

      <div id="editDraftLoading" class="edit-draft-loading">
        ‚è≥ Carregando rascunho...
      </div>

      <form id="editDraftForm" style="display: none;">
        <!-- Formul√°rio ser√° populado dinamicamente -->
      </form>
    </div>
  </div>

  <div class="edit-draft-toast" id="editDraftToast"></div>

  <aside class="sidebar">
    <div class="logo-container">
      <img src="https://i.ibb.co/wFFzDMy9/tunecraft-logo-transparente.png" alt="TuneCraft" style="height: 50px;">
    </div>

    <nav style="flex: 1;">
 <div class="menu-item active" onclick="showSection('drafts', this)">
  <img class="menu-icon" src="assets/icons/drafts.png" alt="">
  <span>Meus Rascunhos</span>
</div>

<div class="menu-item" onclick="showSection('pending', this)">
  <img class="menu-icon" src="assets/icons/approve.png" alt="">
  <span>Aprovar Letra</span>
</div>

<div class="menu-item" onclick="showSection('received', this)">
  <img class="menu-icon" src="assets/icons/music.png" alt="">
  <span>M√∫sicas</span>
</div>

    </nav>


    <button class="new-music-btn" onclick="openChat()">
      + Nova M√∫sica
    </button>
  </aside>

  <main class="main-content">
    <div class="header">
      <h2 id="pageTitle">Meus Rascunhos</h2>
      <div class="user-profile">
        <span id="userName">Usu√°rio</span>
        <button class="avatar avatar-btn" onclick="openProfile()" aria-label="Minha Conta" title="Minha Conta">U</button>
        <button onclick="logout()" style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:0.9rem; margin-left:10px;">Sair</button>
      </div>
    </div>

    <div id="drafts" class="section active"></div>

    <div id="pending" class="section"></div>

  

    

    <div id="profile" class="section">
      <h2>Meus Dados</h2>
      <div class="card profile-form">
        <label>Nome Completo</label>
        <input type="text" id="profName">

        <label>Email</label>
        <input type="email" id="profEmail" readonly style="background:#f1f5f9; color:#64748b;">

        <label>Nova Senha (deixe em branco para manter)</label>
        <input type="password" id="profPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">

        <button class="btn-save-profile" onclick="saveProfile()">Salvar Altera√ß√µes</button>
      </div>
    </div>
  </main>

  <!-- Toast de notifica√ß√µes -->
  <div class="toast-message" id="toastMessage"></div>

  <!-- NOVO: Config Global -->
  <script src="config.js"></script>
  <script src="form_options.js"></script> 
  <!-- Chat JS (agora sem redeclara√ß√£o) -->
  <script src="chat.js"></script>
  <script src="chat_themes_full.js"></script>


  

  <script>
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let userData = JSON.parse(localStorage.getItem("tuneCraftUser")) || { name: "Visitante", email: "", user_id: null, orders: [] };
    let currentAlterandoId = null;
    let editDraftCurrentPedidoId = null;

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toastMessage');
      toast.innerText = message;
      toast.className = `toast-message ${type}`;
      toast.style.display = 'block';

      setTimeout(() => {
        toast.style.display = 'none';
      }, 4000);
    }

    function normalizeStatus(s) {
      const v = (s || "").toLowerCase().replace(/\s+/g, "");
      if (v === "draft") return "draft";
      if (v === "pendingapproval" || v === "pending_approval" || v === "waiting_user_approval" || v === "waitinguserapproval") return "pending_approval";
      if (v === "aguardandoaprovacao" || v === "aguardando_aprovacao") return "aguardando_aprovacao";
      if (v === "production" || v === "inproduction" || v === "generatingaudio" || v === "generating_audio") return "production";
      if (v === "completed" || v === "done" || v === "received") return "completed";
      return v || "pending_approval";
    }

    function escapeHtml(str) {
      return (str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "'");
    }

    function extractSummaryFromPayload(payload) {
    const answers = payload.answers || {};
    const asked = payload.asked || [];
    const theme = answers.ai_metadata?.themeId || "indefinido";
    const genre = answers.musicStyle?.primaryGenre || "indefinido";
    
    // ‚úÖ Usar FORM_OPTIONS (vem de form_options.js)
    
    // Mapear tema usando FORM_OPTIONS.themes
    const themeOption = FORM_OPTIONS.themes.find(t => t.value === theme);
    const themeLabel = themeOption ? themeOption.label : "üé≠ Indefinido";
    
    // Mapear g√™nero usando FORM_OPTIONS.genres
    const genreOption = FORM_OPTIONS.genres.find(g => g.value === genre);
    const genreLabel = genreOption ? genreOption.label : "N√£o definido";
    
    // Obter primeira linha da mensagem principal
    const messagePreview = answers.lyricDetails?.mainMessage 
        ? answers.lyricDetails.mainMessage.substring(0, 70) + "..."
        : "Sem mensagem";
    
    return {
        recipient: themeLabel,  // Tema com emoji
        genre: genreLabel,      // G√™nero com emoji
        message: messagePreview,  // Pr√©via da mensagem
        asked_count: asked.length  // Quantas perguntas respondidas
    };
}

    async function getSessionOrRedirect() {
      const { data, error } = await sb.auth.getSession();
      if (error) console.warn("getSession error:", error);

      const session = data?.session;
      if (!session?.access_token || !session?.user?.id) {
        window.location.href = "login.html";
        return null;
      }
      return session;
    }

    async function loadOrdersFromSupabase() {
      const { data, error } = await sb
        .from("musicas_pedidos")
        .select("id,title,lyrics,status,created_at,audio_urls,versao_original,versao_modificada,versao_aprovada,alteracao_usada,versao_aprovada_tipo,alteracao_solicitada,payload")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Erro sb.from(musicas_pedidos):", error);
        return [];
      }

      return (data || []).map(r => {
        let audioUrls = r.audio_urls;

        if (Array.isArray(audioUrls) && audioUrls.length > 0 && typeof audioUrls[0] === 'string') {
          try {
            audioUrls = audioUrls.map(url => JSON.parse(url));
          } catch (e) {
            console.error("‚ùå Erro ao fazer parse de audio_urls:", e);
            audioUrls = [];
          }
        }

        return {
          id: r.id,
          title: r.title || "Sem t√≠tulo",
          lyrics: r.lyrics || "",
          status: normalizeStatus(r.status),
          created_at: r.created_at,
          audio_urls: audioUrls,
          versao_original: r.versao_original,
          versao_modificada: r.versao_modificada,
          versao_aprovada: r.versao_aprovada,
          alteracao_usada: r.alteracao_usada,
          versao_aprovada_tipo: r.versao_aprovada_tipo,
          alteracao_solicitada: r.alteracao_solicitada,
          payload: r.payload
        };
      });
    }

    async function initDashboard() {
      const session = await getSessionOrRedirect();
      if (!session) return;

      const fullName = session.user.user_metadata?.full_name || userData.name || "Usu√°rio";
      userData.name = fullName;
      userData.email = session.user.email || userData.email || "";
      userData.user_id = session.user.id;

      const orders = await loadOrdersFromSupabase();
      userData.orders = orders;

      localStorage.setItem("tuneCraftUser", JSON.stringify(userData));

      document.getElementById("userName").innerText = userData.name.split(" ")[0];
      document.querySelector(".avatar").innerText = userData.name.charAt(0);

      document.getElementById("profName").value = userData.name;
      document.getElementById("profEmail").value = userData.email;

      renderSections();
    }

    initDashboard();

    function showSection(id, element) {
      if (element) {
        document.querySelectorAll(".menu-item").forEach(i => i.classList.remove("active"));
        element.classList.add("active");
      }

      const titles = {
        drafts: "Meus Rascunhos",
        pending: "Aprovar Letra",
        received: "M√∫sicas",
        profile: "Minha Conta"
      };
      document.getElementById("pageTitle").innerText = titles[id] || "Painel";

      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

function openProfile(){
  showSection('profile', null); // abre a se√ß√£o
}


function openLyricsModal(text){
  const modal = document.getElementById("lyricsModal");
  const box = document.getElementById("lyricsModalText");
  box.value = text || "";
  modal.classList.add("active");
}

function closeLyricsModal(){
  document.getElementById("lyricsModal").classList.remove("active");
}

async function copyLyrics(){
  const text = document.getElementById("lyricsModalText").value || "";
  try{
    await navigator.clipboard.writeText(text);
    showToast("‚úÖ Letra copiada!", "success");
  }catch(e){
    // fallback
    document.getElementById("lyricsModalText").select();
    document.execCommand("copy");
    showToast("‚úÖ Letra copiada!", "success");
  }
}

    
    function renderSections() {
      const draftsContainer = document.getElementById("drafts");
      const pendingContainer = document.getElementById("pending");
      const receivedContainer = document.getElementById("received-list");

      draftsContainer.innerHTML = "";
      pendingContainer.innerHTML = "";
  
      receivedContainer.innerHTML = "";

      let hasDrafts = false;
      let hasPending = false;
    
      let hasReceived = false;

      if (userData.orders && userData.orders.length > 0) {
        userData.orders.forEach(order => {
          const title = escapeHtml(order.title);
          const lyrics = escapeHtml(order.lyrics);

          if (order.status === "draft") {
            hasDrafts = true;
            const summary = extractSummaryFromPayload(order.payload);
draftsContainer.innerHTML += `
    <div class="card draft-card">
        <div class="card-header">
            <h3>üéµ ${summary.recipient}</h3>
            <span class="status-badge status-draft">Rascunho</span>
        </div>
        <div class="draft-summary">
            <p><strong>Tema:</strong> ${summary.recipient}</p>
            <p><strong>G√™nero:</strong> ${summary.genre}</p>
            <p><strong>Perguntas:</strong> ${summary.asked_count} respondidas</p>
            <p><strong>Descri√ß√£o:</strong> "${summary.message}"</p>
        </div>
        <div class="action-row">
                  <button class="btn btn-revise" onclick="editarDraft('${order.id}')">
                    ‚úèÔ∏è Editar Formul√°rio
                  </button>
                  <button class="btn btn-approve" onclick="irParaCheckout('${order.id}')">
                    üí≥ Pagar e Gerar Letra (R$ 49,90)
                  </button>
        </div>
    </div>
`;
          }
          else if (order.status === "pending_approval" && !order.versao_modificada) {
            hasPending = true;
            const podeAlterar = !order.alteracao_usada;

            pendingContainer.innerHTML += `
              <div class="card">
                <div class="card-header">
                  <h3>${title}</h3>
                  <span class="status-badge status-pending">Aguardando Aprova√ß√£o</span>
                </div>
                <p style="font-size:0.9rem; color:#64748b;">Leia a letra gerada abaixo.</p>
                <div class="lyrics-box">${lyrics}</div>
                <div class="action-row">
                  <button
                    class="btn btn-revise"
                    onclick="abrirModalAlteracao('${order.id}')"
                    ${!podeAlterar ? 'disabled title="Altera√ß√£o j√° foi usada"' : ''}
                  >
                    ${podeAlterar ? '‚úèÔ∏è Solicitar Altera√ß√£o (1x)' : 'üîí Altera√ß√£o Usada'}
                  </button>
                  <button class="btn btn-approve" id="btn-${order.id}" onclick="aprovarLetraOriginal('${order.id}')">
                    ‚úÖ Aprovar e Gerar √Åudio
                  </button>
                </div>
              </div>
            `;
          }
          else if (order.status === "aguardando_aprovacao" && order.versao_modificada) {
            hasPending = true;

            const versaoOriginal = order.versao_original || { customer_lyrics: order.lyrics };
            const versaoModificada = order.versao_modificada;

            pendingContainer.innerHTML += `
              <div class="card">
                <div class="card-header">
                  <h3>${title}</h3>
                  <span class="status-badge status-awaiting">Escolha uma Vers√£o</span>
                </div>

                <p style="font-size:0.9rem; color:#64748b; margin-bottom: 15px;">
                  Compare as duas vers√µes e escolha sua favorita:
                </p>

                ${versaoModificada.changelog ? `
                  <div class="version-changelog">
                    <strong>üìù O que foi alterado:</strong><br>
                    ${escapeHtml(versaoModificada.changelog)}
                  </div>
                ` : ''}

                <div class="comparison-container">
                  <div class="version-card">
                    <h4>üìÑ Vers√£o Original</h4>
                    <div class="lyrics-box" style="max-height: 250px;">
                      ${escapeHtml(versaoOriginal.customer_lyrics || versaoOriginal.lyrics)}
                    </div>
                    <button class="btn btn-select" onclick="aprovarVersao('${order.id}', 'original')">
                      ‚úÖ Escolher Esta
                    </button>
                  </div>

                  <div class="version-card">
                    <h4>‚ú® Vers√£o Modificada</h4>
                    <div class="lyrics-box" style="max-height: 250px;">
                      ${escapeHtml(versaoModificada.customer_lyrics)}
                    </div>
                    <button class="btn btn-select" onclick="aprovarVersao('${order.id}', 'modificada')">
                      ‚úÖ Escolher Esta
                    </button>
                  </div>
                </div>
              </div>
            `;
          }
          else if (order.status === "production") {
  hasReceived = true;

  receivedContainer.innerHTML += `
    <div class="card">
      <div class="card-header">
        <h3>${title}</h3>
        <span class="status-badge status-production">Em Produ√ß√£o</span>
      </div>
      <p style="color:#cbd5e1;">Estamos gerando seu √°udio. Isso pode levar alguns minutos.</p>
      <div class="action-row">
        <button class="btn btn-revise" onclick="openLyricsModal(\`${lyrics.replaceAll("`","\\`")}\`)">üìÑ Ver letra</button>
      </div>
    </div>
  `;
}
else if (order.status === "completed") {
  hasReceived = true;
  const urls = Array.isArray(order.audio_urls) ? order.audio_urls : [];

  receivedContainer.innerHTML += `
    <div class="card">
      <div class="card-header">
        <h3>${title}</h3>
        <span class="status-badge status-completed">Pronta</span>
      </div>

      <div class="action-row" style="margin-bottom:12px;">
  <button class="btn btn-revise" onclick="openLyricsModal(\`${lyrics.replaceAll("`","\\`")}\`)">üìÑ Letra</button>
</div>

${
  urls.length >= 2
    ? `
      <div style="margin-top:6px;">
        <div class="tc-player" data-audio="${urls[0].audio_url || urls[0]}" data-title="${title || 'Minha m√∫sica'} - Vers√£o A">
  <button class="tc-btn play" type="button" aria-label="Play/Pause">‚ñ∂</button>

  <div class="tc-main">
    <div class="tc-top">
      <div class="tc-title">üéß Vers√£o A</div>
      <div class="tc-time"><span class="cur">0:00</span> / <span class="dur">0:00</span></div>
    </div>

    <div class="tc-bar" role="slider" aria-label="Progresso">
      <div class="tc-progress"></div>
      <div class="tc-dot"></div>
    </div>
  </div>

  <div class="tc-actions">
    <input class="tc-vol" type="range" min="0" max="1" step="0.01" value="0.9" aria-label="Volume">

    <!-- ‚úÖ DOWNLOAD FOR√áADO (n√£o abre outra aba) -->
    <button class="tc-mini" type="button"
      onclick="downloadAudio('${urls[0].audio_url || urls[0]}', '${title || "musica"}-versao-a')"
      title="Baixar">‚¨á</button>

    <!-- ‚úÖ COMPARTILHAR (nativo; fallback WhatsApp) -->
    <button class="tc-mini" type="button"
      onclick="shareNative('${urls[0].audio_url || urls[0]}', '${title || "Minha m√∫sica"} - Vers√£o A')"
      title="Compartilhar">üì§</button>
  </div>

  <audio preload="metadata" style="display:none;"></audio>
</div>

<div style="height:10px;"></div>

<div class="tc-player" data-audio="${urls[1].audio_url || urls[1]}" data-title="${title || 'Minha m√∫sica'} - Vers√£o B">
  <button class="tc-btn play" type="button" aria-label="Play/Pause">‚ñ∂</button>

  <div class="tc-main">
    <div class="tc-top">
      <div class="tc-title">üéß Vers√£o B</div>
      <div class="tc-time"><span class="cur">0:00</span> / <span class="dur">0:00</span></div>
    </div>

    <div class="tc-bar" role="slider" aria-label="Progresso">
      <div class="tc-progress"></div>
      <div class="tc-dot"></div>
    </div>
  </div>

  <div class="tc-actions">
    <input class="tc-vol" type="range" min="0" max="1" step="0.01" value="0.9" aria-label="Volume">

    <!-- ‚úÖ DOWNLOAD FOR√áADO -->
    <button class="tc-mini" type="button"
      onclick="downloadAudio('${urls[1].audio_url || urls[1]}', '${title || "musica"}-versao-b')"
      title="Baixar">‚¨á</button>

    <!-- ‚úÖ COMPARTILHAR -->
    <button class="tc-mini" type="button"
      onclick="shareNative('${urls[1].audio_url || urls[1]}', '${title || "Minha m√∫sica"} - Vers√£o B')"
      title="Compartilhar">üì§</button>
  </div>

  <audio preload="metadata" style="display:none;"></audio>
</div>
      </div>
    `
    : urls.length === 1
    ? `
      <div style="margin-top:6px;">
        <div class="tc-player" data-audio="${urls[0].audio_url || urls[0]}">
          <button class="tc-btn play" type="button" aria-label="Play/Pause">‚ñ∂</button>

          <div class="tc-main">
            <div class="tc-top">
              <div class="tc-title">üéß √Åudio</div>
              <div class="tc-time"><span class="cur">0:00</span> / <span class="dur">0:00</span></div>
            </div>

            <div class="tc-bar" role="slider" aria-label="Progresso">
              <div class="tc-progress"></div>
              <div class="tc-dot"></div>
            </div>
          </div>

          <div class="tc-actions">
            <input class="tc-vol" type="range" min="0" max="1" step="0.01" value="0.9" aria-label="Volume">
            <a class="tc-mini" href="${urls[0].audio_url || urls[0]}" download title="Baixar">‚¨á</a>
          </div>

          <audio preload="metadata" style="display:none;"></audio>
        </div>

        <div style="height:10px;"></div>

        <!-- mant√©m tamb√©m o bot√£o de download ‚Äúgrande‚Äù, se voc√™ quiser -->
        <a class="btn btn-download" href="${urls[0].audio_url || urls[0]}" download>‚¨áÔ∏è Baixar</a>
      </div>
    `
    : `<p>Sua m√∫sica foi finalizada e est√° sendo preparada para audi√ß√£o.</p>`
}

  `;
}

         
        });
      }

      if (!hasDrafts) {
  draftsContainer.innerHTML = `
    <div class="tc-empty">
      <div class="tc-empty-card">
        <div class="tc-empty-logo">
          <img src="./images/diamante.png" alt="TuneCraft">
        </div>

        <div class="tc-empty-title">Toda m√∫sica come√ßa com uma hist√≥ria</div>
        <div class="tc-empty-sub">Crie sua pr√≥xima agora ‚Äî a gente transforma em can√ß√£o.</div>

        <button class="tc-empty-cta" onclick="openChat()">
          üéµ Criar Nova M√∫sica
        </button>

        <div class="tc-empty-hint">Dica: quanto mais detalhes, mais √∫nica fica a letra.</div>
      </div>
    </div>
  `;
}


      if (!hasPending) {
  pendingContainer.innerHTML = `
    <div class="tc-empty">
      <div class="tc-empty-card">
        <div class="tc-empty-logo">
          <img src="./images/diamante.png" alt="TuneCraft">
        </div>

        <div class="tc-empty-title">Tudo em dia ‚ú®</div>
        <div class="tc-empty-sub">Sem letras pendentes no momento. Quer criar outra m√∫sica?</div>

        <button class="tc-empty-cta" onclick="openChat()">
          ‚ûï Criar Nova M√∫sica
        </button>
      </div>
    </div>
  `;
}


     

      if (!hasReceived) {
        receivedContainer.innerHTML = `
          <div class="empty-state" style="padding:20px;">
            <p>Sem m√∫sicas prontas no momento.</p>
          </div>
        `;
      }
    }

    // ‚úÖ ALTERA√á√ÉO 4: FUN√á√ÉO EDITARDRAFT MODIFICADA
    function editarDraft(pedidoId) {
      console.log("üìù Abrindo editor para:", pedidoId);

      // ‚úÖ Abre o modal
      openEditDraftModal(pedidoId);
    }

    async function irParaCheckout(pedidoId) {
      try {
        localStorage.setItem('tuneCraft_pendingOrderId', pedidoId);
        localStorage.setItem('tuneCraft_checkoutEmail', userData.email);
        localStorage.setItem('tuneCraft_checkoutName', userData.name);


        console.log("üí≥ Redirecionando para checkout:", pedidoId);
        showToast("Redirecionando para checkout...", "info");


        setTimeout(() => {
          window.location.href = 'checkout.html';
        }, 500);


      } catch (error) {
        console.error("Erro ao redirecionar:", error);
        showToast(`‚ùå Erro: ${error.message}`, "error");
      }
    }

    function abrirModalAlteracao(pedidoId) {
      currentAlterandoId = pedidoId;
      document.getElementById('alterarModal').classList.add('active');

      document.getElementById('mudancasDesejadas').value = '';
      document.getElementById('manterElementos').value = '';
      document.getElementById('observacoesFinais').value = '';
      document.getElementById('count1').innerText = '0';
      document.getElementById('count2').innerText = '0';
      document.getElementById('count3').innerText = '0';
    }

    function fecharAlterarModal() {
      document.getElementById('alterarModal').classList.remove('active');
      currentAlterandoId = null;
    }

    function updateAlterarCharCount(fieldId, countId) {
      const field = document.getElementById(fieldId);
      const count = field.value.length;
      document.getElementById(countId).innerText = count;
    }

    async function submitAlteracao() {
      const mudancas = document.getElementById('mudancasDesejadas').value.trim();
      const manter = document.getElementById('manterElementos').value.trim();
      const obs = document.getElementById('observacoesFinais').value.trim();

      if (mudancas.length < 20) {
        showToast("Por favor, descreva as mudan√ßas com pelo menos 20 caracteres", "error");
        return;
      }

      if (manter.length < 10) {
        showToast("Por favor, especifique o que deve ser mantido (m√≠nimo 10 caracteres)", "error");
        return;
      }

      const btn = document.getElementById('btnSubmitAlteracao');
      btn.disabled = true;
      btn.innerText = "Processando...";

      const sugestoes = `
MUDAN√áAS DESEJADAS:
${mudancas}

ELEMENTOS QUE DEVEM PERMANECER:
${manter}

${obs ? `OBSERVA√á√ïES ADICIONAIS:\n${obs}` : ''}
      `.trim();

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/alterar-letra`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            pedidoId: currentAlterandoId,
            sugestoes: sugestoes
          })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Erro ao processar altera√ß√µes');
        }

        showToast("‚úÖ Vers√£o modificada criada! Compare as vers√µes.", "");
        fecharAlterarModal();

        userData.orders = await loadOrdersFromSupabase();
        localStorage.setItem("tuneCraftUser", JSON.stringify(userData));
        renderSections();

      } catch (error) {
        showToast(`‚ùå Erro: ${error.message}`, "error");
        btn.disabled = false;
        btn.innerText = "Enviar Altera√ß√µes ‚ú®";
      }
    }

   async function aprovarLetraOriginal(pedidoId) {
  try {
    console.log("‚úÖ Aprovando letra original e gerando √°udio para:", pedidoId);

    if (!pedidoId) {
      showToast("‚ùå Erro: ID do pedido n√£o encontrado", "error");
      return;
    }

    // ============================================
    // PASSO 1: Atualizar versao_escolhida no banco
    // ============================================

    console.log("üìù PASSO 1: Marcando vers√£o como escolhida...");

    const { error: updateErr } = await sb
      .from("musicas_pedidos")
      .update({
        versao_escolhida: "original",
        versao_aprovada_tipo: "original",
      })
      .eq("id", pedidoId);

    if (updateErr) {
      console.error("‚ùå Erro ao marcar vers√£o:", updateErr);
      showToast(`‚ùå Erro ao salvar: ${updateErr.message}`, "error");
      return;
    }

    console.log("‚úÖ Vers√£o marcada como original");

    // ============================================
    // PASSO 2: Gerar √°udio chamando generate-audio
    // ============================================

    console.log("üéµ PASSO 2: Chamando generate-audio...");

    const btn = document.getElementById(`btn-${pedidoId}`);
    if (btn) {
      btn.disabled = true;
      btn.textContent = "‚è≥ Gerando √°udio...";
    }

    showToast("üéµ Gerando √°udio da m√∫sica...", "info");

    // ‚úÖ CERTIFIQUE-SE DE CHAMAR COM JSON V√ÅLIDO
    const response = await fetch(
      "https://miupzfchvfbqbznfhvix.supabase.co/functions/v1/generate-audio",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          pedido_id: pedidoId,  // ‚úÖ KEY CORRETO!
        }),
      }
    );

    console.log("üì§ Status da resposta:", response.status);

    // ============================================
    // VERIFICAR RESPOSTA
    // ============================================

    if (!response.ok) {
      const errorText = await response.text().catch(() => "Erro desconhecido");
      console.error("‚ùå Erro de resposta:", response.status, errorText);
      showToast(`‚ùå Erro ao gerar √°udio: ${response.status}`, "error");

      if (btn) {
        btn.disabled = false;
        btn.textContent = "‚úÖ Aprovar e Gerar √Åudio";
      }
      return;
    }

    const result = await response.json().catch(() => ({}));
    console.log("‚úÖ Resposta da gera√ß√£o:", result);

    // ============================================
    // SUCESSO
    // ============================================

    showToast("‚úÖ √Åudio enviado para produ√ß√£o! Voc√™ receber√° em breve.", "success");

    setTimeout(() => {
      location.reload();
    }, 2000);

  } catch (error) {
    console.error("‚ùå ERRO em aprovarLetraOriginal:", error);
    showToast(`‚ùå ${error.message}`, "error");

    const btn = document.getElementById(`btn-${pedidoId}`);
    if (btn) {
      btn.disabled = false;
      btn.textContent = "‚úÖ Aprovar e Gerar √Åudio";
    }
  }
}
   async function aprovarVersao(pedidoId, tipo) {
  try {
    console.log(`‚úÖ Aprovando vers√£o ${tipo} para:`, pedidoId);

    if (!pedidoId || !tipo) {
      showToast("‚ùå Erro: Dados inv√°lidos", "error");
      return;
    }

    const tipoNormalizado = tipo.toLowerCase();
    if (!["original", "modificada"].includes(tipoNormalizado)) {
      showToast("‚ùå Erro: Tipo de vers√£o inv√°lido", "error");
      return;
    }

    // ============================================
    // PASSO 1: Atualizar versao_escolhida
    // ============================================

    console.log("üìù PASSO 1: Marcando vers√£o escolhida...");

    const { error: updateErr } = await sb
      .from("musicas_pedidos")
      .update({
        versao_escolhida: tipoNormalizado,
        versao_aprovada_tipo: tipoNormalizado,
        status: "production",
      })
      .eq("id", pedidoId);

    if (updateErr) {
      console.error("‚ùå Erro ao marcar vers√£o:", updateErr);
      showToast(`‚ùå Erro ao salvar: ${updateErr.message}`, "error");
      return;
    }

    console.log("‚úÖ Vers√£o marcada como aprovada");

    // ============================================
    // PASSO 2: Gerar √°udio
    // ============================================

    console.log("üéµ PASSO 2: Gerando √°udio...");

    showToast("üéµ Gerando √°udio da m√∫sica...", "info");

    const response = await fetch(
      "https://miupzfchvfbqbznfhvix.supabase.co/functions/v1/generate-audio",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          pedido_id: pedidoId,
        }),
      }
    );

    console.log("üì§ Status:", response.status);

    if (!response.ok) {
      const errorText = await response.text().catch(() => "Erro desconhecido");
      console.error("‚ùå Erro:", response.status, errorText);
      showToast(`‚ùå Erro ao gerar √°udio: ${response.status}`, "error");
      return;
    }

    const result = await response.json().catch(() => ({}));
    console.log("‚úÖ √Åudio enviado:", result);

    showToast("‚úÖ M√∫sica em produ√ß√£o! Voc√™ receber√° em breve.", "success");

    setTimeout(() => {
      location.reload();
    }, 2000);

  } catch (error) {
    console.error("‚ùå ERRO em aprovarVersao:", error);
    showToast(`‚ùå ${error.message}`, "error");
  }
}

// ============================================
// VERIFICA√á√ÉO AO CARREGAR
// ============================================

document.addEventListener("DOMContentLoaded", function() {
  console.log("‚úÖ Fun√ß√µes de aprova√ß√£o carregadas");
  console.log("üìç URL generate-audio configurada como:");
  console.log("   https://miupzfchvfbqbznfhvix.supabase.co/functions/v1/generate-audio");
});

    function saveProfile() {
      const newName = document.getElementById("profName").value;
      const newPass = document.getElementById("profPass").value;

      userData.name = newName;
      if (newPass) userData.password = newPass;

      localStorage.setItem("tuneCraftUser", JSON.stringify(userData));

      document.getElementById("userName").innerText = newName.split(" ")[0];
      document.querySelector(".avatar").innerText = newName.charAt(0);

      showToast("‚úÖ Perfil atualizado com sucesso!", "");
    }

    async function logout() {
      try {
        await sb.auth.signOut();
      } catch (e) {
        console.error("Erro ao deslogar:", e);
      }

      localStorage.removeItem("tuneCraftUser");
      window.location.href = "login.html";
    }
  </script>

  <!-- ‚úÖ ALTERA√á√ÉO 3: JAVASCRIPT DO MODAL DE EDI√á√ÉO -->
  <script>
    function showEditDraftToast(message, type = 'info') {
      const toast = document.getElementById('editDraftToast');
      toast.innerText = message;
      toast.className = `edit-draft-toast ${type}`;
      toast.style.display = 'block';
      
      setTimeout(() => {
        toast.style.display = 'none';
      }, 4000);
    }

    // ============================================
// FUN√á√ÉO: Converter asked[] ‚Üí campos edit√°veis
// ============================================

function convertAskedToEditFormat(asked) {
    /**
     * Transforma o array asked[] em objeto com step0, step1, step2...
     * Para compatibilidade com o formul√°rio de edi√ß√£o
     */
    
    const result = {};
    
    if (!asked || !Array.isArray(asked)) {
        return result;
    }

    asked.forEach((item, index) => {
        // Cada item tem:
        // - fieldName: "recipient.name"
        // - answerValue: "Maria"
        
        // Para manter compatibilidade com step0, step1, step2...
        // Precisamos mapear o fieldName de volta para stepX
        
        const fieldName = item.fieldName; // ex: "recipient.name"
        const answerValue = item.answerValue;
        
        // Mapeamento: tema ‚Üí step0, recipient.name ‚Üí step2, etc
        const fieldToStepMap = {
            "ai_metadata.themeId": "step0",
            
            // Birthday
            "recipient.name": "step2",
            "ai_metadata.relationship": "step1",
            "lyricDetails.mainMessage": "step4",
            "ai_metadata.pov": "step3",
            "lyricDetails.specialMentions": "step5",
            "recipient.personality": "step6",
            "lyricDetails.secretDetail": "step7",
            "recipient.specialCharacteristics": "step8",
            "final.futureWish": "step9",
            "musicStyle.primaryGenre": "step10",
            "musicStyle.mood": "step11",
            "musicStyle.tempo": "step12",
            "lyricDetails.language": "step13",
            "productionDetails.vocalApproach": "step14",
            
            // Pregnancy announcement
            "ai_metadata.audience": "step1",
            "ai_metadata.narratorRole": "step2",
            "ai_metadata.pregnancyStage": "step3",
            "lyricDetails.scene": "step5",
            "lyricDetails.desiredImpact": "step6",
            "lyricDetails.symbolicDetail": "step7",
            "lyricDetails.announcementLine": "step8",
            "lyricDetails.avoid": "step9",
            
            // Love declaration
            "lyricDetails.origin": "step1",
            "lyricDetails.turningPoint": "step2",
            "lyricDetails.transformation": "step3",
            "lyricDetails.unsaid": "step4",
            "lyricDetails.simpleScene": "step5",
            "lyricDetails.withYouI": "step7",
        };
        
        const stepKey = fieldToStepMap[fieldName];
        
        if (stepKey) {
            result[stepKey] = answerValue;
        }
        
        // Adicionar tamb√©m por √≠ndice original (seguran√ßa)
        result[`asked_${index}`] = {
            fieldName: fieldName,
            value: answerValue,
            question: item.question
        };
    });
    
    return result;
}
    
    async function openEditDraftModal(pedidoId) {
      editDraftCurrentPedidoId = pedidoId;
      const modal = document.getElementById('editDraftModal');
      modal.classList.add('active');
      
      await loadEditDraft(pedidoId);
    }

    function closeEditDraftModal() {
      const modal = document.getElementById('editDraftModal');
      modal.classList.remove('active');
      editDraftCurrentPedidoId = null;
    }

   async function loadEditDraft(pedidoId) {
    const loading = document.getElementById("editDraftLoading");
    const form = document.getElementById("editDraftForm");
    
    loading.style.display = "flex";
    form.style.display = "none";
    
    try {
        console.log("üì• Carregando draft:", pedidoId);
        
        const { data, error } = await sb
            .from("musicas_pedidos")
            .select()
            .eq("id", pedidoId)
            .single();
        
        if (error) throw error;
        
        const payload = data.payload;
        console.log("üìä Payload completo:", payload);
        console.log("üìã Array asked[]:", payload.asked);
        console.log("üíæ Objeto answers{}:", payload.answers);
        
        document.getElementById("editDraftHeaderInfo").innerText = 
            `Criado em ${new Date(data.created_at).toLocaleDateString("pt-BR")}`;
        
        const asked = payload.asked || [];
        const answers = payload.answers || {};
        
        if (!asked || asked.length === 0) {
            throw new Error("Nenhuma resposta encontrada neste rascunho");
        }
        
        // ============================================
        // RENDERIZAR DIN√ÇMICAMENTE A PARTIR DE asked[]
        // ============================================
        
        let formHTML = "";
        let currentSection = null;
        
        asked.forEach((item, index) => {
            // Agrupar por se√ß√£o
            if (item.section !== currentSection) {
                currentSection = item.section;
                formHTML += `<div class="edit-draft-section-title">${currentSection}</div>`;
            }
            
            // Gerar ID √∫nico para o campo
            const fieldId = `edit_${item.fieldName.replace(/\./g, "_")}`;
            const fieldValue = item.answerValue || "";
            const labelText = item.question || item.fieldName;
            
            // Renderizar de acordo com o tipo
            formHTML += `
                <div class="edit-draft-form-group">
                    <label>${labelText}</label>
                    <div class="field-name">${item.fieldName}</div>
            `;
            
            // ‚úÖ Se √© um select com op√ß√µes (dedu conforme answerValue)
            if (item.answerValue && 
                (item.fieldName.includes("themeId") || 
                 item.fieldName.includes("mood") || 
                 item.fieldName.includes("tempo") ||
                 item.fieldName.includes("genre") ||
                 item.fieldName.includes("audience") ||
                 item.fieldName.includes("narratorRole") ||
                 item.fieldName.includes("pregnancyStage") ||
                 item.fieldName.includes("language") ||
                 item.fieldName.includes("vocalApproach") ||
                 item.fieldName.includes("pov"))) {
                
                formHTML += renderSelectField(fieldId, item.fieldName, fieldValue);
            }
            // ‚úÖ Se √© textarea (longo)
            else if (item.answerValue && item.answerValue.length > 50) {
                formHTML += `
                    <textarea id="${fieldId}" rows="3">${escapeHtml(fieldValue)}</textarea>
                `;
            }
            // ‚úÖ Default: input text
            else {
                formHTML += `
                    <input type="text" id="${fieldId}" value="${escapeHtml(fieldValue)}" />
                `;
            }
            
            formHTML += `</div>`;
        });
        
        // BOT√ïES
        formHTML += `
            <div class="edit-draft-actions">
                <button type="button" class="edit-draft-btn edit-draft-btn-cancel" onclick="closeEditDraftModal()">Cancelar</button>
                <button type="button" class="edit-draft-btn edit-draft-btn-save" onclick="saveEditDraftDynamic()">Salvar Altera√ß√µes</button>
            </div>
        `;
        
        form.innerHTML = formHTML;
        
        // Guardar dados originais para facilitar salvamento
        window.editDraftData = {
            pedidoId: pedidoId,
            asked: asked,
            answers: answers
        };
        
        loading.style.display = "none";
        form.style.display = "block";
        
    } catch (error) {
        console.error("‚ùå Erro ao carregar rascunho:", error);
        showEditDraftToast(`Erro: ${error.message}`, "error");
        closeEditDraftModal();
    }
}

    // ============================================
// HELPER: Renderizar select fields dinamicamente
// ============================================

function renderSelectField(fieldId, fieldName, currentValue) {
    const options = getOptionsForField(fieldName, currentValue);
    
    let html = `<select id="${fieldId}">`;
    options.forEach(opt => {
        const selected = currentValue === opt.value ? "selected" : "";
        html += `<option value="${opt.value}" ${selected}>${opt.label}</option>`;
    });
    html += `</select>`;
    
    return html;
}

// ============================================
// HELPER: Retornar op√ß√µes de cada campo
// ============================================

function getOptionsForField(fieldName, currentValue) {
    if (fieldName.includes("themeId")) return FORM_OPTIONS.themes;
    if (fieldName.includes("mood")) return FORM_OPTIONS.moods;
    if (fieldName.includes("tempo")) return FORM_OPTIONS.tempos;
    if (fieldName.includes("genre") || fieldName.includes("Genre")) return FORM_OPTIONS.genres;
    if (fieldName.includes("audience")) return FORM_OPTIONS.audiences;
    if (fieldName.includes("narratorRole")) return FORM_OPTIONS.narratorRoles;
    if (fieldName.includes("pregnancyStage")) return FORM_OPTIONS.pregnancyStages;
    if (fieldName.includes("language")) return FORM_OPTIONS.languages;
    if (fieldName.includes("vocalApproach")) return FORM_OPTIONS.vocalApproaches;
    if (fieldName.includes("pov")) return FORM_OPTIONS.povs;
    if (fieldName.includes("ageGroup")) return FORM_OPTIONS.ageGroups;
    
    return [];
}

// ============================================
// HELPER: Escape HTML
// ============================================

function escapeHtml(str) {
    if (!str) return "";
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

    async function saveEditDraftDynamic() {
    if (!editDraftCurrentPedidoId || !window.editDraftData) return;
    
    const btn = document.querySelector(".edit-draft-btn-save");
    btn.disabled = true;
    btn.innerText = "Salvando...";
    
    try {
        console.log("üíæ Salvando draft:", editDraftCurrentPedidoId);
        
        const originalAsked = window.editDraftData.asked;
        const updatedAnswers = {};
        
        // Iterar sobre CADA item respondido originalmente
        originalAsked.forEach((item) => {
            const fieldId = `edit_${item.fieldName.replace(/\./g, "_")}`;
            const inputElement = document.getElementById(fieldId);
            
            if (inputElement) {
                const newValue = inputElement.value || inputElement.textContent;
                
                // Organizar em estrutura de answers{}
                const parts = item.fieldName.split(".");
                if (parts.length === 2) {
                    const [parent, child] = parts;
                    if (!updatedAnswers[parent]) {
                        updatedAnswers[parent] = {};
                    }
                    updatedAnswers[parent][child] = newValue;
                } else {
                    updatedAnswers[item.fieldName] = newValue;
                }
                
                console.log(`‚úèÔ∏è ${item.fieldName} ‚Üí ${newValue}`);
            }
        });
        
        console.log("üìä Answers atualizado:", updatedAnswers);
        
        // Salvar no Supabase
        const { error } = await sb
            .from("musicas_pedidos")
            .update({
                payload: {
                    form_id: "tc_chat_v2",
                    form_version: 2,
                    asked: originalAsked,  // Manter o asked original
                    answers: updatedAnswers,  // Atualizar answers
                    updated_at: new Date().toISOString()
                }
            })
            .eq("id", editDraftCurrentPedidoId);
        
        if (error) throw error;
        
        console.log("‚úÖ Draft salvo!");
        showEditDraftToast("Rascunho atualizado com sucesso!", "success");
        closeEditDraftModal();
        
        // Recarregar dados
        userData.orders = await loadOrdersFromSupabase();
        localStorage.setItem("tuneCraftUser", JSON.stringify(userData));
        renderSections();
        
    } catch (error) {
        console.error("‚ùå Erro ao salvar:", error);
        showEditDraftToast(`Erro: ${error.message}`, "error");
        btn.disabled = false;
        btn.innerText = "Salvar Altera√ß√µes";
    }
}
    
   
    // ============================================
// NOVA FUN√á√ÉO: saveEditDraftNew() - Salvar formato correto
// ============================================

async function saveEditDraftNew() {
    if (!editDraftCurrentPedidoId) return;
    
    const btn = document.querySelector(".edit-draft-btn-save");
    btn.disabled = true;
    btn.innerText = "Salvando...";
    
    try {
        console.log("üíæ Salvando draft:", editDraftCurrentPedidoId);
        
        // Coletar dados do formul√°rio
        const updatedAnswers = {
            ai_metadata: {
                themeId: document.getElementById("editStep0")?.value
            },
            recipient: {
                name: document.getElementById("editRecipientName")?.value
            },
            ai_metadata: {
                ...document.getElementById("editStep0") ? {themeId: document.getElementById("editStep0").value} : {},
                relationship: document.getElementById("editRelationship")?.value
            },
            lyricDetails: {
                mainMessage: document.getElementById("editMainMessage")?.value,
                scene: document.getElementById("editScene")?.value,
                secretDetail: document.getElementById("editSecretDetail")?.value
            },
            musicStyle: {
                primaryGenre: document.getElementById("editGenre")?.value,
                mood: document.getElementById("editMood")?.value,
                tempo: document.getElementById("editTempo")?.value
            }
        };
        
        // Remover campos undefined/vazios
        const cleanPayload = {};
        Object.keys(updatedAnswers).forEach(key => {
            if (updatedAnswers[key] && Object.keys(updatedAnswers[key]).length > 0) {
                cleanPayload[key] = updatedAnswers[key];
            }
        });
        
        console.log("üìä Payload atualizado:", cleanPayload);
        
        // Atualizar no Supabase
        const { error } = await sb
            .from("musicas_pedidos")
            .update({
                payload: cleanPayload
            })
            .eq("id", editDraftCurrentPedidoId);
        
        if (error) throw error;
        
        console.log("‚úÖ Draft salvo!");
        showEditDraftToast("Rascunho atualizado com sucesso!", "success");
        closeEditDraftModal();
        
        // Recarregar dados
        userData.orders = await loadOrdersFromSupabase();
        localStorage.setItem("tuneCraftUser", JSON.stringify(userData));
        renderSections();
        
    } catch (error) {
        console.error("‚ùå Erro ao salvar:", error);
        showEditDraftToast(`Erro: ${error.message}`, "error");
        btn.disabled = false;
        btn.innerText = "Salvar Alteraes";
    }
}

  </script>

<div class="alterar-modal" id="lyricsModal">
  <div class="alterar-content">
    <div class="alterar-header">
      <h2>üìÑ Letra</h2>
      <button class="alterar-close" onclick="closeLyricsModal()">√ó</button>
    </div>

    <textarea id="lyricsModalText" readonly style="width:100%; min-height: 320px;"></textarea>

    <div class="alterar-buttons" style="margin-top:14px;">
      <button class="btn-alterar-cancel" onclick="closeLyricsModal()">Fechar</button>
      <button class="btn-alterar-submit" onclick="copyLyrics()">Copiar letra</button>
    </div>
  </div>
</div>

<script>
  function tcFormatTime(sec){
    if (!isFinite(sec) || sec < 0) sec = 0;
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    return `${m}:${String(s).padStart(2,'0')}`;
  }

  function tcInitPlayers(){
    const players = document.querySelectorAll('.tc-player');
    players.forEach((wrap) => {
      const src = wrap.getAttribute('data-audio');
      const audio = wrap.querySelector('audio');
      const btn = wrap.querySelector('.tc-btn.play');
      const bar = wrap.querySelector('.tc-bar');
      const prog = wrap.querySelector('.tc-progress');
      const dot = wrap.querySelector('.tc-dot');
      const curEl = wrap.querySelector('.cur');
      const durEl = wrap.querySelector('.dur');
      const vol = wrap.querySelector('.tc-vol');

      if (!src || !audio || !btn || !bar) return;

      audio.src = src;
      audio.volume = vol ? Number(vol.value || 0.9) : 0.9;

      function setUI(){
        const dur = audio.duration || 0;
        const cur = audio.currentTime || 0;
        const pct = dur ? (cur / dur) * 100 : 0;
        prog.style.width = `${pct}%`;
        dot.style.left = `${pct}%`;
        if (curEl) curEl.textContent = tcFormatTime(cur);
        if (durEl) durEl.textContent = tcFormatTime(dur);
      }

      function setBtn(){
        btn.textContent = audio.paused ? '‚ñ∂' : '‚è∏';
      }

      // play/pause
      btn.addEventListener('click', () => {
        // pausa os outros players
        document.querySelectorAll('.tc-player audio').forEach(a => {
          if (a !== audio) a.pause();
        });
        if (audio.paused) audio.play();
        else audio.pause();
      });

      audio.addEventListener('play', setBtn);
      audio.addEventListener('pause', setBtn);
      audio.addEventListener('timeupdate', setUI);
      audio.addEventListener('loadedmetadata', setUI);
      audio.addEventListener('ended', () => { audio.currentTime = 0; audio.pause(); setUI(); });

      // seek
      bar.addEventListener('click', (e) => {
        const rect = bar.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const pct = Math.max(0, Math.min(1, x / rect.width));
        if (audio.duration) audio.currentTime = pct * audio.duration;
        setUI();
      });

      // volume
      if (vol){
        vol.addEventListener('input', () => {
          audio.volume = Number(vol.value);
        });
      }

      // init
      setBtn();
      setUI();
    });
  }

  // Re-init quando voc√™ re-renderiza os cards
  const _origRenderSections = window.renderSections;
  if (typeof _origRenderSections === 'function'){
    window.renderSections = function(){
      _origRenderSections();
      tcInitPlayers();
    }
  } else {
    document.addEventListener('DOMContentLoaded', tcInitPlayers);
  }

     function safeFilename(name) {
    return (name || "musica")
      .toString()
      .trim()
      .toLowerCase()
      .replace(/[^\w\-]+/g, "-")
      .replace(/\-+/g, "-")
      .replace(/^\-|\-$/g, "");
  }

  async function downloadAudio(url, baseName = "musica") {
    try {
      if (!url) return;

      const filename = `${safeFilename(baseName)}.mp3`;

      // tenta baixar como blob (for√ßa download)
      const res = await fetch(url, { mode: "cors" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const blob = await res.blob();
      const blobUrl = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = blobUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(blobUrl);

      if (typeof showToast === "function") showToast("‚úÖ Download iniciado", "success");
    } catch (err) {
      console.warn("downloadAudio falhou:", err);

      // fallback: abre em nova aba
      window.open(url, "_blank", "noopener,noreferrer");
      if (typeof showToast === "function") showToast("‚ö†Ô∏è N√£o foi poss√≠vel for√ßar download aqui", "info");
    }
  }

    function shareWhatsApp(audioUrl, title = "Minha m√∫sica") {
    if (!audioUrl) return;
    const msg = `üéµ ${title}\nOu√ßa aqui: ${audioUrl}`;
    const waUrl = `https://wa.me/?text=${encodeURIComponent(msg)}`;
    window.open(waUrl, "_blank", "noopener,noreferrer");
  }

  async function shareNative(audioUrl, title = "Minha m√∫sica") {
    try {
      if (!audioUrl) return;

      if (!navigator.share) {
        return shareWhatsApp(audioUrl, title);
      }

      await navigator.share({
        title,
        text: `üéµ ${title}\nOu√ßa aqui: ${audioUrl}`,
        url: audioUrl
      });
    } catch (e) {
      // usu√°rio cancelou ou falhou ‚Äî fallback opcional
      // shareWhatsApp(audioUrl, title);
    }
  }
</script>


</body>
</html>
