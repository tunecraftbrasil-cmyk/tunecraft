<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Cliente | TuneCraft</title>
  <link rel="stylesheet" href="chat.css" />

  <!-- Supabase JS (apenas UMA vez) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="dark-theme-mobile-menu.css">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f1f5f9; color: #1e293b;
      display: flex; height: 100vh; overflow: hidden;
    }

    /* SIDEBAR */
    .sidebar {
      width: 260px; background: #0a0e27; color: white;
      display: flex; flex-direction: column;
      padding: 20px; flex-shrink: 0;
      overflow: hidden;
    }

    .logo-container {
      margin-bottom: 40px;
      display: flex;
      align-items: center;
      gap: 10px;
      min-height: 50px;
    }

    .menu-item {
      padding: 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer;
      transition: 0.3s; display: flex; align-items: center; gap: 10px; color: #94a3b8;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: white; }
    .menu-item.active { border-left: 3px solid #00d9ff; }

    .new-music-btn {
      margin-top: auto; background: linear-gradient(135deg, #00d9ff, #6366f1);
      color: white; padding: 15px; border-radius: 10px; text-align: center;
      text-decoration: none; font-weight: 700; transition: 0.3s;
      display: flex; justify-content: center; align-items: center; gap: 8px; cursor: pointer;
      border: none;
    }
    .new-music-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 217, 255, 0.3); }

    /* MAIN CONTENT */
    .main-content { flex: 1; overflow-y: auto; padding: 30px; position: relative; min-width: 0; }

    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; gap: 12px; flex-wrap: wrap; }
    .user-profile { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .avatar { width: 40px; height: 40px; background: #e2e8f0; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #64748b; flex: 0 0 auto; }

    .section { display: none; animation: fadeIn 0.3s; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* CARDS */
    .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; }
    .card-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; gap: 10px; flex-wrap: wrap; }
    .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }

    .status-pending { background: #fff7ed; color: #c2410c; }
    .status-production { background: #eff6ff; color: #1d4ed8; }
    .status-completed { background: #f0fdf4; color: #15803d; }
    .status-awaiting { background: #fef3c7; color: #92400e; }
    .status-draft { background: #fce7f3; color: #be185d; }

    .draft-summary {
      background: #f8fafc;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid #be185d;
    }

    .draft-summary p {
      margin: 8px 0;
      font-size: 0.95rem;
      color: #475569;
      word-break: break-word;
    }

    .draft-summary p strong {
      color: #1e293b;
    }

    .lyrics-box {
      font-family: 'Courier New', monospace; background: #f8fafc; padding: 20px;
      border-radius: 8px; border: 1px solid #cbd5e1; white-space: pre-wrap; margin: 15px 0; max-height: 300px; overflow-y: auto;
      word-break: break-word;
    }

    /* ✅ COMPARAÇÃO LADO A LADO */
    .comparison-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
      min-width: 0;
    }

    .version-card {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      background: #f8fafc;
      min-width: 0;
    }

    .version-card.selected {
      border-color: #00d9ff;
      background: #eff6ff;
    }

    .version-card h4 {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .version-changelog {
      background: #fff7ed;
      border-left: 3px solid #f59e0b;
      padding: 10px;
      margin: 10px 0;
      font-size: 0.9rem;
      border-radius: 4px;
      word-break: break-word;
    }

    .action-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
    .btn-approve { background: #10b981; color: white; }
    .btn-approve:hover { background: #059669; }
    .btn-approve:disabled { background: #cbd5e1; cursor: not-allowed; }
    .btn-revise { background: white; border: 2px solid #f59e0b; color: #f59e0b; }
    .btn-revise:hover { background: #fef3c7; }
    .btn-revise:disabled { background: #f3f4f6; color: #9ca3af; border-color: #d1d5db; cursor: not-allowed; }
    .btn-download { background: #0f172a; color: white; display: inline-flex; align-items: center; gap: 5px; text-decoration: none; padding: 10px 14px; border-radius: 6px; }
    .btn-select { background: #00d9ff; color: white; width: 100%; margin-top: 10px; }

    /* PROFILE SECTION STYLES */
    .profile-form label { display: block; margin-top: 15px; font-weight: 600; font-size: 0.9rem; }
    .profile-form input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; margin-top: 5px; max-width: 400px; }
    .btn-save-profile { margin-top: 20px; background: #00d9ff; color: white; border:none; padding: 10px 25px; border-radius: 6px; cursor: pointer; font-weight: bold; }

    .empty-state { text-align: center; padding: 50px; color: #94a3b8; }
    .empty-icon { font-size: 3rem; margin-bottom: 10px; display: block; }

    .toast-message {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: none;
      z-index: 9999;
      animation: slideIn 0.3s;
      max-width: calc(100vw - 40px);
      word-break: break-word;
    }

    .toast-message.error { background: #ef4444; }
    .toast-message.info { background: #3b82f6; }

    @keyframes slideIn {
      from { transform: translateX(400px); }
      to { transform: translateX(0); }
    }

    /* ✅ MODAL DE ALTERAÇÃO */
    .alterar-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .alterar-modal.active { display: flex; }

    .alterar-content {
      background: white;
      border-radius: 20px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 30px;
    }

    .alterar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 10px;
    }

    .alterar-close {
      background: none;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      color: #64748b;
      line-height: 1;
    }

    .alterar-step { margin-bottom: 20px; }
    .alterar-step h3 { margin-bottom: 10px; color: #1e293b; }

    .alterar-step textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      resize: vertical;
    }

    .alterar-step textarea:focus {
      outline: none;
      border-color: #00d9ff;
    }

    .char-count {
      text-align: right;
      font-size: 0.85rem;
      color: #94a3b8;
      margin-top: 5px;
    }

    .alterar-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .btn-alterar-cancel {
      flex: 1;
      padding: 12px;
      border: 2px solid #cbd5e1;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      min-width: 180px;
    }

    .btn-alterar-submit {
      flex: 2;
      padding: 12px;
      border: none;
      background: linear-gradient(135deg, #00d9ff, #6366f1);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      min-width: 220px;
    }

    .btn-alterar-submit:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
    }

    /* ========== MODAL DE EDIÇÃO DE RASCUNHO ========== */
    .edit-draft-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
    }

    .edit-draft-modal.active { display: flex; }

    .edit-draft-content {
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideInUp 0.3s ease;
    }

    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .edit-draft-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e2e8f0;
      gap: 12px;
      flex-wrap: wrap;
    }

    .edit-draft-header h2 {
      color: #1e293b;
      font-size: 24px;
      margin: 0;
    }

    .edit-draft-header-info {
      font-size: 0.85rem;
      color: #64748b;
      margin-top: 6px;
    }

    .edit-draft-close {
      background: none;
      border: none;
      font-size: 28px;
      color: #64748b;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 0.2s;
      line-height: 1;
    }

    .edit-draft-close:hover { color: #1e293b; }

    .edit-draft-section-title {
      font-size: 16px;
      font-weight: 700;
      color: #1e293b;
      margin-top: 25px;
      margin-bottom: 15px;
      padding: 10px 0;
      border-bottom: 2px solid #e2e8f0;
    }

    .edit-draft-form-group {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #00d9ff;
    }

    .edit-draft-form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #1e293b;
      font-size: 0.9rem;
    }

    .edit-draft-form-group .field-name {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-bottom: 5px;
      font-family: monospace;
      word-break: break-word;
    }

    .edit-draft-form-group input,
    .edit-draft-form-group textarea,
    .edit-draft-form-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid #cbd5e1;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: 0.2s;
      min-width: 0;
    }

    .edit-draft-form-group input:focus,
    .edit-draft-form-group textarea:focus,
    .edit-draft-form-group select:focus {
      outline: none;
      border-color: #00d9ff;
      box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
    }

    .edit-draft-form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .edit-draft-references {
      display: grid;
      gap: 10px;
    }

    .edit-draft-reference-item {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .edit-draft-reference-item input {
      padding: 10px;
      border: 2px solid #cbd5e1;
      border-radius: 6px;
      font-size: 13px;
      min-width: 0;
    }

    .edit-draft-actions {
      display: flex;
      gap: 12px;
      margin-top: 30px;
      padding-top: 25px;
      border-top: 2px solid #e2e8f0;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .edit-draft-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: 0.3s;
      font-size: 14px;
    }

    .edit-draft-btn-cancel {
      background: white;
      border: 2px solid #cbd5e1;
      color: #64748b;
    }

    .edit-draft-btn-cancel:hover {
      background: #f1f5f9;
      border-color: #94a3b8;
    }

    .edit-draft-btn-save {
      background: linear-gradient(135deg, #00d9ff, #6366f1);
      color: white;
    }

    .edit-draft-btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 217, 255, 0.3);
    }

    .edit-draft-btn-save:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
      transform: none;
    }

    .edit-draft-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      font-size: 16px;
      color: #94a3b8;
    }

    .edit-draft-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 14px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: none;
      z-index: 10001;
      animation: slideInRight 0.3s;
      max-width: calc(100vw - 40px);
      word-break: break-word;
    }

    .edit-draft-toast.error { background: #ef4444; }
    .edit-draft-toast.info { background: #3b82f6; }

    @keyframes slideInRight {
      from { transform: translateX(400px); }
      to { transform: translateX(0); }
    }

    /* ===============================
       ✅ RESPONSIVO (MOBILE + TABLET)
       - Sem mexer em JS / funções
       - Apenas ajustes de layout/UX
    =============================== */

    /* Tablet: melhora leitura e quebra */
    @media (max-width: 1024px) {
      .main-content { padding: 22px; }
      .card { padding: 20px; }
      .sidebar { width: 240px; }
    }

    /* Mobile: vira barra fixa inferior + FAB para “Nova Música” */
    @media (max-width: 768px) {
      body { flex-direction: column; height: 100vh; }

      /* Sidebar vira bottom-nav */
      .sidebar {
        width: 100%;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        gap: 10px;

        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        height: 74px;
        z-index: 9998;

        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
      }

      /* Esconde logo no mobile para dar espaço */
      .logo-container { display: none; }

      /* Menus em linha com ícone + texto pequeno */
      .sidebar nav {
        flex: 1;
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: flex-start;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-right: 54px; /* espaço pro botão flutuante */
      }

      .menu-item {
        margin-bottom: 0;
        padding: 10px 12px;
        border-radius: 10px;
        white-space: nowrap;
        gap: 8px;
        font-size: 0.92rem;
        flex: 0 0 auto;
      }

      /* Mantém texto visível no mobile (mais usável) */
      .menu-item span { display: inline; }

      /* Remove borda lateral no bottom-nav e usa destaque por fundo */
      .menu-item.active { border-left: none; outline: 2px solid rgba(0,217,255,0.35); }

      /* Botão “Nova Música” vira floating action button */
      .new-music-btn {
        margin-top: 0;
        padding: 0;
        width: 52px;
        height: 52px;
        border-radius: 999px;
        position: fixed;
        right: 14px;
        bottom: 92px; /* acima da barra */
        z-index: 9999;
        box-shadow: 0 14px 28px rgba(0, 217, 255, 0.22);
      }
      .new-music-btn::before {
        content: "+";
        font-size: 28px;
        line-height: 1;
        font-weight: 800;
      }
      .new-music-btn:hover { transform: none; }

      /* Conteúdo ganha padding inferior pra não ficar sob a barra */
      .main-content {
        padding: 18px;
        padding-bottom: 105px; /* espaço da barra + conforto */
        height: 100vh;
        overflow-y: auto;
      }

      .header { margin-bottom: 18px; }
      .header h2 { font-size: 1.15rem; }
      .avatar { width: 36px; height: 36px; }

      /* Cards e botões mais confortáveis */
      .card { padding: 18px; }
      .btn { width: 100%; justify-content: center; }
      .action-row { gap: 10px; }
      .btn-download { width: 100%; justify-content: center; }

      /* Comparação já empilha, mas reforça espaçamentos */
      .comparison-container { grid-template-columns: 1fr; gap: 14px; }
      .lyrics-box { max-height: 260px; padding: 14px; }

      /* Modais: mais compactos no mobile */
      .alterar-content { width: 100%; padding: 18px; border-radius: 16px; }
      .edit-draft-content { padding: 18px; border-radius: 14px; }

      /* Referências em 1 coluna no mobile */
      .edit-draft-reference-item { grid-template-columns: 1fr; }
      .btn-alterar-cancel, .btn-alterar-submit { min-width: 0; width: 100%; }
    }

    /* Mobile pequeno: melhora ainda mais (≤ 420px) */
    @media (max-width: 420px) {
      .menu-item { padding: 9px 10px; font-size: 0.88rem; }
      .sidebar { height: 70px; }
      .new-music-btn { width: 50px; height: 50px; right: 12px; bottom: 88px; }
      .main-content { padding: 14px; padding-bottom: 102px; }
      .card-header h3 { font-size: 1.02rem; }
    }

    :root {
  /* Primitive Color Tokens */
  --color-white: rgba(255, 255, 255, 1);
  --color-black: rgba(0, 0, 0, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-gray-400: rgba(119, 124, 124, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-400: rgba(45, 166, 178, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-800: rgba(41, 150, 161, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-orange-400: rgba(230, 129, 97, 1);
  --color-orange-500: rgba(168, 75, 47, 1);

  /* RGB versions for opacity control */
  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;
  --color-slate-500-rgb: 98, 108, 113;
  --color-red-500-rgb: 192, 21, 47;
  --color-red-400-rgb: 255, 84, 89;
  --color-orange-500-rgb: 168, 75, 47;
  --color-orange-400-rgb: 230, 129, 97;

  /* Background color tokens (Light Mode) */
  --color-bg-1: rgba(59, 130, 246, 0.08); /* Light blue */
  --color-bg-2: rgba(245, 158, 11, 0.08); /* Light yellow */
  --color-bg-3: rgba(34, 197, 94, 0.08); /* Light green */
  --color-bg-4: rgba(239, 68, 68, 0.08); /* Light red */
  --color-bg-5: rgba(147, 51, 234, 0.08); /* Light purple */
  --color-bg-6: rgba(249, 115, 22, 0.08); /* Light orange */
  --color-bg-7: rgba(236, 72, 153, 0.08); /* Light pink */
  --color-bg-8: rgba(6, 182, 212, 0.08); /* Light cyan */

  /* Semantic Color Tokens (Light Mode) */
  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
  --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

  /* Common style patterns */
  --focus-ring: 0 0 0 3px var(--color-focus-ring);
  --focus-outline: 2px solid var(--color-primary);
  --status-bg-opacity: 0.15;
  --status-border-opacity: 0.25;
  --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

  /* RGB versions for opacity control */
  --color-success-rgb: 33, 128, 141;
  --color-error-rgb: 192, 21, 47;
  --color-warning-rgb: 168, 75, 47;
  --color-info-rgb: 98, 108, 113;

  /* Typography */
  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system,
    BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo,
    Monaco, Consolas, monospace;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 20px;
  --font-size-3xl: 24px;
  --font-size-4xl: 30px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 550;
  --font-weight-bold: 600;
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --letter-spacing-tight: -0.01em;

  /* Spacing */
  --space-0: 0;
  --space-1: 1px;
  --space-2: 2px;
  --space-4: 4px;
  --space-6: 6px;
  --space-8: 8px;
  --space-10: 10px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;

  /* Border Radius */
  --radius-sm: 6px;
  --radius-base: 8px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --radius-full: 9999px;

  /* Shadows */
  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),
    0 2px 4px -1px rgba(0, 0, 0, 0.02);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04),
    0 4px 6px -2px rgba(0, 0, 0, 0.02);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15),
    inset 0 -1px 0 rgba(0, 0, 0, 0.03);

  /* Animation */
  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

  /* Layout */
  --container-sm: 640px;
  --container-md: 768px;
  --container-lg: 1024px;
  --container-xl: 1280px;
}

/* Dark mode colors */
@media (prefers-color-scheme: dark) {
  :root {
    /* RGB versions for opacity control (Dark Mode) */
    --color-gray-400-rgb: 119, 124, 124;
    --color-teal-300-rgb: 50, 184, 198;
    --color-gray-300-rgb: 167, 169, 169;
    --color-gray-200-rgb: 245, 245, 245;

    /* Background color tokens (Dark Mode) */
    --color-bg-1: rgba(29, 78, 216, 0.15); /* Dark blue */
    --color-bg-2: rgba(180, 83, 9, 0.15); /* Dark yellow */
    --color-bg-3: rgba(21, 128, 61, 0.15); /* Dark green */
    --color-bg-4: rgba(185, 28, 28, 0.15); /* Dark red */
    --color-bg-5: rgba(107, 33, 168, 0.15); /* Dark purple */
    --color-bg-6: rgba(194, 65, 12, 0.15); /* Dark orange */
    --color-bg-7: rgba(190, 24, 93, 0.15); /* Dark pink */
    --color-bg-8: rgba(8, 145, 178, 0.15); /* Dark cyan */

    /* Semantic Color Tokens (Dark Mode) */
    --color-background: var(--color-charcoal-700);
    --color-surface: var(--color-charcoal-800);
    --color-text: var(--color-gray-200);
    --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
    --color-primary: var(--color-teal-300);
    --color-primary-hover: var(--color-teal-400);
    --color-primary-active: var(--color-teal-800);
    --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
    --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
    --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
    --color-border: rgba(var(--color-gray-400-rgb), 0.3);
    --color-error: var(--color-red-400);
    --color-success: var(--color-teal-300);
    --color-warning: var(--color-orange-400);
    --color-info: var(--color-gray-300);
    --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
    --color-btn-primary-text: var(--color-slate-900);
    --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
    --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
    --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1),
      inset 0 -1px 0 rgba(0, 0, 0, 0.15);
    --button-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
    --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
    --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);

    /* Common style patterns - updated for dark mode */
    --focus-ring: 0 0 0 3px var(--color-focus-ring);
    --focus-outline: 2px solid var(--color-primary);
    --status-bg-opacity: 0.15;
    --status-border-opacity: 0.25;
    --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

    /* RGB versions for dark mode */
    --color-success-rgb: var(--color-teal-300-rgb);
    --color-error-rgb: var(--color-red-400-rgb);
    --color-warning-rgb: var(--color-orange-400-rgb);
    --color-info-rgb: var(--color-gray-300-rgb);
  }
}

/* Data attribute for manual theme switching */
[data-color-scheme="dark"] {
  /* RGB versions for opacity control (dark mode) */
  --color-gray-400-rgb: 119, 124, 124;
  --color-teal-300-rgb: 50, 184, 198;
  --color-gray-300-rgb: 167, 169, 169;
  --color-gray-200-rgb: 245, 245, 245;

  /* Colorful background palette - Dark Mode */
  --color-bg-1: rgba(29, 78, 216, 0.15); /* Dark blue */
  --color-bg-2: rgba(180, 83, 9, 0.15); /* Dark yellow */
  --color-bg-3: rgba(21, 128, 61, 0.15); /* Dark green */
  --color-bg-4: rgba(185, 28, 28, 0.15); /* Dark red */
  --color-bg-5: rgba(107, 33, 168, 0.15); /* Dark purple */
  --color-bg-6: rgba(194, 65, 12, 0.15); /* Dark orange */
  --color-bg-7: rgba(190, 24, 93, 0.15); /* Dark pink */
  --color-bg-8: rgba(8, 145, 178, 0.15); /* Dark cyan */

  /* Semantic Color Tokens (Dark Mode) */
  --color-background: var(--color-charcoal-700);
  --color-surface: var(--color-charcoal-800);
  --color-text: var(--color-gray-200);
  --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
  --color-primary: var(--color-teal-300);
  --color-primary-hover: var(--color-teal-400);
  --color-primary-active: var(--color-teal-800);
  --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
  --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
  --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
  --color-border: rgba(var(--color-gray-400-rgb), 0.3);
  --color-error: var(--color-red-400);
  --color-success: var(--color-teal-300);
  --color-warning: var(--color-orange-400);
  --color-info: var(--color-gray-300);
  --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
  --color-btn-primary-text: var(--color-slate-900);
  --color-card-border: rgba(var(--color-gray-400-rgb), 0.15);
  --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1),
    inset 0 -1px 0 rgba(0, 0, 0, 0.15);
  --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
  --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);

  /* Common style patterns - updated for dark mode */
  --focus-ring: 0 0 0 3px var(--color-focus-ring);
  --focus-outline: 2px solid var(--color-primary);
  --status-bg-opacity: 0.15;
  --status-border-opacity: 0.25;
  --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

  /* RGB versions for dark mode */
  --color-success-rgb: var(--color-teal-300-rgb);
  --color-error-rgb: var(--color-red-400-rgb);
  --color-warning-rgb: var(--color-orange-400-rgb);
  --color-info-rgb: var(--color-gray-300-rgb);
}

[data-color-scheme="light"] {
  /* RGB versions for opacity control (light mode) */
  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;

  /* Semantic Color Tokens (Light Mode) */
  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);

  /* RGB versions for light mode */
  --color-success-rgb: var(--color-teal-500-rgb);
  --color-error-rgb: var(--color-red-500-rgb);
  --color-warning-rgb: var(--color-orange-500-rgb);
  --color-info-rgb: var(--color-slate-500-rgb);
}

/* Base styles */
html {
  font-size: var(--font-size-base);
  font-family: var(--font-family-base);
  line-height: var(--line-height-normal);
  color: var(--color-text);
  background-color: var(--color-background);
  -webkit-font-smoothing: antialiased;
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
}

*,
*::before,
*::after {
  box-sizing: inherit;
}

/* Typography */
h1,
h2,
h3,
h4,
h5,
h6 {
  margin: 0;
  font-weight: var(--font-weight-semibold);
  line-height: var(--line-height-tight);
  color: var(--color-text);
  letter-spacing: var(--letter-spacing-tight);
}

h1 {
  font-size: var(--font-size-4xl);
}
h2 {
  font-size: var(--font-size-3xl);
}
h3 {
  font-size: var(--font-size-2xl);
}
h4 {
  font-size: var(--font-size-xl);
}
h5 {
  font-size: var(--font-size-lg);
}
h6 {
  font-size: var(--font-size-md);
}

p {
  margin: 0 0 var(--space-16) 0;
}

a {
  color: var(--color-primary);
  text-decoration: none;
  transition: color var(--duration-fast) var(--ease-standard);
}

a:hover {
  color: var(--color-primary-hover);
}

code,
pre {
  font-family: var(--font-family-mono);
  font-size: calc(var(--font-size-base) * 0.95);
  background-color: var(--color-secondary);
  border-radius: var(--radius-sm);
}

code {
  padding: var(--space-1) var(--space-4);
}

pre {
  padding: var(--space-16);
  margin: var(--space-16) 0;
  overflow: auto;
  border: 1px solid var(--color-border);
}

pre code {
  background: none;
  padding: 0;
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--space-8) var(--space-16);
  border-radius: var(--radius-base);
  font-size: var(--font-size-base);
  font-weight: 500;
  line-height: 1.5;
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-standard);
  border: none;
  text-decoration: none;
  position: relative;
}

.btn:focus-visible {
  outline: none;
  box-shadow: var(--focus-ring);
}

.btn--primary {
  background: var(--color-primary);
  color: var(--color-btn-primary-text);
}

.btn--primary:hover {
  background: var(--color-primary-hover);
}

.btn--primary:active {
  background: var(--color-primary-active);
}

.btn--secondary {
  background: var(--color-secondary);
  color: var(--color-text);
}

.btn--secondary:hover {
  background: var(--color-secondary-hover);
}

.btn--secondary:active {
  background: var(--color-secondary-active);
}

.btn--outline {
  background: transparent;
  border: 1px solid var(--color-border);
  color: var(--color-text);
}

.btn--outline:hover {
  background: var(--color-secondary);
}

.btn--sm {
  padding: var(--space-4) var(--space-12);
  font-size: var(--font-size-sm);
  border-radius: var(--radius-sm);
}

.btn--lg {
  padding: var(--space-10) var(--space-20);
  font-size: var(--font-size-lg);
  border-radius: var(--radius-md);
}

.btn--full-width {
  width: 100%;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Form elements */
.form-control {
  display: block;
  width: 100%;
  padding: var(--space-8) var(--space-12);
  font-size: var(--font-size-md);
  line-height: 1.5;
  color: var(--color-text);
  background-color: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  transition: border-color var(--duration-fast) var(--ease-standard),
    box-shadow var(--duration-fast) var(--ease-standard);
}

textarea.form-control {
  font-family: var(--font-family-base);
  font-size: var(--font-size-base);
}

select.form-control {
  padding: var(--space-8) var(--space-12);
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background-image: var(--select-caret-light);
  background-repeat: no-repeat;
  background-position: right var(--space-12) center;
  background-size: 16px;
  padding-right: var(--space-32);
}

/* Add a dark mode specific caret */
@media (prefers-color-scheme: dark) {
  select.form-control {
    background-image: var(--select-caret-dark);
  }
}

/* Also handle data-color-scheme */
[data-color-scheme="dark"] select.form-control {
  background-image: var(--select-caret-dark);
}

[data-color-scheme="light"] select.form-control {
  background-image: var(--select-caret-light);
}

.form-control:focus {
  border-color: var(--color-primary);
  outline: var(--focus-outline);
}

.form-label {
  display: block;
  margin-bottom: var(--space-8);
  font-weight: var(--font-weight-medium);
  font-size: var(--font-size-sm);
}

.form-group {
  margin-bottom: var(--space-16);
}

/* Card component */
.card {
  background-color: var(--color-surface);
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-card-border);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
  transition: box-shadow var(--duration-normal) var(--ease-standard);
}

.card:hover {
  box-shadow: var(--shadow-md);
}

.card__body {
  padding: var(--space-16);
}

.card__header,
.card__footer {
  padding: var(--space-16);
  border-bottom: 1px solid var(--color-card-border-inner);
}

/* Status indicators - simplified with CSS variables */
.status {
  display: inline-flex;
  align-items: center;
  padding: var(--space-6) var(--space-12);
  border-radius: var(--radius-full);
  font-weight: var(--font-weight-medium);
  font-size: var(--font-size-sm);
}

.status--success {
  background-color: rgba(
    var(--color-success-rgb, 33, 128, 141),
    var(--status-bg-opacity)
  );
  color: var(--color-success);
  border: 1px solid
    rgba(var(--color-success-rgb, 33, 128, 141), var(--status-border-opacity));
}

.status--error {
  background-color: rgba(
    var(--color-error-rgb, 192, 21, 47),
    var(--status-bg-opacity)
  );
  color: var(--color-error);
  border: 1px solid
    rgba(var(--color-error-rgb, 192, 21, 47), var(--status-border-opacity));
}

.status--warning {
  background-color: rgba(
    var(--color-warning-rgb, 168, 75, 47),
    var(--status-bg-opacity)
  );
  color: var(--color-warning);
  border: 1px solid
    rgba(var(--color-warning-rgb, 168, 75, 47), var(--status-border-opacity));
}

.status--info {
  background-color: rgba(
    var(--color-info-rgb, 98, 108, 113),
    var(--status-bg-opacity)
  );
  color: var(--color-info);
  border: 1px solid
    rgba(var(--color-info-rgb, 98, 108, 113), var(--status-border-opacity));
}

/* Container layout */
.container {
  width: 100%;
  margin-right: auto;
  margin-left: auto;
  padding-right: var(--space-16);
  padding-left: var(--space-16);
}

@media (min-width: 640px) {
  .container {
    max-width: var(--container-sm);
  }
}
@media (min-width: 768px) {
  .container {
    max-width: var(--container-md);
  }
}
@media (min-width: 1024px) {
  .container {
    max-width: var(--container-lg);
  }
}
@media (min-width: 1280px) {
  .container {
    max-width: var(--container-xl);
  }
}

/* Utility classes */
.flex {
  display: flex;
}
.flex-col {
  flex-direction: column;
}
.items-center {
  align-items: center;
}
.justify-center {
  justify-content: center;
}
.justify-between {
  justify-content: space-between;
}
.gap-4 {
  gap: var(--space-4);
}
.gap-8 {
  gap: var(--space-8);
}
.gap-16 {
  gap: var(--space-16);
}

.m-0 {
  margin: 0;
}
.mt-8 {
  margin-top: var(--space-8);
}
.mb-8 {
  margin-bottom: var(--space-8);
}
.mx-8 {
  margin-left: var(--space-8);
  margin-right: var(--space-8);
}
.my-8 {
  margin-top: var(--space-8);
  margin-bottom: var(--space-8);
}

.p-0 {
  padding: 0;
}
.py-8 {
  padding-top: var(--space-8);
  padding-bottom: var(--space-8);
}
.px-8 {
  padding-left: var(--space-8);
  padding-right: var(--space-8);
}
.py-16 {
  padding-top: var(--space-16);
  padding-bottom: var(--space-16);
}
.px-16 {
  padding-left: var(--space-16);
  padding-right: var(--space-16);
}

.block {
  display: block;
}
.hidden {
  display: none;
}

/* Accessibility */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

:focus-visible {
  outline: var(--focus-outline);
  outline-offset: 2px;
}

/* Dark mode specifics */
[data-color-scheme="dark"] .btn--outline {
  border: 1px solid var(--color-border-secondary);
}

@font-face {
  font-family: 'FKGroteskNeue';
  src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2')
    format('woff2');
}

/* END PERPLEXITY DESIGN SYSTEM */
/* ==========================================
   MOBILE OPTIMIZATION
   Dashboard TuneCraft - Responsive Version
   ========================================== */

/* MEDIA QUERY: Tablet (up to 1024px) */
@media (max-width: 1024px) {
  .main-content { 
    padding: var(--space-24); 
  }
  .card { 
    padding: var(--space-20); 
  }
  .sidebar { 
    width: 240px; 
  }
}

/* MEDIA QUERY: Tablet (up to 768px) - SIDEBAR BECOMES BOTTOM NAV */
@media (max-width: 768px) {
  body {
    flex-direction: column;
    height: 100vh;
    background: var(--color-background);
  }

  /* Sidebar becomes bottom navigation */
  .sidebar {
    width: 100%;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-10) var(--space-12);
    gap: var(--space-10);
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    height: 74px;
    z-index: 9998;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    background: var(--color-surface);
    border-top: 1px solid var(--color-border);
  }

  /* Hide logo on mobile to save space */
  .logo-container {
    display: none;
  }

  /* Menu items in horizontal row */
  .sidebar nav {
    flex: 1;
    display: flex;
    gap: var(--space-8);
    align-items: center;
    justify-content: flex-start;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-right: 54px; /* space for floating button */
  }

  .menu-item {
    margin-bottom: 0;
    padding: var(--space-10) var(--space-12);
    border-radius: var(--radius-md);
    white-space: nowrap;
    gap: var(--space-8);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    flex: 0 0 auto;
    color: var(--color-text-secondary);
    transition: all var(--duration-normal) var(--ease-standard);
  }

  /* Active menu item on mobile */
  .menu-item.active {
    border-left: none;
    outline: 2px solid var(--color-focus-ring);
    background: rgba(var(--color-teal-500-rgb), 0.1);
    color: var(--color-primary);
  }

  .menu-item span {
    display: inline;
  }

  /* New Music button becomes floating action button */
  .new-music-btn {
    margin-top: 0;
    padding: 0;
    width: 52px;
    height: 52px;
    border-radius: var(--radius-full);
    position: fixed;
    right: var(--space-16);
    bottom: 92px; /* above bottom bar */
    z-index: 9999;
    box-shadow: 0 14px 28px rgba(var(--color-teal-500-rgb), 0.22);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    background: var(--color-primary);
    color: var(--color-btn-primary-text);
    transition: all var(--duration-normal) var(--ease-standard);
  }

  .new-music-btn::before {
    content: '➕';
    font-size: 28px;
    line-height: 1;
    font-weight: var(--font-weight-bold);
  }

  .new-music-btn:hover {
    transform: none;
    background: var(--color-primary-hover);
  }

  .new-music-btn:active {
    background: var(--color-primary-active);
  }

  /* Main content gets bottom padding */
  .main-content {
    padding: var(--space-20);
    padding-bottom: 105px; /* space for bottom bar */
    height: 100vh;
    overflow-y: auto;
    background: var(--color-background);
    color: var(--color-text);
  }

  /* Responsive header */
  .header {
    margin-bottom: var(--space-20);
  }

  .header h2 {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
  }

  .avatar {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-full);
  }

  /* More compact cards */
  .card {
    padding: var(--space-20);
    background: var(--color-surface);
    border: 1px solid var(--color-card-border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    transition: box-shadow var(--duration-normal) var(--ease-standard);
  }

  .card:hover {
    box-shadow: var(--shadow-md);
  }

  .card p, .card span {
    color: var(--color-text);
    font-size: var(--font-size-base);
  }

  .card strong {
    color: var(--color-text);
    font-weight: var(--font-weight-semibold);
  }

  /* Draft summary */
  .draft-summary {
    background: var(--color-surface);
    border-left: 3px solid var(--color-warning);
    padding: var(--space-16);
    border-radius: var(--radius-base);
  }

  .draft-summary p {
    color: var(--color-text);
  }

  .draft-summary p strong {
    color: var(--color-text);
    font-weight: var(--font-weight-semibold);
  }

  /* Lyrics box */
  .lyrics-box {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-base);
    color: var(--color-text);
    padding: var(--space-16);
    font-family: var(--font-family-mono);
    font-size: var(--font-size-sm);
  }

  /* Responsive buttons */
  .btn {
    width: 100%;
    justify-content: center;
    padding: var(--space-12) var(--space-16);
    border-radius: var(--radius-base);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    transition: all var(--duration-normal) var(--ease-standard);
  }

  .btn:focus-visible {
    outline: var(--focus-outline);
    box-shadow: var(--focus-ring);
  }

  .action-row {
    gap: var(--space-10);
    display: flex;
    flex-wrap: wrap;
  }

  .btn-download {
    width: 100%;
    justify-content: center;
  }

  /* Comparison stacks on mobile */
  .comparison-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-16);
  }

  .lyrics-box {
    max-height: 260px;
    padding: var(--space-16);
    overflow-y: auto;
  }

  /* More compact modals */
  .alterar-content {
    width: 100%;
    padding: var(--space-20);
    border-radius: var(--radius-lg);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
  }

  .edit-draft-content {
    padding: var(--space-20);
    border-radius: var(--radius-lg);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
  }

  /* References in 1 column */
  .edit-draft-reference-item {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-12);
  }

  .btn-alterar-cancel,
  .btn-alterar-submit {
    min-width: 0;
    width: 100%;
  }

  /* Version cards */
  .version-card {
    border: 2px solid var(--color-card-border);
    background: var(--color-surface);
    color: var(--color-text);
    padding: var(--space-16);
    border-radius: var(--radius-base);
    transition: all var(--duration-normal) var(--ease-standard);
  }

  .version-card.selected {
    border-color: var(--color-primary);
    background: var(--color-secondary);
  }

  .version-card:hover {
    box-shadow: var(--shadow-md);
  }

  .version-card h4 {
    color: var(--color-text);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
  }

  /* Responsive status badges */
  .status-badge {
    font-size: var(--font-size-xs);
    padding: var(--space-4) var(--space-8);
    border-radius: var(--radius-full);
    font-weight: var(--font-weight-medium);
  }

  /* Card headers */
  .card-header h3 {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
  }
}

/* MEDIA QUERY: Mobile Portrait (up to 480px) */
@media (max-width: 480px) {
  .main-content {
    padding: var(--space-16);
    padding-bottom: 100px;
  }

  .card {
    padding: var(--space-16);
  }

  .header h2 {
    font-size: var(--font-size-lg);
  }

  .menu-item {
    padding: var(--space-8) var(--space-10);
    font-size: var(--font-size-sm);
  }

  .sidebar {
    height: 68px;
    padding: var(--space-8) var(--space-10);
  }

  .new-music-btn {
    width: 48px;
    height: 48px;
    right: var(--space-12);
    bottom: 82px;
  }

  .new-music-btn::before {
    font-size: 24px;
  }

  .card-header h3 {
    font-size: var(--font-size-base);
  }

  /* Toast responsive */
  .toast-message {
    bottom: 84px;
    left: var(--space-10);
    right: var(--space-10);
    max-width: calc(100vw - var(--space-20));
    padding: var(--space-12);
    border-radius: var(--radius-base);
    font-size: var(--font-size-sm);
  }

  /* Modal responsive */
  .alterar-modal,
  .edit-draft-modal {
    padding: var(--space-16);
  }

  .alterar-content,
  .edit-draft-content {
    width: calc(100% - var(--space-32));
    padding: var(--space-16);
  }

  /* Stacked buttons */
  .action-row {
    flex-direction: column;
    gap: var(--space-8);
  }

  .btn {
    font-size: var(--font-size-sm);
    padding: var(--space-10) var(--space-12);
  }

  /* Smaller spacing throughout */
  .draft-summary {
    padding: var(--space-12);
  }

  .lyrics-box {
    padding: var(--space-12);
    max-height: 220px;
  }

  .comparison-container {
    gap: var(--space-12);
  }
}

/* MEDIA QUERY: Small Mobile (up to 420px) */
@media (max-width: 420px) {
  .menu-item {
    padding: var(--space-8) var(--space-8);
    font-size: var(--font-size-xs);
    gap: var(--space-6);
  }

  .sidebar {
    height: 66px;
    padding: var(--space-8);
  }

  .new-music-btn {
    width: 46px;
    height: 46px;
    right: var(--space-10);
    bottom: 78px;
  }

  .main-content {
    padding: var(--space-12);
    padding-bottom: 96px;
  }

  .card {
    padding: var(--space-12);
  }

  .card-header h3 {
    font-size: var(--font-size-sm);
  }

  .btn {
    font-size: var(--font-size-xs);
    padding: var(--space-8) var(--space-10);
  }
}

/* ==========================================
   INPUT FIELDS & FORMS
   ========================================== */

@media (max-width: 768px) {
  /* Input fields */
  .profile-form input,
  .edit-draft-form-group input,
  .edit-draft-form-group textarea,
  .edit-draft-form-group select {
    background: var(--color-surface);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-base);
    padding: var(--space-10) var(--space-12);
    font-size: var(--font-size-base);
    font-family: var(--font-family-base);
    transition: border-color var(--duration-fast) var(--ease-standard),
      box-shadow var(--duration-fast) var(--ease-standard);
  }

  .profile-form textarea,
  .edit-draft-form-group textarea {
    font-family: var(--font-family-base);
    resize: vertical;
  }

  .profile-form input:focus,
  .edit-draft-form-group input:focus,
  .edit-draft-form-group textarea:focus,
  .edit-draft-form-group select:focus {
    border-color: var(--color-primary);
    outline: var(--focus-outline);
    box-shadow: var(--focus-ring);
  }

  /* Select dropdowns */
  .edit-draft-form-group select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: var(--select-caret-light);
    background-repeat: no-repeat;
    background-position: right var(--space-12) center;
    background-size: 16px;
    padding-right: var(--space-32);
  }

  @media (prefers-color-scheme: dark) {
    .edit-draft-form-group select {
      background-image: var(--select-caret-dark);
    }
  }

  [data-color-scheme="dark"] .edit-draft-form-group select {
    background-image: var(--select-caret-dark);
  }

  /* Text colors */
  .empty-state {
    color: var(--color-text-secondary);
    font-size: var(--font-size-base);
  }

  /* Form groups */
  .edit-draft-form-group {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-base);
    padding: var(--space-16);
    margin-bottom: var(--space-16);
  }

  /* Labels */
  .alterar-step h3,
  .edit-draft-section-title,
  .edit-draft-form-group label {
    color: var(--color-text);
    font-weight: var(--font-weight-semibold);
    font-size: var(--font-size-base);
    margin-bottom: var(--space-8);
    display: block;
  }

  /* Version changelog */
  .version-changelog {
    background: var(--color-surface);
    border-left: 3px solid var(--color-warning);
    color: var(--color-text);
    padding: var(--space-12);
    border-radius: var(--radius-base);
    font-size: var(--font-size-sm);
  }
}

/* ==========================================
   SCROLL STYLING
   ========================================== */

@media (max-width: 768px) {
  /* Scrollbar styling */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: var(--color-background);
  }

  ::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: var(--radius-sm);
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-secondary);
  }
}

/* ==========================================
   ANIMATIONS & TRANSITIONS
   ========================================== */

@media (max-width: 768px) {
  /* Faster transitions on mobile */
  * {
    transition-duration: var(--duration-fast) !important;
  }

  /* Smooth scroll */
  html {
    scroll-behavior: smooth;
  }

  /* Button press effect */
  .btn:active {
    transform: scale(0.98);
  }

  .menu-item:active {
    transform: scale(0.96);
  }
}

/* ==========================================
   BUTTON STYLES
   ========================================== */

@media (max-width: 768px) {
  /* Primary button */
  .btn-approve,
  .btn-primary {
    background: var(--color-primary);
    color: var(--color-btn-primary-text);
    border: none;
  }

  .btn-approve:hover,
  .btn-primary:hover {
    background: var(--color-primary-hover);
  }

  .btn-approve:active,
  .btn-primary:active {
    background: var(--color-primary-active);
  }

  /* Secondary button */
  .btn-secondary {
    background: var(--color-secondary);
    color: var(--color-text);
    border: 1px solid var(--color-border);
  }

  .btn-secondary:hover {
    background: var(--color-secondary-hover);
  }

  .btn-secondary:active {
    background: var(--color-secondary-active);
  }

  /* Select button (variant) */
  .btn-select {
    background: var(--color-primary);
    color: var(--color-btn-primary-text);
  }

  .btn-select:hover {
    background: var(--color-primary-hover);
  }

  /* Links */
  a {
    color: var(--color-primary);
    text-decoration: none;
    transition: color var(--duration-fast) var(--ease-standard);
  }

  a:hover {
    color: var(--color-primary-hover);
  }

  a:focus-visible {
    outline: var(--focus-outline);
    outline-offset: 2px;
  }
}

/* ==========================================
   ACCESSIBILITY
   ========================================== */

@media (max-width: 768px) {
  /* High contrast text */
  .card h3,
  .card h4 {
    color: var(--color-text);
    font-weight: var(--font-weight-semibold);
  }

  /* Focus visible states */
  button:focus-visible,
  a:focus-visible,
  input:focus-visible,
  textarea:focus-visible,
  select:focus-visible {
    outline: var(--focus-outline);
    outline-offset: 2px;
    box-shadow: var(--focus-ring);
  }

  /* Touch targets */
  .menu-item,
  .btn,
  button,
  a {
    min-height: 44px;
    display: inline-flex;
    align-items: center;
  }

  /* Screen reader only text */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
}
  <link rel="stylesheet" href="fix-mobile-bottom-nav.css">
  
  </style>

</head>
<body>

  <!-- Chat Modal (criar nova música) -->
  <div class="chat-modal" id="chatModal">
    <div class="chat-container">
      <div class="chat-header">
        <h2>🎵 Criar Nova Música</h2>
        <button class="close-chat" onclick="closeChat()">×</button>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-section" id="inputSection"></div>
    </div>
  </div>

  <!-- ✅ Modal de Alteração de Letra -->
  <div class="alterar-modal" id="alterarModal">
    <div class="alterar-content">
      <div class="alterar-header">
        <h2>✏️ Alterar Letra</h2>
        <button class="alterar-close" onclick="fecharAlterarModal()">×</button>
      </div>

      <div class="alterar-step">
        <h3>O que você gostaria de mudar na letra? 🎵</h3>
        <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 10px;">
          💡 Exemplos: "Tornar o refrão mais animado", "Adicionar menção a Dourados", "Mudar o tom de romântico para alegre"
        </p>
        <textarea
          id="mudancasDesejadas"
          placeholder="Ex: Gostaria que o refrão fosse mais energético e mencionasse nossa viagem para o Rio..."
          maxlength="500"
          oninput="updateAlterarCharCount('mudancasDesejadas', 'count1')"
        ></textarea>
        <div class="char-count"><span id="count1">0</span>/500</div>
      </div>

      <div class="alterar-step">
        <h3>Há algo específico que DEVE permanecer? 🔒</h3>
        <textarea
          id="manterElementos"
          placeholder="Ex: Mantenha as referências a Dourados e o nome 'Aline'..."
          maxlength="300"
          oninput="updateAlterarCharCount('manterElementos', 'count2')"
        ></textarea>
        <div class="char-count"><span id="count2">0</span>/300</div>
      </div>

      <div class="alterar-step">
        <h3>Observações finais sobre o tom ou estilo? 🎨 (Opcional)</h3>
        <textarea
          id="observacoesFinais"
          placeholder="Ex: Quero que seja mais emocionante, menos melancólica..."
          maxlength="200"
          oninput="updateAlterarCharCount('observacoesFinais', 'count3')"
        ></textarea>
        <div class="char-count"><span id="count3">0</span>/200</div>
      </div>

      <div class="alterar-buttons">
        <button class="btn-alterar-cancel" onclick="fecharAlterarModal()">Cancelar</button>
        <button class="btn-alterar-submit" id="btnSubmitAlteracao" onclick="submitAlteracao()">
          Enviar Alterações ✨
        </button>
      </div>
    </div>
  </div>

  <!-- ✅ MODAL DE EDIÇÃO DE RASCUNHO -->
  <div class="edit-draft-modal" id="editDraftModal">
    <div class="edit-draft-content">
      <div class="edit-draft-header">
        <div>
          <h2>✏️ Editar Rascunho</h2>
          <div class="edit-draft-header-info" id="editDraftHeaderInfo">Carregando...</div>
        </div>
        <button class="edit-draft-close" onclick="closeEditDraftModal()">×</button>
      </div>

      <div id="editDraftLoading" class="edit-draft-loading">
        ⏳ Carregando rascunho...
      </div>

      <form id="editDraftForm" style="display: none;">
        <!-- Formulário será populado dinamicamente -->
      </form>
    </div>
  </div>

  <div class="edit-draft-toast" id="editDraftToast"></div>

  <aside class="sidebar">
    <div class="logo-container">
      <img src="https://i.ibb.co/wFFzDMy9/tunecraft-logo-transparente.png" alt="TuneCraft" style="height: 50px;">
    </div>

    <nav style="flex: 1;">
      <div class="menu-item active" onclick="showSection('drafts', this)">
        📋 <span>Meus Rascunhos</span>
      </div>
      <div class="menu-item" onclick="showSection('pending', this)">
        📝 <span>Aprovar Letra</span>
      </div>
      <div class="menu-item" onclick="showSection('approved', this)">
        🎹 <span>Letras Aprovadas</span>
      </div>
      <div class="menu-item" onclick="showSection('received', this)">
        🎵 <span>Músicas Recebidas</span>
      </div>
      <div class="menu-item" onclick="showSection('profile', this)">
        👤 <span>Minha Conta</span>
      </div>
    </nav>

    <button class="new-music-btn" onclick="openChat()">
      + Nova Música
    </button>
  </aside>

  <main class="main-content">
    <div class="header">
      <header class="header">
  <button class="mobile-menu-toggle">☰</button>
  
  <h2>Seu Título</h2>
  
  <div class="user-profile">
    <div class="avatar">US</div>
    <span>Usuário</span>
  </div>
</header>
      <h2 id="pageTitle">Meus Rascunhos</h2>
      <div class="user-profile">
        <span id="userName">Usuário</span>
        <div class="avatar">U</div>
        <button onclick="logout()" style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:0.9rem; margin-left:10px;">Sair</button>
      </div>
    </div>

    <div id="drafts" class="section active"></div>

    <div id="pending" class="section"></div>

    <div id="approved" class="section">
      <h2>Em Produção</h2>
      <p style="color:#64748b; margin-bottom: 20px;">Nossos artistas estão gravando essas músicas agora.</p>
      <div id="approved-list"></div>
    </div>

    <div id="received" class="section">
      <h2>Músicas Prontas</h2>
      <p style="color:#64748b; margin-bottom: 20px;">Baixe e compartilhe suas criações.</p>
      <div id="received-list"></div>
    </div>

    <div id="profile" class="section">
      <h2>Meus Dados</h2>
      <div class="card profile-form">
        <label>Nome Completo</label>
        <input type="text" id="profName">

        <label>Email</label>
        <input type="email" id="profEmail" readonly style="background:#f1f5f9; color:#64748b;">

        <label>Nova Senha (deixe em branco para manter)</label>
        <input type="password" id="profPass" placeholder="••••••">

        <button class="btn-save-profile" onclick="saveProfile()">Salvar Alterações</button>
      </div>
    </div>
  </main>

  <!-- Toast de notificações -->
  <div class="toast-message" id="toastMessage"></div>

  <!-- NOVO: Config Global -->
  <script src="config.js"></script>
  <script src="form_options.js"></script> 
  <!-- Chat JS (agora sem redeclaração) -->
  <script src="chat.js"></script>
  <script src="chat_themes_full.js"></script>


  

  <script>
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let userData = JSON.parse(localStorage.getItem("tuneCraftUser")) || { name: "Visitante", email: "", user_id: null, orders: [] };
    let currentAlterandoId = null;
    let editDraftCurrentPedidoId = null;

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toastMessage');
      toast.innerText = message;
      toast.className = `toast-message ${type}`;
      toast.style.display = 'block';

      setTimeout(() => {
        toast.style.display = 'none';
      }, 4000);
    }

    function normalizeStatus(s) {
      const v = (s || "").toLowerCase().replace(/\s+/g, "");
      if (v === "draft") return "draft";
      if (v === "pendingapproval" || v === "pending_approval" || v === "waiting_user_approval" || v === "waitinguserapproval") return "pending_approval";
      if (v === "aguardandoaprovacao" || v === "aguardando_aprovacao") return "aguardando_aprovacao";
      if (v === "production" || v === "inproduction" || v === "generatingaudio" || v === "generating_audio") return "production";
      if (v === "completed" || v === "done" || v === "received") return "completed";
      return v || "pending_approval";
    }

    function escapeHtml(str) {
      return (str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "'");
    }

    function extractSummaryFromPayload(payload) {
    const answers = payload.answers || {};
    const asked = payload.asked || [];
    const theme = answers.ai_metadata?.themeId || "indefinido";
    const genre = answers.musicStyle?.primaryGenre || "indefinido";
    
    // ✅ Usar FORM_OPTIONS (vem de form_options.js)
    
    // Mapear tema usando FORM_OPTIONS.themes
    const themeOption = FORM_OPTIONS.themes.find(t => t.value === theme);
    const themeLabel = themeOption ? themeOption.label : "🎭 Indefinido";
    
    // Mapear gênero usando FORM_OPTIONS.genres
    const genreOption = FORM_OPTIONS.genres.find(g => g.value === genre);
    const genreLabel = genreOption ? genreOption.label : "Não definido";
    
    // Obter primeira linha da mensagem principal
    const messagePreview = answers.lyricDetails?.mainMessage 
        ? answers.lyricDetails.mainMessage.substring(0, 70) + "..."
        : "Sem mensagem";
    
    return {
        recipient: themeLabel,  // Tema com emoji
        genre: genreLabel,      // Gênero com emoji
        message: messagePreview,  // Prévia da mensagem
        asked_count: asked.length  // Quantas perguntas respondidas
    };
}

    async function getSessionOrRedirect() {
      const { data, error } = await sb.auth.getSession();
      if (error) console.warn("getSession error:", error);

      const session = data?.session;
      if (!session?.access_token || !session?.user?.id) {
        window.location.href = "login.html";
        return null;
      }
      return session;
    }

    async function loadOrdersFromSupabase() {
      const { data, error } = await sb
        .from("musicas_pedidos")
        .select("id,title,lyrics,status,created_at,audio_urls,versao_original,versao_modificada,versao_aprovada,alteracao_usada,versao_aprovada_tipo,alteracao_solicitada,payload")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Erro sb.from(musicas_pedidos):", error);
        return [];
      }

      return (data || []).map(r => {
        let audioUrls = r.audio_urls;

        if (Array.isArray(audioUrls) && audioUrls.length > 0 && typeof audioUrls[0] === 'string') {
          try {
            audioUrls = audioUrls.map(url => JSON.parse(url));
          } catch (e) {
            console.error("❌ Erro ao fazer parse de audio_urls:", e);
            audioUrls = [];
          }
        }

        return {
          id: r.id,
          title: r.title || "Sem título",
          lyrics: r.lyrics || "",
          status: normalizeStatus(r.status),
          created_at: r.created_at,
          audio_urls: audioUrls,
          versao_original: r.versao_original,
          versao_modificada: r.versao_modificada,
          versao_aprovada: r.versao_aprovada,
          alteracao_usada: r.alteracao_usada,
          versao_aprovada_tipo: r.versao_aprovada_tipo,
          alteracao_solicitada: r.alteracao_solicitada,
          payload: r.payload
        };
      });
    }

    async function initDashboard() {
      const session = await getSessionOrRedirect();
      if (!session) return;

      const fullName = session.user.user_metadata?.full_name || userData.name || "Usuário";
      userData.name = fullName;
      userData.email = session.user.email || userData.email || "";
      userData.user_id = session.user.id;

      const orders = await loadOrdersFromSupabase();
      userData.orders = orders;

      localStorage.setItem("tuneCraftUser", JSON.stringify(userData));

      document.getElementById("userName").innerText = userData.name.split(" ")[0];
      document.querySelector(".avatar").innerText = userData.name.charAt(0);

      document.getElementById("profName").value = userData.name;
      document.getElementById("profEmail").value = userData.email;

      renderSections();
    }

    initDashboard();

    function showSection(id, element) {
      if (element) {
        document.querySelectorAll(".menu-item").forEach(i => i.classList.remove("active"));
        element.classList.add("active");
      }

      const titles = {
        drafts: "Meus Rascunhos",
        pending: "Aprovar Letra",
        approved: "Letras Aprovadas",
        received: "Músicas Recebidas",
        profile: "Minha Conta"
      };
      document.getElementById("pageTitle").innerText = titles[id] || "Painel";

      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    function renderSections() {
      const draftsContainer = document.getElementById("drafts");
      const pendingContainer = document.getElementById("pending");
      const approvedContainer = document.getElementById("approved-list");
      const receivedContainer = document.getElementById("received-list");

      draftsContainer.innerHTML = "";
      pendingContainer.innerHTML = "";
      approvedContainer.innerHTML = "";
      receivedContainer.innerHTML = "";

      let hasDrafts = false;
      let hasPending = false;
      let hasApproved = false;
      let hasReceived = false;

      if (userData.orders && userData.orders.length > 0) {
        userData.orders.forEach(order => {
          const title = escapeHtml(order.title);
          const lyrics = escapeHtml(order.lyrics);

          if (order.status === "draft") {
            hasDrafts = true;
            const summary = extractSummaryFromPayload(order.payload);
draftsContainer.innerHTML += `
    <div class="card draft-card">
        <div class="card-header">
            <h3>🎵 ${summary.recipient}</h3>
            <span class="status-badge status-draft">Rascunho</span>
        </div>
        <div class="draft-summary">
            <p><strong>Tema:</strong> ${summary.recipient}</p>
            <p><strong>Gênero:</strong> ${summary.genre}</p>
            <p><strong>Perguntas:</strong> ${summary.asked_count} respondidas</p>
            <p><strong>Descrição:</strong> "${summary.message}"</p>
        </div>
        <div class="action-row">
                  <button class="btn btn-revise" onclick="editarDraft('${order.id}')">
                    ✏️ Editar Formulário
                  </button>
                  <button class="btn btn-approve" onclick="irParaCheckout('${order.id}')">
                    💳 Pagar e Gerar Letra (R$ 49,90)
                  </button>
        </div>
    </div>
`;
          }
          else if (order.status === "pending_approval" && !order.versao_modificada) {
            hasPending = true;
            const podeAlterar = !order.alteracao_usada;

            pendingContainer.innerHTML += `
              <div class="card">
                <div class="card-header">
                  <h3>${title}</h3>
                  <span class="status-badge status-pending">Aguardando Aprovação</span>
                </div>
                <p style="font-size:0.9rem; color:#64748b;">Leia a letra gerada abaixo.</p>
                <div class="lyrics-box">${lyrics}</div>
                <div class="action-row">
                  <button
                    class="btn btn-revise"
                    onclick="abrirModalAlteracao('${order.id}')"
                    ${!podeAlterar ? 'disabled title="Alteração já foi usada"' : ''}
                  >
                    ${podeAlterar ? '✏️ Solicitar Alteração (1x)' : '🔒 Alteração Usada'}
                  </button>
                  <button class="btn btn-approve" id="btn-${order.id}" onclick="aprovarLetraOriginal('${order.id}')">
                    ✅ Aprovar e Gerar Áudio
                  </button>
                </div>
              </div>
            `;
          }
          else if (order.status === "aguardando_aprovacao" && order.versao_modificada) {
            hasPending = true;

            const versaoOriginal = order.versao_original || { customer_lyrics: order.lyrics };
            const versaoModificada = order.versao_modificada;

            pendingContainer.innerHTML += `
              <div class="card">
                <div class="card-header">
                  <h3>${title}</h3>
                  <span class="status-badge status-awaiting">Escolha uma Versão</span>
                </div>

                <p style="font-size:0.9rem; color:#64748b; margin-bottom: 15px;">
                  Compare as duas versões e escolha sua favorita:
                </p>

                ${versaoModificada.changelog ? `
                  <div class="version-changelog">
                    <strong>📝 O que foi alterado:</strong><br>
                    ${escapeHtml(versaoModificada.changelog)}
                  </div>
                ` : ''}

                <div class="comparison-container">
                  <div class="version-card">
                    <h4>📄 Versão Original</h4>
                    <div class="lyrics-box" style="max-height: 250px;">
                      ${escapeHtml(versaoOriginal.customer_lyrics || versaoOriginal.lyrics)}
                    </div>
                    <button class="btn btn-select" onclick="aprovarVersao('${order.id}', 'original')">
                      ✅ Escolher Esta
                    </button>
                  </div>

                  <div class="version-card">
                    <h4>✨ Versão Modificada</h4>
                    <div class="lyrics-box" style="max-height: 250px;">
                      ${escapeHtml(versaoModificada.customer_lyrics)}
                    </div>
                    <button class="btn btn-select" onclick="aprovarVersao('${order.id}', 'modificada')">
                      ✅ Escolher Esta
                    </button>
                  </div>
                </div>
              </div>
            `;
          }
          else if (order.status === "production") {
            hasApproved = true;
            approvedContainer.innerHTML += `
              <div class="card">
                <div class="card-header">
                  <h3>${title}</h3>
                  <span class="status-badge status-production">Em Produção</span>
                </div>
                <p>Letra aprovada! Estamos trabalhando no áudio.</p>
              </div>
            `;
          }
          else if (order.status === "completed") {
            hasReceived = true;
            const urls = Array.isArray(order.audio_urls) ? order.audio_urls : [];

            receivedContainer.innerHTML += `
              <div class="card">
                <div class="card-header">
                  <h3>${title}</h3>
                  <span class="status-badge status-completed">Pronta</span>
                </div>

                ${
                  urls.length >= 2
                    ? `
                      <strong>🎧 Versão A</strong>
                      <audio controls src="${urls[0].audio_url || urls[0]}" style="width:100%; margin:10px 0;"></audio>

                      <strong>🎧 Versão B</strong>
                      <audio controls src="${urls[1].audio_url || urls[1]}" style="width:100%; margin:10px 0;"></audio>

                      <div class="action-row" style="margin-top:10px">
                        <a class="btn btn-download" href="${urls[0].audio_url || urls[0]}" download>⬇️ Baixar A</a>
                        <a class="btn btn-download" href="${urls[1].audio_url || urls[1]}" download>⬇️ Baixar B</a>
                      </div>
                    `
                    : urls.length === 1
                    ? `
                      <strong>🎧 Áudio</strong>
                      <audio controls src="${urls[0].audio_url || urls[0]}" style="width:100%; margin:10px 0;"></audio>
                      <a class="btn btn-download" href="${urls[0].audio_url || urls[0]}" download>⬇️ Baixar</a>
                    `
                    : `<p>Sua música foi finalizada e está sendo preparada para audição.</p>`
                }
              </div>
            `;
          }
        });
      }

      if (!hasDrafts) {
        draftsContainer.innerHTML = `
          <div class="empty-state">
            <span class="empty-icon">📋</span>
            <h3>Sem rascunhos no momento</h3>
            <p>Crie uma nova música para começar!</p>
            <button class="btn btn-approve" onclick="openChat()" style="margin-top:20px;">Criar Nova Música</button>
          </div>
        `;
      }

      if (!hasPending) {
        pendingContainer.innerHTML = `
          <div class="empty-state">
            <span class="empty-icon">✨</span>
            <h3>Tudo em dia!</h3>
            <p>Você não tem letras pendentes.</p>
            <button class="btn btn-approve" onclick="openChat()" style="margin-top:20px;">Criar Nova Música</button>
          </div>
        `;
      }

      if (!hasApproved) {
        approvedContainer.innerHTML = `
          <div class="empty-state" style="padding:20px;">
            <p>Sem músicas em produção no momento.</p>
          </div>
        `;
      }

      if (!hasReceived) {
        receivedContainer.innerHTML = `
          <div class="empty-state" style="padding:20px;">
            <p>Sem músicas prontas no momento.</p>
          </div>
        `;
      }
    }

    // ✅ ALTERAÇÃO 4: FUNÇÃO EDITARDRAFT MODIFICADA
    function editarDraft(pedidoId) {
      console.log("📝 Abrindo editor para:", pedidoId);

      // ✅ Abre o modal
      openEditDraftModal(pedidoId);
    }

    async function irParaCheckout(pedidoId) {
      try {
        localStorage.setItem('tuneCraft_pendingOrderId', pedidoId);
        localStorage.setItem('tuneCraft_checkoutEmail', userData.email);
        localStorage.setItem('tuneCraft_checkoutName', userData.name);


        console.log("💳 Redirecionando para checkout:", pedidoId);
        showToast("Redirecionando para checkout...", "info");


        setTimeout(() => {
          window.location.href = 'checkout.html';
        }, 500);


      } catch (error) {
        console.error("Erro ao redirecionar:", error);
        showToast(`❌ Erro: ${error.message}`, "error");
      }
    }

    function abrirModalAlteracao(pedidoId) {
      currentAlterandoId = pedidoId;
      document.getElementById('alterarModal').classList.add('active');

      document.getElementById('mudancasDesejadas').value = '';
      document.getElementById('manterElementos').value = '';
      document.getElementById('observacoesFinais').value = '';
      document.getElementById('count1').innerText = '0';
      document.getElementById('count2').innerText = '0';
      document.getElementById('count3').innerText = '0';
    }

    function fecharAlterarModal() {
      document.getElementById('alterarModal').classList.remove('active');
      currentAlterandoId = null;
    }

    function updateAlterarCharCount(fieldId, countId) {
      const field = document.getElementById(fieldId);
      const count = field.value.length;
      document.getElementById(countId).innerText = count;
    }

    async function submitAlteracao() {
      const mudancas = document.getElementById('mudancasDesejadas').value.trim();
      const manter = document.getElementById('manterElementos').value.trim();
      const obs = document.getElementById('observacoesFinais').value.trim();

      if (mudancas.length < 20) {
        showToast("Por favor, descreva as mudanças com pelo menos 20 caracteres", "error");
        return;
      }

      if (manter.length < 10) {
        showToast("Por favor, especifique o que deve ser mantido (mínimo 10 caracteres)", "error");
        return;
      }

      const btn = document.getElementById('btnSubmitAlteracao');
      btn.disabled = true;
      btn.innerText = "Processando...";

      const sugestoes = `
MUDANÇAS DESEJADAS:
${mudancas}

ELEMENTOS QUE DEVEM PERMANECER:
${manter}

${obs ? `OBSERVAÇÕES ADICIONAIS:\n${obs}` : ''}
      `.trim();

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/alterar-letra`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            pedidoId: currentAlterandoId,
            sugestoes: sugestoes
          })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Erro ao processar alterações');
        }

        showToast("✅ Versão modificada criada! Compare as versões.", "");
        fecharAlterarModal();

        userData.orders = await loadOrdersFromSupabase();
        localStorage.setItem("tuneCraftUser", JSON.stringify(userData));
        renderSections();

      } catch (error) {
        showToast(`❌ Erro: ${error.message}`, "error");
        btn.disabled = false;
        btn.innerText = "Enviar Alterações ✨";
      }
    }

   async function aprovarLetraOriginal(pedidoId) {
  try {
    console.log("✅ Aprovando letra original e gerando áudio para:", pedidoId);

    if (!pedidoId) {
      showToast("❌ Erro: ID do pedido não encontrado", "error");
      return;
    }

    // ============================================
    // PASSO 1: Atualizar versao_escolhida no banco
    // ============================================

    console.log("📝 PASSO 1: Marcando versão como escolhida...");

    const { error: updateErr } = await sb
      .from("musicas_pedidos")
      .update({
        versao_escolhida: "original",
        versao_aprovada_tipo: "original",
      })
      .eq("id", pedidoId);

    if (updateErr) {
      console.error("❌ Erro ao marcar versão:", updateErr);
      showToast(`❌ Erro ao salvar: ${updateErr.message}`, "error");
      return;
    }

    console.log("✅ Versão marcada como original");

    // ============================================
    // PASSO 2: Gerar áudio chamando generate-audio
    // ============================================

    console.log("🎵 PASSO 2: Chamando generate-audio...");

    const btn = document.getElementById(`btn-${pedidoId}`);
    if (btn) {
      btn.disabled = true;
      btn.textContent = "⏳ Gerando áudio...";
    }

    showToast("🎵 Gerando áudio da música...", "info");

    // ✅ CERTIFIQUE-SE DE CHAMAR COM JSON VÁLIDO
    const response = await fetch(
      "https://miupzfchvfbqbznfhvix.supabase.co/functions/v1/generate-audio",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          pedido_id: pedidoId,  // ✅ KEY CORRETO!
        }),
      }
    );

    console.log("📤 Status da resposta:", response.status);

    // ============================================
    // VERIFICAR RESPOSTA
    // ============================================

    if (!response.ok) {
      const errorText = await response.text().catch(() => "Erro desconhecido");
      console.error("❌ Erro de resposta:", response.status, errorText);
      showToast(`❌ Erro ao gerar áudio: ${response.status}`, "error");

      if (btn) {
        btn.disabled = false;
        btn.textContent = "✅ Aprovar e Gerar Áudio";
      }
      return;
    }

    const result = await response.json().catch(() => ({}));
    console.log("✅ Resposta da geração:", result);

    // ============================================
    // SUCESSO
    // ============================================

    showToast("✅ Áudio enviado para produção! Você receberá em breve.", "success");

    setTimeout(() => {
      location.reload();
    }, 2000);

  } catch (error) {
    console.error("❌ ERRO em aprovarLetraOriginal:", error);
    showToast(`❌ ${error.message}`, "error");

    const btn = document.getElementById(`btn-${pedidoId}`);
    if (btn) {
      btn.disabled = false;
      btn.textContent = "✅ Aprovar e Gerar Áudio";
    }
  }
}
   async function aprovarVersao(pedidoId, tipo) {
  try {
    console.log(`✅ Aprovando versão ${tipo} para:`, pedidoId);

    if (!pedidoId || !tipo) {
      showToast("❌ Erro: Dados inválidos", "error");
      return;
    }

    const tipoNormalizado = tipo.toLowerCase();
    if (!["original", "modificada"].includes(tipoNormalizado)) {
      showToast("❌ Erro: Tipo de versão inválido", "error");
      return;
    }

    // ============================================
    // PASSO 1: Atualizar versao_escolhida
    // ============================================

    console.log("📝 PASSO 1: Marcando versão escolhida...");

    const { error: updateErr } = await sb
      .from("musicas_pedidos")
      .update({
        versao_escolhida: tipoNormalizado,
        versao_aprovada_tipo: tipoNormalizado,
        status: "production",
      })
      .eq("id", pedidoId);

    if (updateErr) {
      console.error("❌ Erro ao marcar versão:", updateErr);
      showToast(`❌ Erro ao salvar: ${updateErr.message}`, "error");
      return;
    }

    console.log("✅ Versão marcada como aprovada");

    // ============================================
    // PASSO 2: Gerar áudio
    // ============================================

    console.log("🎵 PASSO 2: Gerando áudio...");

    showToast("🎵 Gerando áudio da música...", "info");

    const response = await fetch(
      "https://miupzfchvfbqbznfhvix.supabase.co/functions/v1/generate-audio",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          pedido_id: pedidoId,
        }),
      }
    );

    console.log("📤 Status:", response.status);

    if (!response.ok) {
      const errorText = await response.text().catch(() => "Erro desconhecido");
      console.error("❌ Erro:", response.status, errorText);
      showToast(`❌ Erro ao gerar áudio: ${response.status}`, "error");
      return;
    }

    const result = await response.json().catch(() => ({}));
    console.log("✅ Áudio enviado:", result);

    showToast("✅ Música em produção! Você receberá em breve.", "success");

    setTimeout(() => {
      location.reload();
    }, 2000);

  } catch (error) {
    console.error("❌ ERRO em aprovarVersao:", error);
    showToast(`❌ ${error.message}`, "error");
  }
}

// ============================================
// VERIFICAÇÃO AO CARREGAR
// ============================================

document.addEventListener("DOMContentLoaded", function() {
  console.log("✅ Funções de aprovação carregadas");
  console.log("📍 URL generate-audio configurada como:");
  console.log("   https://miupzfchvfbqbznfhvix.supabase.co/functions/v1/generate-audio");
});

    function saveProfile() {
      const newName = document.getElementById("profName").value;
      const newPass = document.getElementById("profPass").value;

      userData.name = newName;
      if (newPass) userData.password = newPass;

      localStorage.setItem("tuneCraftUser", JSON.stringify(userData));

      document.getElementById("userName").innerText = newName.split(" ")[0];
      document.querySelector(".avatar").innerText = newName.charAt(0);

      showToast("✅ Perfil atualizado com sucesso!", "");
    }

    async function logout() {
      try {
        await sb.auth.signOut();
      } catch (e) {
        console.error("Erro ao deslogar:", e);
      }

      localStorage.removeItem("tuneCraftUser");
      window.location.href = "login.html";
    }
  </script>

  <!-- ✅ ALTERAÇÃO 3: JAVASCRIPT DO MODAL DE EDIÇÃO -->
  <script>
    function showEditDraftToast(message, type = 'info') {
      const toast = document.getElementById('editDraftToast');
      toast.innerText = message;
      toast.className = `edit-draft-toast ${type}`;
      toast.style.display = 'block';
      
      setTimeout(() => {
        toast.style.display = 'none';
      }, 4000);
    }

    // ============================================
// FUNÇÃO: Converter asked[] → campos editáveis
// ============================================

function convertAskedToEditFormat(asked) {
    /**
     * Transforma o array asked[] em objeto com step0, step1, step2...
     * Para compatibilidade com o formulário de edição
     */
    
    const result = {};
    
    if (!asked || !Array.isArray(asked)) {
        return result;
    }

    asked.forEach((item, index) => {
        // Cada item tem:
        // - fieldName: "recipient.name"
        // - answerValue: "Maria"
        
        // Para manter compatibilidade com step0, step1, step2...
        // Precisamos mapear o fieldName de volta para stepX
        
        const fieldName = item.fieldName; // ex: "recipient.name"
        const answerValue = item.answerValue;
        
        // Mapeamento: tema → step0, recipient.name → step2, etc
        const fieldToStepMap = {
            "ai_metadata.themeId": "step0",
            
            // Birthday
            "recipient.name": "step2",
            "ai_metadata.relationship": "step1",
            "lyricDetails.mainMessage": "step4",
            "ai_metadata.pov": "step3",
            "lyricDetails.specialMentions": "step5",
            "recipient.personality": "step6",
            "lyricDetails.secretDetail": "step7",
            "recipient.specialCharacteristics": "step8",
            "final.futureWish": "step9",
            "musicStyle.primaryGenre": "step10",
            "musicStyle.mood": "step11",
            "musicStyle.tempo": "step12",
            "lyricDetails.language": "step13",
            "productionDetails.vocalApproach": "step14",
            
            // Pregnancy announcement
            "ai_metadata.audience": "step1",
            "ai_metadata.narratorRole": "step2",
            "ai_metadata.pregnancyStage": "step3",
            "lyricDetails.scene": "step5",
            "lyricDetails.desiredImpact": "step6",
            "lyricDetails.symbolicDetail": "step7",
            "lyricDetails.announcementLine": "step8",
            "lyricDetails.avoid": "step9",
            
            // Love declaration
            "lyricDetails.origin": "step1",
            "lyricDetails.turningPoint": "step2",
            "lyricDetails.transformation": "step3",
            "lyricDetails.unsaid": "step4",
            "lyricDetails.simpleScene": "step5",
            "lyricDetails.withYouI": "step7",
        };
        
        const stepKey = fieldToStepMap[fieldName];
        
        if (stepKey) {
            result[stepKey] = answerValue;
        }
        
        // Adicionar também por índice original (segurança)
        result[`asked_${index}`] = {
            fieldName: fieldName,
            value: answerValue,
            question: item.question
        };
    });
    
    return result;
}
    
    async function openEditDraftModal(pedidoId) {
      editDraftCurrentPedidoId = pedidoId;
      const modal = document.getElementById('editDraftModal');
      modal.classList.add('active');
      
      await loadEditDraft(pedidoId);
    }

    function closeEditDraftModal() {
      const modal = document.getElementById('editDraftModal');
      modal.classList.remove('active');
      editDraftCurrentPedidoId = null;
    }

   async function loadEditDraft(pedidoId) {
    const loading = document.getElementById("editDraftLoading");
    const form = document.getElementById("editDraftForm");
    
    loading.style.display = "flex";
    form.style.display = "none";
    
    try {
        console.log("📥 Carregando draft:", pedidoId);
        
        const { data, error } = await sb
            .from("musicas_pedidos")
            .select()
            .eq("id", pedidoId)
            .single();
        
        if (error) throw error;
        
        const payload = data.payload;
        console.log("📊 Payload completo:", payload);
        console.log("📋 Array asked[]:", payload.asked);
        console.log("💾 Objeto answers{}:", payload.answers);
        
        document.getElementById("editDraftHeaderInfo").innerText = 
            `Criado em ${new Date(data.created_at).toLocaleDateString("pt-BR")}`;
        
        const asked = payload.asked || [];
        const answers = payload.answers || {};
        
        if (!asked || asked.length === 0) {
            throw new Error("Nenhuma resposta encontrada neste rascunho");
        }
        
        // ============================================
        // RENDERIZAR DINÂMICAMENTE A PARTIR DE asked[]
        // ============================================
        
        let formHTML = "";
        let currentSection = null;
        
        asked.forEach((item, index) => {
            // Agrupar por seção
            if (item.section !== currentSection) {
                currentSection = item.section;
                formHTML += `<div class="edit-draft-section-title">${currentSection}</div>`;
            }
            
            // Gerar ID único para o campo
            const fieldId = `edit_${item.fieldName.replace(/\./g, "_")}`;
            const fieldValue = item.answerValue || "";
            const labelText = item.question || item.fieldName;
            
            // Renderizar de acordo com o tipo
            formHTML += `
                <div class="edit-draft-form-group">
                    <label>${labelText}</label>
                    <div class="field-name">${item.fieldName}</div>
            `;
            
            // ✅ Se é um select com opções (dedu conforme answerValue)
            if (item.answerValue && 
                (item.fieldName.includes("themeId") || 
                 item.fieldName.includes("mood") || 
                 item.fieldName.includes("tempo") ||
                 item.fieldName.includes("genre") ||
                 item.fieldName.includes("audience") ||
                 item.fieldName.includes("narratorRole") ||
                 item.fieldName.includes("pregnancyStage") ||
                 item.fieldName.includes("language") ||
                 item.fieldName.includes("vocalApproach") ||
                 item.fieldName.includes("pov"))) {
                
                formHTML += renderSelectField(fieldId, item.fieldName, fieldValue);
            }
            // ✅ Se é textarea (longo)
            else if (item.answerValue && item.answerValue.length > 50) {
                formHTML += `
                    <textarea id="${fieldId}" rows="3">${escapeHtml(fieldValue)}</textarea>
                `;
            }
            // ✅ Default: input text
            else {
                formHTML += `
                    <input type="text" id="${fieldId}" value="${escapeHtml(fieldValue)}" />
                `;
            }
            
            formHTML += `</div>`;
        });
        
        // BOTÕES
        formHTML += `
            <div class="edit-draft-actions">
                <button type="button" class="edit-draft-btn edit-draft-btn-cancel" onclick="closeEditDraftModal()">Cancelar</button>
                <button type="button" class="edit-draft-btn edit-draft-btn-save" onclick="saveEditDraftDynamic()">Salvar Alterações</button>
            </div>
        `;
        
        form.innerHTML = formHTML;
        
        // Guardar dados originais para facilitar salvamento
        window.editDraftData = {
            pedidoId: pedidoId,
            asked: asked,
            answers: answers
        };
        
        loading.style.display = "none";
        form.style.display = "block";
        
    } catch (error) {
        console.error("❌ Erro ao carregar rascunho:", error);
        showEditDraftToast(`Erro: ${error.message}`, "error");
        closeEditDraftModal();
    }
}

    // ============================================
// HELPER: Renderizar select fields dinamicamente
// ============================================

function renderSelectField(fieldId, fieldName, currentValue) {
    const options = getOptionsForField(fieldName, currentValue);
    
    let html = `<select id="${fieldId}">`;
    options.forEach(opt => {
        const selected = currentValue === opt.value ? "selected" : "";
        html += `<option value="${opt.value}" ${selected}>${opt.label}</option>`;
    });
    html += `</select>`;
    
    return html;
}

// ============================================
// HELPER: Retornar opções de cada campo
// ============================================

function getOptionsForField(fieldName, currentValue) {
    if (fieldName.includes("themeId")) return FORM_OPTIONS.themes;
    if (fieldName.includes("mood")) return FORM_OPTIONS.moods;
    if (fieldName.includes("tempo")) return FORM_OPTIONS.tempos;
    if (fieldName.includes("genre") || fieldName.includes("Genre")) return FORM_OPTIONS.genres;
    if (fieldName.includes("audience")) return FORM_OPTIONS.audiences;
    if (fieldName.includes("narratorRole")) return FORM_OPTIONS.narratorRoles;
    if (fieldName.includes("pregnancyStage")) return FORM_OPTIONS.pregnancyStages;
    if (fieldName.includes("language")) return FORM_OPTIONS.languages;
    if (fieldName.includes("vocalApproach")) return FORM_OPTIONS.vocalApproaches;
    if (fieldName.includes("pov")) return FORM_OPTIONS.povs;
    if (fieldName.includes("ageGroup")) return FORM_OPTIONS.ageGroups;
    
    return [];
}

// ============================================
// HELPER: Escape HTML
// ============================================

function escapeHtml(str) {
    if (!str) return "";
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

    async function saveEditDraftDynamic() {
    if (!editDraftCurrentPedidoId || !window.editDraftData) return;
    
    const btn = document.querySelector(".edit-draft-btn-save");
    btn.disabled = true;
    btn.innerText = "Salvando...";
    
    try {
        console.log("💾 Salvando draft:", editDraftCurrentPedidoId);
        
        const originalAsked = window.editDraftData.asked;
        const updatedAnswers = {};
        
        // Iterar sobre CADA item respondido originalmente
        originalAsked.forEach((item) => {
            const fieldId = `edit_${item.fieldName.replace(/\./g, "_")}`;
            const inputElement = document.getElementById(fieldId);
            
            if (inputElement) {
                const newValue = inputElement.value || inputElement.textContent;
                
                // Organizar em estrutura de answers{}
                const parts = item.fieldName.split(".");
                if (parts.length === 2) {
                    const [parent, child] = parts;
                    if (!updatedAnswers[parent]) {
                        updatedAnswers[parent] = {};
                    }
                    updatedAnswers[parent][child] = newValue;
                } else {
                    updatedAnswers[item.fieldName] = newValue;
                }
                
                console.log(`✏️ ${item.fieldName} → ${newValue}`);
            }
        });
        
        console.log("📊 Answers atualizado:", updatedAnswers);
        
        // Salvar no Supabase
        const { error } = await sb
            .from("musicas_pedidos")
            .update({
                payload: {
                    form_id: "tc_chat_v2",
                    form_version: 2,
                    asked: originalAsked,  // Manter o asked original
                    answers: updatedAnswers,  // Atualizar answers
                    updated_at: new Date().toISOString()
                }
            })
            .eq("id", editDraftCurrentPedidoId);
        
        if (error) throw error;
        
        console.log("✅ Draft salvo!");
        showEditDraftToast("Rascunho atualizado com sucesso!", "success");
        closeEditDraftModal();
        
        // Recarregar dados
        userData.orders = await loadOrdersFromSupabase();
        localStorage.setItem("tuneCraftUser", JSON.stringify(userData));
        renderSections();
        
    } catch (error) {
        console.error("❌ Erro ao salvar:", error);
        showEditDraftToast(`Erro: ${error.message}`, "error");
        btn.disabled = false;
        btn.innerText = "Salvar Alterações";
    }
}
    
   
    // ============================================
// NOVA FUNÇÃO: saveEditDraftNew() - Salvar formato correto
// ============================================

async function saveEditDraftNew() {
    if (!editDraftCurrentPedidoId) return;
    
    const btn = document.querySelector(".edit-draft-btn-save");
    btn.disabled = true;
    btn.innerText = "Salvando...";
    
    try {
        console.log("💾 Salvando draft:", editDraftCurrentPedidoId);
        
        // Coletar dados do formulário
        const updatedAnswers = {
            ai_metadata: {
                themeId: document.getElementById("editStep0")?.value
            },
            recipient: {
                name: document.getElementById("editRecipientName")?.value
            },
            ai_metadata: {
                ...document.getElementById("editStep0") ? {themeId: document.getElementById("editStep0").value} : {},
                relationship: document.getElementById("editRelationship")?.value
            },
            lyricDetails: {
                mainMessage: document.getElementById("editMainMessage")?.value,
                scene: document.getElementById("editScene")?.value,
                secretDetail: document.getElementById("editSecretDetail")?.value
            },
            musicStyle: {
                primaryGenre: document.getElementById("editGenre")?.value,
                mood: document.getElementById("editMood")?.value,
                tempo: document.getElementById("editTempo")?.value
            }
        };
        
        // Remover campos undefined/vazios
        const cleanPayload = {};
        Object.keys(updatedAnswers).forEach(key => {
            if (updatedAnswers[key] && Object.keys(updatedAnswers[key]).length > 0) {
                cleanPayload[key] = updatedAnswers[key];
            }
        });
        
        console.log("📊 Payload atualizado:", cleanPayload);
        
        // Atualizar no Supabase
        const { error } = await sb
            .from("musicas_pedidos")
            .update({
                payload: cleanPayload
            })
            .eq("id", editDraftCurrentPedidoId);
        
        if (error) throw error;
        
        console.log("✅ Draft salvo!");
        showEditDraftToast("Rascunho atualizado com sucesso!", "success");
        closeEditDraftModal();
        
        // Recarregar dados
        userData.orders = await loadOrdersFromSupabase();
        localStorage.setItem("tuneCraftUser", JSON.stringify(userData));
        renderSections();
        
    } catch (error) {
        console.error("❌ Erro ao salvar:", error);
        showEditDraftToast(`Erro: ${error.message}`, "error");
        btn.disabled = false;
        btn.innerText = "Salvar Alteraes";
    }
}

  </script>
<script src="mobile-menu.js"></script>
</body>
</html>
























