<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Cliente | TuneCraft</title>
  <link rel="stylesheet" href="chat.css" />

  <!-- Supabase JS (apenas UMA vez) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f1f5f9; color: #1e293b;
      display: flex; height: 100vh; overflow: hidden;
    }

    /* SIDEBAR */
    .sidebar {
      width: 260px; background: #0a0e27; color: white;
      display: flex; flex-direction: column;
      padding: 20px; flex-shrink: 0;
    }

    .logo-container {
      margin-bottom: 40px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .menu-item {
      padding: 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer;
      transition: 0.3s; display: flex; align-items: center; gap: 10px; color: #94a3b8;
    }
    .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: white; }
    .menu-item.active { border-left: 3px solid #00d9ff; }

    .new-music-btn {
      margin-top: auto; background: linear-gradient(135deg, #00d9ff, #6366f1);
      color: white; padding: 15px; border-radius: 10px; text-align: center;
      text-decoration: none; font-weight: 700; transition: 0.3s;
      display: flex; justify-content: center; align-items: center; gap: 8px; cursor: pointer;
    }
    .new-music-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 217, 255, 0.3); }

    /* MAIN CONTENT */
    .main-content { flex: 1; overflow-y: auto; padding: 30px; position: relative; }

    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .user-profile { display: flex; align-items: center; gap: 10px; }
    .avatar { width: 40px; height: 40px; background: #e2e8f0; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #64748b; }

    .section { display: none; animation: fadeIn 0.3s; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* CARDS */
    .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; }
    .card-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; }
    .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }

    .status-pending { background: #fff7ed; color: #c2410c; }
    .status-production { background: #eff6ff; color: #1d4ed8; }
    .status-completed { background: #f0fdf4; color: #15803d; }
    .status-awaiting { background: #fef3c7; color: #92400e; }
    .status-draft { background: #fce7f3; color: #be185d; }

    .draft-summary {
      background: #f8fafc;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid #be185d;
    }

    .draft-summary p {
      margin: 8px 0;
      font-size: 0.95rem;
      color: #475569;
    }

    .draft-summary p strong {
      color: #1e293b;
    }

    .lyrics-box {
      font-family: 'Courier New', monospace; background: #f8fafc; padding: 20px;
      border-radius: 8px; border: 1px solid #cbd5e1; white-space: pre-wrap; margin: 15px 0; max-height: 300px; overflow-y: auto;
    }

    /* ‚úÖ COMPARA√á√ÉO LADO A LADO */
    .comparison-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    .version-card {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      background: #f8fafc;
    }

    .version-card.selected {
      border-color: #00d9ff;
      background: #eff6ff;
    }

    .version-card h4 {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .version-changelog {
      background: #fff7ed;
      border-left: 3px solid #f59e0b;
      padding: 10px;
      margin: 10px 0;
      font-size: 0.9rem;
      border-radius: 4px;
    }

    .action-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
    .btn-approve { background: #10b981; color: white; }
    .btn-approve:hover { background: #059669; }
    .btn-approve:disabled { background: #cbd5e1; cursor: not-allowed; }
    .btn-revise { background: white; border: 2px solid #f59e0b; color: #f59e0b; }
    .btn-revise:hover { background: #fef3c7; }
    .btn-revise:disabled { background: #f3f4f6; color: #9ca3af; border-color: #d1d5db; cursor: not-allowed; }
    .btn-download { background: #0f172a; color: white; display: inline-flex; align-items: center; gap: 5px; text-decoration: none; padding: 10px 14px; border-radius: 6px; }
    .btn-select { background: #00d9ff; color: white; width: 100%; margin-top: 10px; }

    /* PROFILE SECTION STYLES */
    .profile-form label { display: block; margin-top: 15px; font-weight: 600; font-size: 0.9rem; }
    .profile-form input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; margin-top: 5px; max-width: 400px; }
    .btn-save-profile { margin-top: 20px; background: #00d9ff; color: white; border:none; padding: 10px 25px; border-radius: 6px; cursor: pointer; font-weight: bold; }

    .empty-state { text-align: center; padding: 50px; color: #94a3b8; }
    .empty-icon { font-size: 3rem; margin-bottom: 10px; display: block; }

    .toast-message {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: none;
      z-index: 9999;
      animation: slideIn 0.3s;
    }

    .toast-message.error {
      background: #ef4444;
    }

    .toast-message.info {
      background: #3b82f6;
    }

    @keyframes slideIn {
      from { transform: translateX(400px); }
      to { transform: translateX(0); }
    }

    /* ‚úÖ MODAL DE ALTERA√á√ÉO */
    .alterar-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }

    .alterar-modal.active {
      display: flex;
    }

    .alterar-content {
      background: white;
      border-radius: 20px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 30px;
    }

    .alterar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .alterar-close {
      background: none;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      color: #64748b;
    }

    .alterar-step {
      margin-bottom: 20px;
    }

    .alterar-step h3 {
      margin-bottom: 10px;
      color: #1e293b;
    }

    .alterar-step textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      resize: vertical;
    }

    .alterar-step textarea:focus {
      outline: none;
      border-color: #00d9ff;
    }

    .char-count {
      text-align: right;
      font-size: 0.85rem;
      color: #94a3b8;
      margin-top: 5px;
    }

    .alterar-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn-alterar-cancel {
      flex: 1;
      padding: 12px;
      border: 2px solid #cbd5e1;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-alterar-submit {
      flex: 2;
      padding: 12px;
      border: none;
      background: linear-gradient(135deg, #00d9ff, #6366f1);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
    }

    .btn-alterar-submit:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      body { flex-direction: column; height: auto; }
      .sidebar { width: 100%; flex-direction: row; overflow-x: auto; padding: 10px; align-items: center; justify-content: space-between; }
      .menu-item span { display: none; }
      .new-music-btn { margin-top: 0; padding: 8px 15px; font-size: 0.8rem; }
      .main-content { padding: 20px; }
      .comparison-container { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- Chat Modal (criar nova m√∫sica) -->
  <div class="chat-modal" id="chatModal">
    <div class="chat-container">
      <div class="chat-header">
        <h2>üéµ Criar Nova M√∫sica</h2>
        <button class="close-chat" onclick="closeChat()">√ó</button>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-section" id="inputSection"></div>
    </div>
  </div>

  <!-- ‚úÖ Modal de Altera√ß√£o de Letra -->
  <div class="alterar-modal" id="alterarModal">
    <div class="alterar-content">
      <div class="alterar-header">
        <h2>‚úèÔ∏è Alterar Letra</h2>
        <button class="alterar-close" onclick="fecharAlterarModal()">√ó</button>
      </div>

      <div class="alterar-step">
        <h3>O que voc√™ gostaria de mudar na letra? üéµ</h3>
        <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 10px;">
          üí° Exemplos: "Tornar o refr√£o mais animado", "Adicionar men√ß√£o a Dourados", "Mudar o tom de rom√¢ntico para alegre"
        </p>
        <textarea 
          id="mudancasDesejadas" 
          placeholder="Ex: Gostaria que o refr√£o fosse mais energ√©tico e mencionasse nossa viagem para o Rio..."
          maxlength="500"
          oninput="updateAlterarCharCount('mudancasDesejadas', 'count1')"
        ></textarea>
        <div class="char-count"><span id="count1">0</span>/500</div>
      </div>

      <div class="alterar-step">
        <h3>H√° algo espec√≠fico que DEVE permanecer? üîí</h3>
        <textarea 
          id="manterElementos" 
          placeholder="Ex: Mantenha as refer√™ncias a Dourados e o nome 'Aline'..."
          maxlength="300"
          oninput="updateAlterarCharCount('manterElementos', 'count2')"
        ></textarea>
        <div class="char-count"><span id="count2">0</span>/300</div>
      </div>

      <div class="alterar-step">
        <h3>Observa√ß√µes finais sobre o tom ou estilo? üé® (Opcional)</h3>
        <textarea 
          id="observacoesFinais" 
          placeholder="Ex: Quero que seja mais emocionante, menos melanc√≥lica..."
          maxlength="200"
          oninput="updateAlterarCharCount('observacoesFinais', 'count3')"
        ></textarea>
        <div class="char-count"><span id="count3">0</span>/200</div>
      </div>

      <div class="alterar-buttons">
        <button class="btn-alterar-cancel" onclick="fecharAlterarModal()">Cancelar</button>
        <button class="btn-alterar-submit" id="btnSubmitAlteracao" onclick="submitAlteracao()">
          Enviar Altera√ß√µes ‚ú®
        </button>
      </div>
    </div>
  </div>

  <aside class="sidebar">
    <div class="logo-container">
      <img src="https://i.ibb.co/wFFzDMy9/tunecraft-logo-transparente.png" alt="TuneCraft" style="height: 50px;">
    </div>

    <nav style="flex: 1;">
      <div class="menu-item active" onclick="showSection('drafts', this)">
        üìã <span>Meus Rascunhos</span>
      </div>
      <div class="menu-item" onclick="showSection('pending', this)">
        üìù <span>Aprovar Letra</span>
      </div>
      <div class="menu-item" onclick="showSection('approved', this)">
        üéπ <span>Letras Aprovadas</span>
      </div>
      <div class="menu-item" onclick="showSection('received', this)">
        üéµ <span>M√∫sicas Recebidas</span>
      </div>
      <div class="menu-item" onclick="showSection('profile', this)">
        üë§ <span>Minha Conta</span>
      </div>
    </nav>

    <button class="new-music-btn" onclick="openChat()">
      + Nova M√∫sica
    </button>
  </aside>

  <main class="main-content">
    <div class="header">
      <h2 id="pageTitle">Meus Rascunhos</h2>
      <div class="user-profile">
        <span id="userName">Usu√°rio</span>
        <div class="avatar">U</div>
        <button onclick="logout()" style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:0.9rem; margin-left:10px;">Sair</button>
      </div>
    </div>

    <div id="drafts" class="section active"></div>

    <div id="pending" class="section"></div>

    <div id="approved" class="section">
      <h2>Em Produ√ß√£o</h2>
      <p style="color:#64748b; margin-bottom: 20px;">Nossos artistas est√£o gravando essas m√∫sicas agora.</p>
      <div id="approved-list"></div>
    </div>

    <div id="received" class="section">
      <h2>M√∫sicas Prontas</h2>
      <p style="color:#64748b; margin-bottom: 20px;">Baixe e compartilhe suas cria√ß√µes.</p>
      <div id="received-list"></div>
    </div>

    <div id="profile" class="section">
      <h2>Meus Dados</h2>
      <div class="card profile-form">
        <label>Nome Completo</label>
        <input type="text" id="profName">

        <label>Email</label>
        <input type="email" id="profEmail" readonly style="background:#f1f5f9; color:#64748b;">

        <label>Nova Senha (deixe em branco para manter)</label>
        <input type="password" id="profPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">

        <button class="btn-save-profile" onclick="saveProfile()">Salvar Altera√ß√µes</button>
      </div>
    </div>
  </main>

  <!-- Toast de notifica√ß√µes -->
  <div class="toast-message" id="toastMessage"></div>

  <!-- NOVO: Config Global -->
  <script src="config.js"></script>

  <!-- Chat JS (agora sem redeclara√ß√£o) -->
  <script src="chat.js?v=2026-02-30"></script>

 

  


  <script>
  //  const SUPABASE_URL = "https://miupzfchvfbqbznfhvix.supabase.co";
  // const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1pdXB6ZmNodmZicWJ6bmZodml4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxOTYwNzksImV4cCI6MjA4NDc3MjA3OX0.rz0W9qVovRvAeyBQ55LRewOAOM5a8pNJs1-UwWttATw";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let userData = JSON.parse(localStorage.getItem("tuneCraftUser")) || { name: "Visitante", email: "", user_id: null, orders: [] };
    let currentAlterandoId = null;

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toastMessage');
      toast.innerText = message;
      toast.className = `toast-message ${type}`;
      toast.style.display = 'block';
      
      setTimeout(() => {
        toast.style.display = 'none';
      }, 4000);
    }

    function normalizeStatus(s) {
      const v = (s || "").toLowerCase().replace(/\s+/g, "");
      if (v === "draft") return "draft";
      if (v === "pendingapproval" || v === "pending_approval" || v === "waiting_user_approval" || v === "waitinguserapproval") return "pending_approval";
      if (v === "aguardandoaprovacao" || v === "aguardando_aprovacao") return "aguardando_aprovacao";
      if (v === "production" || v === "inproduction" || v === "generatingaudio" || v === "generating_audio") return "production";
      if (v === "completed" || v === "done" || v === "received") return "completed";
      return v || "pending_approval";
    }

    function escapeHtml(str) {
      return (str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "'");
    }

    function extractSummaryFromPayload(payload) {
      return {
        recipient: payload.step2 || "Indefinido",
        ageGroup: payload.step3 || "N√£o especificado",
        occasion: payload.step6 || "N√£o definida",
        genre: payload.step8 || "N√£o definido",
        message: payload.step12 ? payload.step12.substring(0, 80) + "..." : "Sem mensagem"
      };
    }

    async function getSessionOrRedirect() {
      const { data, error } = await sb.auth.getSession();
      if (error) console.warn("getSession error:", error);

      const session = data?.session;
      if (!session?.access_token || !session?.user?.id) {
        window.location.href = "login.html";
        return null;
      }
      return session;
    }

    async function loadOrdersFromSupabase() {
      const { data, error } = await sb
        .from("musicas_pedidos")
        .select("id,title,lyrics,status,created_at,audio_urls,versao_original,versao_modificada,versao_aprovada,alteracao_usada,versao_aprovada_tipo,alteracao_solicitada,payload")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Erro sb.from(musicas_pedidos):", error);
        return [];
      }

      return (data || []).map(r => {
        let audioUrls = r.audio_urls;

        if (Array.isArray(audioUrls) && audioUrls.length > 0 && typeof audioUrls[0] === 'string') {
          try {
            audioUrls = audioUrls.map(url => JSON.parse(url));
          } catch (e) {
            console.error("‚ùå Erro ao fazer parse de audio_urls:", e);
            audioUrls = [];
          }
        }

        return {
          id: r.id,
          title: r.title || "Sem t√≠tulo",
          lyrics: r.lyrics || "",
          status: normalizeStatus(r.status),
          created_at: r.created_at,
          audio_urls: audioUrls,
          versao_original: r.versao_original,
          versao_modificada: r.versao_modificada,
          versao_aprovada: r.versao_aprovada,
          alteracao_usada: r.alteracao_usada,
          versao_aprovada_tipo: r.versao_aprovada_tipo,
          alteracao_solicitada: r.alteracao_solicitada,
          payload: r.payload
        };
      });
    }

    async function initDashboard() {
      const session = await getSessionOrRedirect();
      if (!session) return;

      const fullName = session.user.user_metadata?.full_name || userData.name || "Usu√°rio";
      userData.name = fullName;
      userData.email = session.user.email || userData.email || "";
      userData.user_id = session.user.id;

      const orders = await loadOrdersFromSupabase();
      userData.orders = orders;

      localStorage.setItem("tuneCraftUser", JSON.stringify(userData));

      document.getElementById("userName").innerText = userData.name.split(" ")[0];
      document.querySelector(".avatar").innerText = userData.name.charAt(0);

      document.getElementById("profName").value = userData.name;
      document.getElementById("profEmail").value = userData.email;

      renderSections();
    }

    initDashboard();

    function showSection(id, element) {
      if (element) {
        document.querySelectorAll(".menu-item").forEach(i => i.classList.remove("active"));
        element.classList.add("active");
      }

      const titles = {
        drafts: "Meus Rascunhos",
        pending: "Aprovar Letra",
        approved: "Letras Aprovadas",
        received: "M√∫sicas Recebidas",
        profile: "Minha Conta"
      };
      document.getElementById("pageTitle").innerText = titles[id] || "Painel";

      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    function renderSections() {
      const draftsContainer = document.getElementById("drafts");
      const pendingContainer = document.getElementById("pending");
      const approvedContainer = document.getElementById("approved-list");
      const receivedContainer = document.getElementById("received-list");

      draftsContainer.innerHTML = "";
      pendingContainer.innerHTML = "";
      approvedContainer.innerHTML = "";
      receivedContainer.innerHTML = "";

      let hasDrafts = false;
      let hasPending = false;
      let hasApproved = false;
      let hasReceived = false;

      if (userData.orders && userData.orders.length > 0) {
        userData.orders.forEach(order => {
          const title = escapeHtml(order.title);
          const lyrics = escapeHtml(order.lyrics);

          // ‚úÖ NOVA SE√á√ÉO: DRAFTS (status='draft')
          if (order.status === "draft") {
            hasDrafts = true;
            const summary = extractSummaryFromPayload(order.payload);
            
            draftsContainer.innerHTML += `
              <div class="card draft-card">
                <div class="card-header">
                  <h3>üéµ M√∫sica para: ${summary.recipient}</h3>
                  <span class="status-badge status-draft">Rascunho</span>
                </div>
                
                <div class="draft-summary">
                  <p><strong>Para:</strong> ${summary.recipient} (${summary.ageGroup})</p>
                  <p><strong>Ocasi√£o:</strong> ${summary.occasion}</p>
                  <p><strong>G√™nero:</strong> ${summary.genre}</p>
                  <p><strong>Mensagem:</strong> "${summary.message}"</p>
                </div>
                
                <div class="action-row">
                  <button class="btn btn-revise" onclick="editarDraft('${order.id}')">
                    ‚úèÔ∏è Editar Formul√°rio
                  </button>
                  <button class="btn btn-approve" onclick="irParaCheckout('${order.id}')">
                    üí≥ Pagar e Gerar Letra (R$ 49,90)
                  </button>
                </div>
              </div>
            `;
          }
          else if (order.status === "pending_approval" && !order.versao_modificada) {
            hasPending = true;
            const podeAlterar = !order.alteracao_usada;
            
            pendingContainer.innerHTML += `
              <div class="card">
                <div class="card-header">
                  <h3>${title}</h3>
                  <span class="status-badge status-pending">Aguardando Aprova√ß√£o</span>
                </div>
                <p style="font-size:0.9rem; color:#64748b;">Leia a letra gerada abaixo.</p>
                <div class="lyrics-box">${lyrics}</div>
                <div class="action-row">
                  <button 
                    class="btn btn-revise" 
                    onclick="abrirModalAlteracao('${order.id}')"
                    ${!podeAlterar ? 'disabled title="Altera√ß√£o j√° foi usada"' : ''}
                  >
                    ${podeAlterar ? '‚úèÔ∏è Solicitar Altera√ß√£o (1x)' : 'üîí Altera√ß√£o Usada'}
                  </button>
                  <button class="btn btn-approve" id="btn-${order.id}" onclick="aprovarLetraOriginal('${order.id}')">
                    ‚úÖ Aprovar e Gerar √Åudio
                  </button>
                </div>
              </div>
            `;
          }
          else if (order.status === "aguardando_aprovacao" && order.versao_modificada) {
            hasPending = true;
            
            const versaoOriginal = order.versao_original || { customer_lyrics: order.lyrics };
            const versaoModificada = order.versao_modificada;

            pendingContainer.innerHTML += `
              <div class="card">
                <div class="card-header">
                  <h3>${title}</h3>
                  <span class="status-badge status-awaiting">Escolha uma Vers√£o</span>
                </div>
                
                <p style="font-size:0.9rem; color:#64748b; margin-bottom: 15px;">
                  Compare as duas vers√µes e escolha sua favorita:
                </p>

                ${versaoModificada.changelog ? `
                  <div class="version-changelog">
                    <strong>üìù O que foi alterado:</strong><br>
                    ${escapeHtml(versaoModificada.changelog)}
                  </div>
                ` : ''}

                <div class="comparison-container">
                  <div class="version-card">
                    <h4>üìÑ Vers√£o Original</h4>
                    <div class="lyrics-box" style="max-height: 250px;">
                      ${escapeHtml(versaoOriginal.customer_lyrics || versaoOriginal.lyrics)}
                    </div>
                    <button class="btn btn-select" onclick="aprovarVersao('${order.id}', 'original')">
                      ‚úÖ Escolher Esta
                    </button>
                  </div>

                  <div class="version-card">
                    <h4>‚ú® Vers√£o Modificada</h4>
                    <div class="lyrics-box" style="max-height: 250px;">
                      ${escapeHtml(versaoModificada.customer_lyrics)}
                    </div>
                    <button class="btn btn-select" onclick="aprovarVersao('${order.id}', 'modificada')">
                      ‚úÖ Escolher Esta
                    </button>
                  </div>
                </div>
              </div>
            `;
          }
          else if (order.status === "production") {
            hasApproved = true;
            approvedContainer.innerHTML += `
              <div class="card">
                <div class="card-header">
                  <h3>${title}</h3>
                  <span class="status-badge status-production">Em Produ√ß√£o</span>
                </div>
                <p>Letra aprovada! Estamos trabalhando no √°udio.</p>
              </div>
            `;
          }
          else if (order.status === "completed") {
            hasReceived = true;
            const urls = Array.isArray(order.audio_urls) ? order.audio_urls : [];

            receivedContainer.innerHTML += `
              <div class="card">
                <div class="card-header">
                  <h3>${title}</h3>
                  <span class="status-badge status-completed">Pronta</span>
                </div>

                ${
                  urls.length >= 2
                    ? `
                      <strong>üéß Vers√£o A</strong>
                      <audio controls src="${urls[0].audio_url || urls[0]}" style="width:100%; margin:10px 0;"></audio>

                      <strong>üéß Vers√£o B</strong>
                      <audio controls src="${urls[1].audio_url || urls[1]}" style="width:100%; margin:10px 0;"></audio>

                      <div class="action-row" style="margin-top:10px">
                        <a class="btn btn-download" href="${urls[0].audio_url || urls[0]}" download>‚¨áÔ∏è Baixar A</a>
                        <a class="btn btn-download" href="${urls[1].audio_url || urls[1]}" download>‚¨áÔ∏è Baixar B</a>
                      </div>
                    `
                    : urls.length === 1
                    ? `
                      <strong>üéß √Åudio</strong>
                      <audio controls src="${urls[0].audio_url || urls[0]}" style="width:100%; margin:10px 0;"></audio>
                      <a class="btn btn-download" href="${urls[0].audio_url || urls[0]}" download>‚¨áÔ∏è Baixar</a>
                    `
                    : `<p>Sua m√∫sica foi finalizada e est√° sendo preparada para audi√ß√£o.</p>`
                }
              </div>
            `;
          }
        });
      }

      if (!hasDrafts) {
        draftsContainer.innerHTML = `
          <div class="empty-state">
            <span class="empty-icon">üìã</span>
            <h3>Sem rascunhos no momento</h3>
            <p>Crie uma nova m√∫sica para come√ßar!</p>
            <button class="btn btn-approve" onclick="openChat()" style="margin-top:20px;">Criar Nova M√∫sica</button>
          </div>
        `;
      }

      if (!hasPending) {
        pendingContainer.innerHTML = `
          <div class="empty-state">
            <span class="empty-icon">‚ú®</span>
            <h3>Tudo em dia!</h3>
            <p>Voc√™ n√£o tem letras pendentes.</p>
            <button class="btn btn-approve" onclick="openChat()" style="margin-top:20px;">Criar Nova M√∫sica</button>
          </div>
        `;
      }

      if (!hasApproved) {
        approvedContainer.innerHTML = `
          <div class="empty-state" style="padding:20px;">
            <p>Sem m√∫sicas em produ√ß√£o no momento.</p>
          </div>
        `;
      }

      if (!hasReceived) {
        receivedContainer.innerHTML = `
          <div class="empty-state" style="padding:20px;">
            <p>Sem m√∫sicas prontas no momento.</p>
          </div>
        `;
      }
    }

   async function editarDraft(pedidoId) {
  try {
    showToast("‚è≥ Abrindo editor...", "info");
    setTimeout(() => {
      window.location.href = `edit-draft.html?id=${pedidoId}`;
    }, 500);
  } catch (error) {
    console.error("Erro:", error);
    showToast(`‚ùå Erro: ${error.message}`, "error");
  }
}

    // ‚úÖ NOVA FUN√á√ÉO: IR PARA CHECKOUT
    async function irParaCheckout(pedidoId) {
      try {
        // Salva no localStorage para checkout.html
        localStorage.setItem('tuneCraft_pendingOrderId', pedidoId);
        localStorage.setItem('tuneCraft_checkoutEmail', userData.email);
        localStorage.setItem('tuneCraft_checkoutName', userData.name);

        console.log("üí≥ Redirecionando para checkout:", pedidoId);
        showToast("Redirecionando para checkout...", "info");

        // Redireciona
        setTimeout(() => {
          window.location.href = 'checkout.html';
        }, 500);

      } catch (error) {
        console.error("Erro ao redirecionar:", error);
        showToast(`‚ùå Erro: ${error.message}`, "error");
      }
    }

    function abrirModalAlteracao(pedidoId) {
      currentAlterandoId = pedidoId;
      document.getElementById('alterarModal').classList.add('active');
      
      document.getElementById('mudancasDesejadas').value = '';
      document.getElementById('manterElementos').value = '';
      document.getElementById('observacoesFinais').value = '';
      document.getElementById('count1').innerText = '0';
      document.getElementById('count2').innerText = '0';
      document.getElementById('count3').innerText = '0';
    }

    function fecharAlterarModal() {
      document.getElementById('alterarModal').classList.remove('active');
      currentAlterandoId = null;
    }

    function updateAlterarCharCount(fieldId, countId) {
      const field = document.getElementById(fieldId);
      const count = field.value.length;
      document.getElementById(countId).innerText = count;
    }

    async function submitAlteracao() {
      const mudancas = document.getElementById('mudancasDesejadas').value.trim();
      const manter = document.getElementById('manterElementos').value.trim();
      const obs = document.getElementById('observacoesFinais').value.trim();

      if (mudancas.length < 20) {
        showToast("Por favor, descreva as mudan√ßas com pelo menos 20 caracteres", "error");
        return;
      }

      if (manter.length < 10) {
        showToast("Por favor, especifique o que deve ser mantido (m√≠nimo 10 caracteres)", "error");
        return;
      }

      const btn = document.getElementById('btnSubmitAlteracao');
      btn.disabled = true;
      btn.innerText = "Processando...";

      const sugestoes = `
MUDAN√áAS DESEJADAS:
${mudancas}

ELEMENTOS QUE DEVEM PERMANECER:
${manter}

${obs ? `OBSERVA√á√ïES ADICIONAIS:\n${obs}` : ''}
      `.trim();

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/alterar-letra`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            pedidoId: currentAlterandoId,
            sugestoes: sugestoes
          })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Erro ao processar altera√ß√µes');
        }

        showToast("‚úÖ Vers√£o modificada criada! Compare as vers√µes.", "");
        fecharAlterarModal();

        userData.orders = await loadOrdersFromSupabase();
        localStorage.setItem("tuneCraftUser", JSON.stringify(userData));
        renderSections();

      } catch (error) {
        showToast(`‚ùå Erro: ${error.message}`, "error");
        btn.disabled = false;
        btn.innerText = "Enviar Altera√ß√µes ‚ú®";
      }
    }

    async function aprovarLetraOriginal(id) {
      if (!confirm("Aprovar esta letra e iniciar gera√ß√£o de √°udio?")) return;

      const btn = document.getElementById(`btn-${id}`);
      if (btn) {
        btn.disabled = true;
        btn.innerText = "Processando...";
      }

      try {
        const { error: updateError } = await sb
          .from("musicas_pedidos")
          .update({ 
            status: "production",
            versao_aprovada: sb.from("musicas_pedidos").select("versao_original").eq("id", id).single()
          })
          .eq("id", id);

        if (updateError) {
          console.error("‚ùå Erro ao atualizar:", updateError);
          showToast("‚ùå Erro ao atualizar status", "error");
          if (btn) {
            btn.disabled = false;
            btn.innerText = "‚úÖ Aprovar e Gerar √Åudio";
          }
          return;
        }

        showToast("‚úÖ Letra aprovada! Iniciando gera√ß√£o...", "info");

        const response = await fetch(`${SUPABASE_URL}/functions/v1/generate-audio`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pedido_id: id })
        });

        if (!response.ok) {
          throw new Error(`Erro ao gerar √°udio: ${response.status}`);
        }

        const result = await response.json();
        showToast(`‚úÖ √Åudio em gera√ß√£o! Task: ${result.task_id}`, "");

        userData.orders = await loadOrdersFromSupabase();
        localStorage.setItem("tuneCraftUser", JSON.stringify(userData));
        renderSections();
        showSection("approved", document.querySelectorAll(".menu-item")[2]);

      } catch (error) {
        showToast(`‚ùå Erro: ${error.message}`, "error");
        if (btn) {
          btn.disabled = false;
          btn.innerText = "‚úÖ Aprovar e Gerar √Åudio";
        }
      }
    }

    async function aprovarVersao(pedidoId, tipoVersao) {
      if (!confirm(`Aprovar vers√£o ${tipoVersao} e iniciar gera√ß√£o de √°udio?`)) return;

      showToast("‚è≥ Salvando escolha...", "info");

      try {
        console.log("üì§ Enviando:", { pedidoId, versaoEscolhida: tipoVersao });

        const response = await fetch(`${SUPABASE_URL}/functions/v1/aprovar-versao`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            pedidoId: pedidoId,
            versaoEscolhida: tipoVersao
          })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Erro ao aprovar vers√£o');
        }

        console.log("‚úÖ Vers√£o aprovada:", result);
        showToast("‚úÖ Vers√£o aprovada! Iniciando √°udio...", "");

        const audioResponse = await fetch(`${SUPABASE_URL}/functions/v1/generate-audio`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            pedido_id: pedidoId
          })
        });

        if (!audioResponse.ok) {
          throw new Error('Erro ao iniciar gera√ß√£o de √°udio');
        }

        const audioResult = await audioResponse.json();
        console.log("‚úÖ √Åudio gerado:", audioResult);
        showToast(`‚úÖ √Åudio em gera√ß√£o! Task: ${audioResult.task_id}`, "");

        userData.orders = await loadOrdersFromSupabase();
        localStorage.setItem("tuneCraftUser", JSON.stringify(userData));
        renderSections();
        showSection("approved", document.querySelectorAll(".menu-item")[2]);

      } catch (error) {
        console.error("‚ùå Erro completo:", error);
        showToast(`‚ùå ${error.message}`, "error");
      }
    }

    function saveProfile() {
      const newName = document.getElementById("profName").value;
      const newPass = document.getElementById("profPass").value;

      userData.name = newName;
      if (newPass) userData.password = newPass;

      localStorage.setItem("tuneCraftUser", JSON.stringify(userData));

      document.getElementById("userName").innerText = newName.split(" ")[0];
      document.querySelector(".avatar").innerText = newName.charAt(0);

      showToast("‚úÖ Perfil atualizado com sucesso!", "");
    }

    async function logout() {
      try {
        await sb.auth.signOut();
      } catch (e) {
        console.error("Erro ao deslogar:", e);
      }

      localStorage.removeItem("tuneCraftUser");
      window.location.href = "login.html";
    }
  </script>
</body>
</html>










