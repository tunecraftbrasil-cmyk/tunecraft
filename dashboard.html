<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Cliente | TuneCraft</title>
  <link rel="stylesheet" href="chat.css" />

  <!-- Supabase JS (apenas UMA vez) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f1f5f9; color: #1e293b;
      display: flex; height: 100vh; overflow: hidden;
    }

    /* SIDEBAR */
    .sidebar {
      width: 260px; background: #0a0e27; color: white;
      display: flex; flex-direction: column;
      padding: 20px; flex-shrink: 0;
      overflow: hidden;
    }

    .logo-container {
      margin-bottom: 40px;
      display: flex;
      align-items: center;
      gap: 10px;
      min-height: 50px;
    }

    .menu-item {
      padding: 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer;
      transition: 0.3s; display: flex; align-items: center; gap: 10px; color: #94a3b8;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: white; }
    .menu-item.active { border-left: 3px solid #00d9ff; }

    .new-music-btn {
      margin-top: auto; background: linear-gradient(135deg, #00d9ff, #6366f1);
      color: white; padding: 15px; border-radius: 10px; text-align: center;
      text-decoration: none; font-weight: 700; transition: 0.3s;
      display: flex; justify-content: center; align-items: center; gap: 8px; cursor: pointer;
      border: none;
    }
    .new-music-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 217, 255, 0.3); }

    /* MAIN CONTENT */
    .main-content { flex: 1; overflow-y: auto; padding: 30px; position: relative; min-width: 0; }

    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; gap: 12px; flex-wrap: wrap; }
    .user-profile { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .avatar { width: 40px; height: 40px; background: #e2e8f0; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #64748b; flex: 0 0 auto; }

    .section { display: none; animation: fadeIn 0.3s; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* CARDS */
    .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; }
    .card-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; gap: 10px; flex-wrap: wrap; }
    .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }

    .status-pending { background: #fff7ed; color: #c2410c; }
    .status-production { background: #eff6ff; color: #1d4ed8; }
    .status-completed { background: #f0fdf4; color: #15803d; }
    .status-awaiting { background: #fef3c7; color: #92400e; }
    .status-draft { background: #fce7f3; color: #be185d; }

    .draft-summary {
      background: #f8fafc;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid #be185d;
    }

    .draft-summary p {
      margin: 8px 0;
      font-size: 0.95rem;
      color: #475569;
      word-break: break-word;
    }

    .draft-summary p strong {
      color: #1e293b;
    }

    .lyrics-box {
      font-family: 'Courier New', monospace; background: #f8fafc; padding: 20px;
      border-radius: 8px; border: 1px solid #cbd5e1; white-space: pre-wrap; margin: 15px 0; max-height: 300px; overflow-y: auto;
      word-break: break-word;
    }

    /* ‚úÖ COMPARA√á√ÉO LADO A LADO */
    .comparison-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
      min-width: 0;
    }

    .version-card {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      background: #f8fafc;
      min-width: 0;
    }

    .version-card.selected {
      border-color: #00d9ff;
      background: #eff6ff;
    }

    .version-card h4 {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .version-changelog {
      background: #fff7ed;
      border-left: 3px solid #f59e0b;
      padding: 10px;
      margin: 10px 0;
      font-size: 0.9rem;
      border-radius: 4px;
      word-break: break-word;
    }

    .action-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
    .btn-approve { background: #10b981; color: white; }
    .btn-approve:hover { background: #059669; }
    .btn-approve:disabled { background: #cbd5e1; cursor: not-allowed; }
    .btn-revise { background: white; border: 2px solid #f59e0b; color: #f59e0b; }
    .btn-revise:hover { background: #fef3c7; }
    .btn-revise:disabled { background: #f3f4f6; color: #9ca3af; border-color: #d1d5db; cursor: not-allowed; }
    .btn-download { background: #0f172a; color: white; display: inline-flex; align-items: center; gap: 5px; text-decoration: none; padding: 10px 14px; border-radius: 6px; }
    .btn-select { background: #00d9ff; color: white; width: 100%; margin-top: 10px; }

    /* PROFILE SECTION STYLES */
    .profile-form label { display: block; margin-top: 15px; font-weight: 600; font-size: 0.9rem; }
    .profile-form input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; margin-top: 5px; max-width: 400px; }
    .btn-save-profile { margin-top: 20px; background: #00d9ff; color: white; border:none; padding: 10px 25px; border-radius: 6px; cursor: pointer; font-weight: bold; }

    .empty-state { text-align: center; padding: 50px; color: #94a3b8; }
    .empty-icon { font-size: 3rem; margin-bottom: 10px; display: block; }

    .toast-message {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: none;
      z-index: 9999;
      animation: slideIn 0.3s;
      max-width: calc(100vw - 40px);
      word-break: break-word;
    }

    .toast-message.error { background: #ef4444; }
    .toast-message.info { background: #3b82f6; }

    @keyframes slideIn {
      from { transform: translateX(400px); }
      to { transform: translateX(0); }
    }

    /* ‚úÖ MODAL DE ALTERA√á√ÉO */
    .alterar-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .alterar-modal.active { display: flex; }

    .alterar-content {
      background: white;
      border-radius: 20px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 30px;
    }

    .alterar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 10px;
    }

    .alterar-close {
      background: none;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      color: #64748b;
      line-height: 1;
    }

    .alterar-step { margin-bottom: 20px; }
    .alterar-step h3 { margin-bottom: 10px; color: #1e293b; }

    .alterar-step textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      resize: vertical;
    }

    .alterar-step textarea:focus {
      outline: none;
      border-color: #00d9ff;
    }

    .char-count {
      text-align: right;
      font-size: 0.85rem;
      color: #94a3b8;
      margin-top: 5px;
    }

    .alterar-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .btn-alterar-cancel {
      flex: 1;
      padding: 12px;
      border: 2px solid #cbd5e1;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      min-width: 180px;
    }

    .btn-alterar-submit {
      flex: 2;
      padding: 12px;
      border: none;
      background: linear-gradient(135deg, #00d9ff, #6366f1);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      min-width: 220px;
    }

    .btn-alterar-submit:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
    }

    /* ========== MODAL DE EDI√á√ÉO DE RASCUNHO ========== */
    .edit-draft-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
    }

    .edit-draft-modal.active { display: flex; }

    .edit-draft-content {
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideInUp 0.3s ease;
    }

    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .edit-draft-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e2e8f0;
      gap: 12px;
      flex-wrap: wrap;
    }

    .edit-draft-header h2 {
      color: #1e293b;
      font-size: 24px;
      margin: 0;
    }

    .edit-draft-header-info {
      font-size: 0.85rem;
      color: #64748b;
      margin-top: 6px;
    }

    .edit-draft-close {
      background: none;
      border: none;
      font-size: 28px;
      color: #64748b;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 0.2s;
      line-height: 1;
    }

    .edit-draft-close:hover { color: #1e293b; }

    .edit-draft-section-title {
      font-size: 16px;
      font-weight: 700;
      color: #1e293b;
      margin-top: 25px;
      margin-bottom: 15px;
      padding: 10px 0;
      border-bottom: 2px solid #e2e8f0;
    }

    .edit-draft-form-group {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #00d9ff;
    }

    .edit-draft-form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #1e293b;
      font-size: 0.9rem;
    }

    .edit-draft-form-group .field-name {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-bottom: 5px;
      font-family: monospace;
      word-break: break-word;
    }

    .edit-draft-form-group input,
    .edit-draft-form-group textarea,
    .edit-draft-form-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid #cbd5e1;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: 0.2s;
      min-width: 0;
    }

    .edit-draft-form-group input:focus,
    .edit-draft-form-group textarea:focus,
    .edit-draft-form-group select:focus {
      outline: none;
      border-color: #00d9ff;
      box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
    }

    .edit-draft-form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .edit-draft-references {
      display: grid;
      gap: 10px;
    }

    .edit-draft-reference-item {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .edit-draft-reference-item input {
      padding: 10px;
      border: 2px solid #cbd5e1;
      border-radius: 6px;
      font-size: 13px;
      min-width: 0;
    }

    .edit-draft-actions {
      display: flex;
      gap: 12px;
      margin-top: 30px;
      padding-top: 25px;
      border-top: 2px solid #e2e8f0;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .edit-draft-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: 0.3s;
      font-size: 14px;
    }

    .edit-draft-btn-cancel {
      background: white;
      border: 2px solid #cbd5e1;
      color: #64748b;
    }

    .edit-draft-btn-cancel:hover {
      background: #f1f5f9;
      border-color: #94a3b8;
    }

    .edit-draft-btn-save {
      background: linear-gradient(135deg, #00d9ff, #6366f1);
      color: white;
    }

    .edit-draft-btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 217, 255, 0.3);
    }

    .edit-draft-btn-save:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
      transform: none;
    }

    .edit-draft-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      font-size: 16px;
      color: #94a3b8;
    }

    .edit-draft-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 14px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: none;
      z-index: 10001;
      animation: slideInRight 0.3s;
      max-width: calc(100vw - 40px);
      word-break: break-word;
    }

    .edit-draft-toast.error { background: #ef4444; }
    .edit-draft-toast.info { background: #3b82f6; }

    @keyframes slideInRight {
      from { transform: translateX(400px); }
      to { transform: translateX(0); }
    }

    /* ===============================
       ‚úÖ RESPONSIVO (MOBILE + TABLET)
       - Sem mexer em JS / fun√ß√µes
       - Apenas ajustes de layout/UX
    =============================== */

    /* Tablet: melhora leitura e quebra */
    @media (max-width: 1024px) {
      .main-content { padding: 22px; }
      .card { padding: 20px; }
      .sidebar { width: 240px; }
    }

    /* Mobile: vira barra fixa inferior + FAB para ‚ÄúNova M√∫sica‚Äù */
    @media (max-width: 768px) {
      body { flex-direction: column; height: 100vh; }

      /* Sidebar vira bottom-nav */
      .sidebar {
        width: 100%;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        gap: 10px;

        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        height: 74px;
        z-index: 9998;

        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
      }

      /* Esconde logo no mobile para dar espa√ßo */
      .logo-container { display: none; }

      /* Menus em linha com √≠cone + texto pequeno */
      .sidebar nav {
        flex: 1;
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: flex-start;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-right: 54px; /* espa√ßo pro bot√£o flutuante */
      }

      .menu-item {
        margin-bottom: 0;
        padding: 10px 12px;
        border-radius: 10px;
        white-space: nowrap;
        gap: 8px;
        font-size: 0.92rem;
        flex: 0 0 auto;
      }

      /* Mant√©m texto vis√≠vel no mobile (mais us√°vel) */
      .menu-item span { display: inline; }

      /* Remove borda lateral no bottom-nav e usa destaque por fundo */
      .menu-item.active { border-left: none; outline: 2px solid rgba(0,217,255,0.35); }

      /* Bot√£o ‚ÄúNova M√∫sica‚Äù vira floating action button */
      .new-music-btn {
        margin-top: 0;
        padding: 0;
        width: 52px;
        height: 52px;
        border-radius: 999px;
        position: fixed;
        right: 14px;
        bottom: 92px; /* acima da barra */
        z-index: 9999;
        box-shadow: 0 14px 28px rgba(0, 217, 255, 0.22);
      }
      .new-music-btn::before {
        content: "+";
        font-size: 28px;
        line-height: 1;
        font-weight: 800;
      }
      .new-music-btn:hover { transform: none; }

      /* Conte√∫do ganha padding inferior pra n√£o ficar sob a barra */
      .main-content {
        padding: 18px;
        padding-bottom: 105px; /* espa√ßo da barra + conforto */
        height: 100vh;
        overflow-y: auto;
      }

      .header { margin-bottom: 18px; }
      .header h2 { font-size: 1.15rem; }
      .avatar { width: 36px; height: 36px; }

      /* Cards e bot√µes mais confort√°veis */
      .card { padding: 18px; }
      .btn { width: 100%; justify-content: center; }
      .action-row { gap: 10px; }
      .btn-download { width: 100%; justify-content: center; }

      /* Compara√ß√£o j√° empilha, mas refor√ßa espa√ßamentos */
      .comparison-container { grid-template-columns: 1fr; gap: 14px; }
      .lyrics-box { max-height: 260px; padding: 14px; }

      /* Modais: mais compactos no mobile */
      .alterar-content { width: 100%; padding: 18px; border-radius: 16px; }
      .edit-draft-content { padding: 18px; border-radius: 14px; }

      /* Refer√™ncias em 1 coluna no mobile */
      .edit-draft-reference-item { grid-template-columns: 1fr; }
      .btn-alterar-cancel, .btn-alterar-submit { min-width: 0; width: 100%; }
    }

    /* Mobile pequeno: melhora ainda mais (‚â§ 420px) */
    @media (max-width: 420px) {
      .menu-item { padding: 9px 10px; font-size: 0.88rem; }
      .sidebar { height: 70px; }
      .new-music-btn { width: 50px; height: 50px; right: 12px; bottom: 88px; }
      .main-content { padding: 14px; padding-bottom: 102px; }
      .card-header h3 { font-size: 1.02rem; }
    }
  </style>

</head>
<body>

  <!-- Chat Modal (criar nova m√∫sica) -->
  <div class="chat-modal" id="chatModal">
    <div class="chat-container">
      <div class="chat-header">
        <h2>üéµ Criar Nova M√∫sica</h2>
        <button class="close-chat" onclick="closeChat()">√ó</button>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-section" id="inputSection"></div>
    </div>
  </div>

  <!-- ‚úÖ Modal de Altera√ß√£o de Letra -->
  <div class="alterar-modal" id="alterarModal">
    <div class="alterar-content">
      <div class="alterar-header">
        <h2>‚úèÔ∏è Alterar Letra</h2>
        <button class="alterar-close" onclick="fecharAlterarModal()">√ó</button>
      </div>

      <div class="alterar-step">
        <h3>O que voc√™ gostaria de mudar na letra? üéµ</h3>
        <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 10px;">
          üí° Exemplos: "Tornar o refr√£o mais animado", "Adicionar men√ß√£o a Dourados", "Mudar o tom de rom√¢ntico para alegre"
        </p>
        <textarea
          id="mudancasDesejadas"
          placeholder="Ex: Gostaria que o refr√£o fosse mais energ√©tico e mencionasse nossa viagem para o Rio..."
          maxlength="500"
          oninput="updateAlterarCharCount('mudancasDesejadas', 'count1')"
        ></textarea>
        <div class="char-count"><span id="count1">0</span>/500</div>
      </div>

      <div class="alterar-step">
        <h3>H√° algo espec√≠fico que DEVE permanecer? üîí</h3>
        <textarea
          id="manterElementos"
          placeholder="Ex: Mantenha as refer√™ncias a Dourados e o nome 'Aline'..."
          maxlength="300"
          oninput="updateAlterarCharCount('manterElementos', 'count2')"
        ></textarea>
        <div class="char-count"><span id="count2">0</span>/300</div>
      </div>

      <div class="alterar-step">
        <h3>Observa√ß√µes finais sobre o tom ou estilo? üé® (Opcional)</h3>
        <textarea
          id="observacoesFinais"
          placeholder="Ex: Quero que seja mais emocionante, menos melanc√≥lica..."
          maxlength="200"
          oninput="updateAlterarCharCount('observacoesFinais', 'count3')"
        ></textarea>
        <div class="char-count"><span id="count3">0</span>/200</div>
      </div>

      <div class="alterar-buttons">
        <button class="btn-alterar-cancel" onclick="fecharAlterarModal()">Cancelar</button>
        <button class="btn-alterar-submit" id="btnSubmitAlteracao" onclick="submitAlteracao()">
          Enviar Altera√ß√µes ‚ú®
        </button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ MODAL DE EDI√á√ÉO DE RASCUNHO -->
  <div class="edit-draft-modal" id="editDraftModal">
    <div class="edit-draft-content">
      <div class="edit-draft-header">
        <div>
          <h2>‚úèÔ∏è Editar Rascunho</h2>
          <div class="edit-draft-header-info" id="editDraftHeaderInfo">Carregando...</div>
        </div>
        <button class="edit-draft-close" onclick="closeEditDraftModal()">√ó</button>
      </div>

      <div id="editDraftLoading" class="edit-draft-loading">
        ‚è≥ Carregando rascunho...
      </div>

      <form id="editDraftForm" style="display: none;">
        <!-- Formul√°rio ser√° populado dinamicamente -->
      </form>
    </div>
  </div>

  <div class="edit-draft-toast" id="editDraftToast"></div>

  <aside class="sidebar">
    <div class="logo-container">
      <img src="https://i.ibb.co/wFFzDMy9/tunecraft-logo-transparente.png" alt="TuneCraft" style="height: 50px;">
    </div>

    <nav style="flex: 1;">
      <div class="menu-item active" onclick="showSection('drafts', this)">
        üìã <span>Meus Rascunhos</span>
      </div>
      <div class="menu-item" onclick="showSection('pending', this)">
        üìù <span>Aprovar Letra</span>
      </div>
      <div class="menu-item" onclick="showSection('approved', this)">
        üéπ <span>Letras Aprovadas</span>
      </div>
      <div class="menu-item" onclick="showSection('received', this)">
        üéµ <span>M√∫sicas Recebidas</span>
      </div>
      <div class="menu-item" onclick="showSection('profile', this)">
        üë§ <span>Minha Conta</span>
      </div>
    </nav>

    <button class="new-music-btn" onclick="openChat()">
      + Nova M√∫sica
    </button>
  </aside>

  <main class="main-content">
    <div class="header">
      <h2 id="pageTitle">Meus Rascunhos</h2>
      <div class="user-profile">
        <span id="userName">Usu√°rio</span>
        <div class="avatar">U</div>
        <button onclick="logout()" style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:0.9rem; margin-left:10px;">Sair</button>
      </div>
    </div>

    <div id="drafts" class="section active"></div>

    <div id="pending" class="section"></div>

    <div id="approved" class="section">
      <h2>Em Produ√ß√£o</h2>
      <p style="color:#64748b; margin-bottom: 20px;">Nossos artistas est√£o gravando essas m√∫sicas agora.</p>
      <div id="approved-list"></div>
    </div>

    <div id="received" class="section">
      <h2>M√∫sicas Prontas</h2>
      <p style="color:#64748b; margin-bottom: 20px;">Baixe e compartilhe suas cria√ß√µes.</p>
      <div id="received-list"></div>
    </div>

    <div id="profile" class="section">
      <h2>Meus Dados</h2>
      <div class="card profile-form">
        <label>Nome Completo</label>
        <input type="text" id="profName">

        <label>Email</label>
        <input type="email" id="profEmail" readonly style="background:#f1f5f9; color:#64748b;">

        <label>Nova Senha (deixe em branco para manter)</label>
        <input type="password" id="profPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">

        <button class="btn-save-profile" onclick="saveProfile()">Salvar Altera√ß√µes</button>
      </div>
    </div>
  </main>

  <!-- Toast de notifica√ß√µes -->
  <div class="toast-message" id="toastMessage"></div>

  <!-- NOVO: Config Global -->
  <script src="config.js"></script>

  <!-- Chat JS (agora sem redeclara√ß√£o) -->
 
  <script src="chat_themes.js?v=2026-02-35"></script>
  <script src="chat.js?v=2026-02-35"></script>

  <script>
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let userData = JSON.parse(localStorage.getItem("tuneCraftUser")) || { name: "Visitante", email: "", user_id: null, orders: [] };
    let currentAlterandoId = null;
    let editDraftCurrentPedidoId = null;

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toastMessage');
      toast.innerText = message;
      toast.className = `toast-message ${type}`;
      toast.style.display = 'block';

      setTimeout(() => {
        toast.style.display = 'none';
      }, 4000);
    }

    function normalizeStatus(s) {
      const v = (s || "").toLowerCase().replace(/\s+/g, "");
      if (v === "draft") return "draft";
      if (v === "pendingapproval" || v === "pending_approval" || v === "waiting_user_approval" || v === "waitinguserapproval") return "pending_approval";
      if (v === "aguardandoaprovacao" || v === "aguardando_aprovacao") return "aguardando_aprovacao";
      if (v === "production" || v === "inproduction" || v === "generatingaudio" || v === "generating_audio") return "production";
      if (v === "completed" || v === "done" || v === "received") return "completed";
      return v || "pending_approval";
    }

    function escapeHtml(str) {
      return (str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "'");
    }

    function extractSummaryFromPayload(payload) {
      return {
        recipient: payload.step2 || "Indefinido",
        ageGroup: payload.step3 || "N√£o especificado",
        occasion: payload.step6 || "N√£o definida",
        genre: payload.step8 || "N√£o definido",
        message: payload.step12 ? payload.step12.substring(0, 80) + "..." : "Sem mensagem"
      };
    }

    async function getSessionOrRedirect() {
      const { data, error } = await sb.auth.getSession();
      if (error) console.warn("getSession error:", error);

      const session = data?.session;
      if (!session?.access_token || !session?.user?.id) {
        window.location.href = "login.html";
        return null;
      }
      return session;
    }

    async function loadOrdersFromSupabase() {
      const { data, error } = await sb
        .from("musicas_pedidos")
        .select("id,title,lyrics,status,created_at,audio_urls,versao_original,versao_modificada,versao_aprovada,alteracao_usada,versao_aprovada_tipo,alteracao_solicitada,payload")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Erro sb.from(musicas_pedidos):", error);
        return [];
      }

      return (data || []).map(r => {
        let audioUrls = r.audio_urls;

        if (Array.isArray(audioUrls) && audioUrls.length > 0 && typeof audioUrls[0] === 'string') {
          try {
            audioUrls = audioUrls.map(url => JSON.parse(url));
          } catch (e) {
            console.error("‚ùå Erro ao fazer parse de audio_urls:", e);
            audioUrls = [];
          }
        }

        return {
          id: r.id,
          title: r.title || "Sem t√≠tulo",
          lyrics: r.lyrics || "",
          status: normalizeStatus(r.status),
          created_at: r.created_at,
          audio_urls: audioUrls,
          versao_original: r.versao_original,
          versao_modificada: r.versao_modificada,
          versao_aprovada: r.versao_aprovada,
          alteracao_usada: r.alteracao_usada,
          versao_aprovada_tipo: r.versao_aprovada_tipo,
          alteracao_solicitada: r.alteracao_solicitada,
          payload: r.payload
        };
      });
    }

    async function initDashboard() {
      const session = await getSessionOrRedirect();
      if (!session) return;

      const fullName = session.user.user_metadata?.full_name || userData.name || "Usu√°rio";
      userData.name = fullName;
      userData.email = session.user.email || userData.email || "";
      userData.user_id = session.user.id;

      const orders = await loadOrdersFromSupabase();
      userData.orders = orders;

      localStorage.setItem("tuneCraftUser", JSON.stringify(userData));

      document.getElementById("userName").innerText = userData.name.split(" ")[0];
      document.querySelector(".avatar").innerText = userData.name.charAt(0);

      document.getElementById("profName").value = userData.name;
      document.getElementById("profEmail").value = userData.email;

      renderSections();
    }

    initDashboard();

    function showSection(id, element) {
      if (element) {
        document.querySelectorAll(".menu-item").forEach(i => i.classList.remove("active"));
        element.classList.add("active");
      }

      const titles = {
        drafts: "Meus Rascunhos",
        pending: "Aprovar Letra",
        approved: "Letras Aprovadas",
        received: "M√∫sicas Recebidas",
        profile: "Minha Conta"
      };
      document.getElementById("pageTitle").innerText = titles[id] || "Painel";

      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    function renderSections() {
      const draftsContainer = document.getElementById("drafts");
      const pendingContainer = document.getElementById("pending");
      const approvedContainer = document.getElementById("approved-list");
      const receivedContainer = document.getElementById("received-list");

      draftsContainer.innerHTML = "";
      pendingContainer.innerHTML = "";
      approvedContainer.innerHTML = "";
      receivedContainer.innerHTML = "";

      let hasDrafts = false;
      let hasPending = false;
      let hasApproved = false;
      let hasReceived = false;

      if (userData.orders && userData.orders.length > 0) {
        userData.orders.forEach(order => {
          const title = escapeHtml(order.title);
          const lyrics = escapeHtml(order.lyrics);

          if (order.status === "draft") {
            hasDrafts = true;
            const summary = extractSummaryFromPayload(order.payload);

            draftsContainer.innerHTML += `
              <div class="card draft-card">
                <div class="card-header">
                  <h3>üéµ M√∫sica para: ${summary.recipient}</h3>
                  <span class="status-badge status-draft">Rascunho</span>
                </div>

                <div class="draft-summary">
                  <p><strong>Para:</strong> ${summary.recipient} (${summary.ageGroup})</p>
                  <p><strong>Ocasi√£o:</strong> ${summary.occasion}</p>
                  <p><strong>G√™nero:</strong> ${summary.genre}</p>
                  <p><strong>Mensagem:</strong> "${summary.message}"</p>
                </div>

                <div class="action-row">
                  <button class="btn btn-revise" onclick="editarDraft('${order.id}')">
                    ‚úèÔ∏è Editar Formul√°rio
                  </button>
                  <button class="btn btn-approve" onclick="irParaCheckout('${order.id}')">
                    üí≥ Pagar e Gerar Letra (R$ 49,90)
                  </button>
                </div>
              </div>
            `;
          }
          else if (order.status === "pending_approval" && !order.versao_modificada) {
            hasPending = true;
            const podeAlterar = !order.alteracao_usada;

            pendingContainer.innerHTML += `
              <div class="card">
                <div class="card-header">
                  <h3>${title}</h3>
                  <span class="status-badge status-pending">Aguardando Aprova√ß√£o</span>
                </div>
                <p style="font-size:0.9rem; color:#64748b;">Leia a letra gerada abaixo.</p>
                <div class="lyrics-box">${lyrics}</div>
                <div class="action-row">
                  <button
                    class="btn btn-revise"
                    onclick="abrirModalAlteracao('${order.id}')"
                    ${!podeAlterar ? 'disabled title="Altera√ß√£o j√° foi usada"' : ''}
                  >
                    ${podeAlterar ? '‚úèÔ∏è Solicitar Altera√ß√£o (1x)' : 'üîí Altera√ß√£o Usada'}
                  </button>
                  <button class="btn btn-approve" id="btn-${order.id}" onclick="aprovarLetraOriginal('${order.id}')">
                    ‚úÖ Aprovar e Gerar √Åudio
                  </button>
                </div>
              </div>
            `;
          }
          else if (order.status === "aguardando_aprovacao" && order.versao_modificada) {
            hasPending = true;

            const versaoOriginal = order.versao_original || { customer_lyrics: order.lyrics };
            const versaoModificada = order.versao_modificada;

            pendingContainer.innerHTML += `
              <div class="card">
                <div class="card-header">
                  <h3>${title}</h3>
                  <span class="status-badge status-awaiting">Escolha uma Vers√£o</span>
                </div>

                <p style="font-size:0.9rem; color:#64748b; margin-bottom: 15px;">
                  Compare as duas vers√µes e escolha sua favorita:
                </p>

                ${versaoModificada.changelog ? `
                  <div class="version-changelog">
                    <strong>üìù O que foi alterado:</strong><br>
                    ${escapeHtml(versaoModificada.changelog)}
                  </div>
                ` : ''}

                <div class="comparison-container">
                  <div class="version-card">
                    <h4>üìÑ Vers√£o Original</h4>
                    <div class="lyrics-box" style="max-height: 250px;">
                      ${escapeHtml(versaoOriginal.customer_lyrics || versaoOriginal.lyrics)}
                    </div>
                    <button class="btn btn-select" onclick="aprovarVersao('${order.id}', 'original')">
                      ‚úÖ Escolher Esta
                    </button>
                  </div>

                  <div class="version-card">
                    <h4>‚ú® Vers√£o Modificada</h4>
                    <div class="lyrics-box" style="max-height: 250px;">
                      ${escapeHtml(versaoModificada.customer_lyrics)}
                    </div>
                    <button class="btn btn-select" onclick="aprovarVersao('${order.id}', 'modificada')">
                      ‚úÖ Escolher Esta
                    </button>
                  </div>
                </div>
              </div>
            `;
          }
          else if (order.status === "production") {
            hasApproved = true;
            approvedContainer.innerHTML += `
              <div class="card">
                <div class="card-header">
                  <h3>${title}</h3>
                  <span class="status-badge status-production">Em Produ√ß√£o</span>
                </div>
                <p>Letra aprovada! Estamos trabalhando no √°udio.</p>
              </div>
            `;
          }
          else if (order.status === "completed") {
            hasReceived = true;
            const urls = Array.isArray(order.audio_urls) ? order.audio_urls : [];

            receivedContainer.innerHTML += `
              <div class="card">
                <div class="card-header">
                  <h3>${title}</h3>
                  <span class="status-badge status-completed">Pronta</span>
                </div>

                ${
                  urls.length >= 2
                    ? `
                      <strong>üéß Vers√£o A</strong>
                      <audio controls src="${urls[0].audio_url || urls[0]}" style="width:100%; margin:10px 0;"></audio>

                      <strong>üéß Vers√£o B</strong>
                      <audio controls src="${urls[1].audio_url || urls[1]}" style="width:100%; margin:10px 0;"></audio>

                      <div class="action-row" style="margin-top:10px">
                        <a class="btn btn-download" href="${urls[0].audio_url || urls[0]}" download>‚¨áÔ∏è Baixar A</a>
                        <a class="btn btn-download" href="${urls[1].audio_url || urls[1]}" download>‚¨áÔ∏è Baixar B</a>
                      </div>
                    `
                    : urls.length === 1
                    ? `
                      <strong>üéß √Åudio</strong>
                      <audio controls src="${urls[0].audio_url || urls[0]}" style="width:100%; margin:10px 0;"></audio>
                      <a class="btn btn-download" href="${urls[0].audio_url || urls[0]}" download>‚¨áÔ∏è Baixar</a>
                    `
                    : `<p>Sua m√∫sica foi finalizada e est√° sendo preparada para audi√ß√£o.</p>`
                }
              </div>
            `;
          }
        });
      }

      if (!hasDrafts) {
        draftsContainer.innerHTML = `
          <div class="empty-state">
            <span class="empty-icon">üìã</span>
            <h3>Sem rascunhos no momento</h3>
            <p>Crie uma nova m√∫sica para come√ßar!</p>
            <button class="btn btn-approve" onclick="openChat()" style="margin-top:20px;">Criar Nova M√∫sica</button>
          </div>
        `;
      }

      if (!hasPending) {
        pendingContainer.innerHTML = `
          <div class="empty-state">
            <span class="empty-icon">‚ú®</span>
            <h3>Tudo em dia!</h3>
            <p>Voc√™ n√£o tem letras pendentes.</p>
            <button class="btn btn-approve" onclick="openChat()" style="margin-top:20px;">Criar Nova M√∫sica</button>
          </div>
        `;
      }

      if (!hasApproved) {
        approvedContainer.innerHTML = `
          <div class="empty-state" style="padding:20px;">
            <p>Sem m√∫sicas em produ√ß√£o no momento.</p>
          </div>
        `;
      }

      if (!hasReceived) {
        receivedContainer.innerHTML = `
          <div class="empty-state" style="padding:20px;">
            <p>Sem m√∫sicas prontas no momento.</p>
          </div>
        `;
      }
    }

    // ‚úÖ ALTERA√á√ÉO 4: FUN√á√ÉO EDITARDRAFT MODIFICADA
    function editarDraft(pedidoId) {
      console.log("üìù Abrindo editor para:", pedidoId);

      // ‚úÖ Abre o modal
      openEditDraftModal(pedidoId);
    }

    async function irParaCheckout(pedidoId) {
      try {
        localStorage.setItem('tuneCraft_pendingOrderId', pedidoId);
        localStorage.setItem('tuneCraft_checkoutEmail', userData.email);
        localStorage.setItem('tuneCraft_checkoutName', userData.name);

        console.log("üí≥ Redirecionando para checkout:", pedidoId);
        showToast("Redirecionando para checkout...", "info");

        setTimeout(() => {
          window.location.href = 'checkout.html';
        }, 500);

      } catch (error) {
        console.error("Erro ao redirecionar:", error);
        showToast(`‚ùå Erro: ${error.message}`, "error");
      }
    }

    function abrirModalAlteracao(pedidoId) {
      currentAlterandoId = pedidoId;
      document.getElementById('alterarModal').classList.add('active');

      document.getElementById('mudancasDesejadas').value = '';
      document.getElementById('manterElementos').value = '';
      document.getElementById('observacoesFinais').value = '';
      document.getElementById('count1').innerText = '0';
      document.getElementById('count2').innerText = '0';
      document.getElementById('count3').innerText = '0';
    }

    function fecharAlterarModal() {
      document.getElementById('alterarModal').classList.remove('active');
      currentAlterandoId = null;
    }

    function updateAlterarCharCount(fieldId, countId) {
      const field = document.getElementById(fieldId);
      const count = field.value.length;
      document.getElementById(countId).innerText = count;
    }

    async function submitAlteracao() {
      const mudancas = document.getElementById('mudancasDesejadas').value.trim();
      const manter = document.getElementById('manterElementos').value.trim();
      const obs = document.getElementById('observacoesFinais').value.trim();

      if (mudancas.length < 20) {
        showToast("Por favor, descreva as mudan√ßas com pelo menos 20 caracteres", "error");
        return;
      }

      if (manter.length < 10) {
        showToast("Por favor, especifique o que deve ser mantido (m√≠nimo 10 caracteres)", "error");
        return;
      }

      const btn = document.getElementById('btnSubmitAlteracao');
      btn.disabled = true;
      btn.innerText = "Processando...";

      const sugestoes = `
MUDAN√áAS DESEJADAS:
${mudancas}

ELEMENTOS QUE DEVEM PERMANECER:
${manter}

${obs ? `OBSERVA√á√ïES ADICIONAIS:\n${obs}` : ''}
      `.trim();

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/alterar-letra`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            pedidoId: currentAlterandoId,
            sugestoes: sugestoes
          })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Erro ao processar altera√ß√µes');
        }

        showToast("‚úÖ Vers√£o modificada criada! Compare as vers√µes.", "");
        fecharAlterarModal();

        userData.orders = await loadOrdersFromSupabase();
        localStorage.setItem("tuneCraftUser", JSON.stringify(userData));
        renderSections();

      } catch (error) {
        showToast(`‚ùå Erro: ${error.message}`, "error");
        btn.disabled = false;
        btn.innerText = "Enviar Altera√ß√µes ‚ú®";
      }
    }

    async function aprovarLetraOriginal(id) {
      if (!confirm("Aprovar esta letra e iniciar gera√ß√£o de √°udio?")) return;

      const btn = document.getElementById(`btn-${id}`);
      if (btn) {
        btn.disabled = true;
        btn.innerText = "Processando...";
      }

      try {
        const { error: updateError } = await sb
          .from("musicas_pedidos")
          .update({
            status: "production",
            versao_aprovada: sb.from("musicas_pedidos").select("versao_original").eq("id", id).single()
          })
          .eq("id", id);

        if (updateError) {
          console.error("‚ùå Erro ao atualizar:", updateError);
          showToast("‚ùå Erro ao atualizar status", "error");
          if (btn) {
            btn.disabled = false;
            btn.innerText = "‚úÖ Aprovar e Gerar √Åudio";
          }
          return;
        }

        showToast("‚úÖ Letra aprovada! Iniciando gera√ß√£o...", "info");

        const response = await fetch(`${SUPABASE_URL}/functions/v1/generate-audio`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pedido_id: id })
        });

        if (!response.ok) {
          throw new Error(`Erro ao gerar √°udio: ${response.status}`);
        }

        const result = await response.json();
        showToast(`‚úÖ √Åudio em gera√ß√£o! Task: ${result.task_id}`, "");

        userData.orders = await loadOrdersFromSupabase();
        localStorage.setItem("tuneCraftUser", JSON.stringify(userData));
        renderSections();
        showSection("approved", document.querySelectorAll(".menu-item")[2]);

      } catch (error) {
        showToast(`‚ùå Erro: ${error.message}`, "error");
        if (btn) {
          btn.disabled = false;
          btn.innerText = "‚úÖ Aprovar e Gerar √Åudio";
        }
      }
    }

    async function aprovarVersao(pedidoId, tipoVersao) {
      if (!confirm(`Aprovar vers√£o ${tipoVersao} e iniciar gera√ß√£o de √°udio?`)) return;

      showToast("‚è≥ Salvando escolha...", "info");

      try {
        console.log("üì§ Enviando:", { pedidoId, versaoEscolhida: tipoVersao });

        const response = await fetch(`${SUPABASE_URL}/functions/v1/aprovar-versao`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            pedidoId: pedidoId,
            versaoEscolhida: tipoVersao
          })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Erro ao aprovar vers√£o');
        }

        console.log("‚úÖ Vers√£o aprovada:", result);
        showToast("‚úÖ Vers√£o aprovada! Iniciando √°udio...", "");

        const audioResponse = await fetch(`${SUPABASE_URL}/functions/v1/generate-audio`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            pedido_id: pedidoId
          })
        });

        if (!audioResponse.ok) {
          throw new Error('Erro ao iniciar gera√ß√£o de √°udio');
        }

        const audioResult = await audioResponse.json();
        console.log("‚úÖ √Åudio gerado:", audioResult);
        showToast(`‚úÖ √Åudio em gera√ß√£o! Task: ${audioResult.task_id}`, "");

        userData.orders = await loadOrdersFromSupabase();
        localStorage.setItem("tuneCraftUser", JSON.stringify(userData));
        renderSections();
        showSection("approved", document.querySelectorAll(".menu-item")[2]);

      } catch (error) {
        console.error("‚ùå Erro completo:", error);
        showToast(`‚ùå ${error.message}`, "error");
      }
    }

    function saveProfile() {
      const newName = document.getElementById("profName").value;
      const newPass = document.getElementById("profPass").value;

      userData.name = newName;
      if (newPass) userData.password = newPass;

      localStorage.setItem("tuneCraftUser", JSON.stringify(userData));

      document.getElementById("userName").innerText = newName.split(" ")[0];
      document.querySelector(".avatar").innerText = newName.charAt(0);

      showToast("‚úÖ Perfil atualizado com sucesso!", "");
    }

    async function logout() {
      try {
        await sb.auth.signOut();
      } catch (e) {
        console.error("Erro ao deslogar:", e);
      }

      localStorage.removeItem("tuneCraftUser");
      window.location.href = "login.html";
    }
  </script>

  <!-- ‚úÖ ALTERA√á√ÉO 3: JAVASCRIPT DO MODAL DE EDI√á√ÉO -->
  <script>
    function showEditDraftToast(message, type = 'info') {
      const toast = document.getElementById('editDraftToast');
      toast.innerText = message;
      toast.className = `edit-draft-toast ${type}`;
      toast.style.display = 'block';
      
      setTimeout(() => {
        toast.style.display = 'none';
      }, 4000);
    }

    async function openEditDraftModal(pedidoId) {
      editDraftCurrentPedidoId = pedidoId;
      const modal = document.getElementById('editDraftModal');
      modal.classList.add('active');
      
      await loadEditDraft(pedidoId);
    }

    function closeEditDraftModal() {
      const modal = document.getElementById('editDraftModal');
      modal.classList.remove('active');
      editDraftCurrentPedidoId = null;
    }

    async function loadEditDraft(pedidoId) {
  const loading = document.getElementById('editDraftLoading');
  const form = document.getElementById('editDraftForm');
  
  loading.style.display = 'flex';
  form.style.display = 'none';

  try {
    const { data, error } = await sb
      .from('musicas_pedidos')
      .select('*')
      .eq('id', pedidoId)
      .single();

    if (error) throw error;

    const payload = data.payload || {};
    
    document.getElementById('editDraftHeaderInfo').innerText = `Criado em ${new Date(data.created_at).toLocaleDateString('pt-BR')}`;

    form.innerHTML = `
      <div class="edit-draft-section-title">üë§ Destinat√°rio</div>
      
      <div class="edit-draft-form-group">
        <label>Quem √© a pessoa especial?</label>
        <div class="field-name">payload.step1</div>
        <select id="edit_step1">
          <option value="romantic" ${payload.step1 === 'romantic' ? 'selected' : ''}>Namorado/Namorada</option>
          <option value="parent" ${payload.step1 === 'parent' ? 'selected' : ''}>M√£e/Pai</option>
          <option value="child" ${payload.step1 === 'child' ? 'selected' : ''}>Filho/Filha</option>
          <option value="grandparent" ${payload.step1 === 'grandparent' ? 'selected' : ''}>Av√¥/Av√≥</option>
          <option value="friend" ${payload.step1 === 'friend' ? 'selected' : ''}>Amigo/Amiga</option>
          <option value="colleague" ${payload.step1 === 'colleague' ? 'selected' : ''}>Colega de trabalho</option>
          <option value="sibling" ${payload.step1 === 'sibling' ? 'selected' : ''}>Irm√£o/Irm√£</option>
          <option value="mentor" ${payload.step1 === 'mentor' ? 'selected' : ''}>Professor/Mentora</option>
          <option value="group" ${payload.step1 === 'group' ? 'selected' : ''}>Grupo/Fam√≠lia</option>
          <option value="other" ${payload.step1 === 'other' ? 'selected' : ''}>Outro</option>
        </select>
      </div>

      ${payload.step1 === 'other' && payload['step1.5'] ? `
      <div class="edit-draft-form-group">
        <label>Como voc√™ descreveria esse relacionamento?</label>
        <div class="field-name">payload.step1.5</div>
        <textarea id="edit_step1_5" rows="3" placeholder="Ex: Meu vizinho que √© como um pai para mim...">${payload['step1.5'] || ''}</textarea>
      </div>
      ` : ''}

      <div class="edit-draft-form-group">
        <label>Qual o nome dessa pessoa?</label>
        <div class="field-name">payload.step2</div>
        <input type="text" id="edit_step2" value="${payload.step2 || ''}" placeholder="Ex: Maria">
      </div>

      <div class="edit-draft-form-group">
        <label>Qual a idade ou faixa et√°ria?</label>
        <div class="field-name">payload.step3</div>
        <select id="edit_step3">
          <option value="child12" ${payload.step3 === 'child12' ? 'selected' : ''}>Crian√ßa (at√© 12 anos)</option>
          <option value="teen" ${payload.step3 === 'teen' ? 'selected' : ''}>Teen (13-19 anos)</option>
          <option value="adult_young" ${payload.step3 === 'adult_young' ? 'selected' : ''}>Jovem adulto (20-35 anos)</option>
          <option value="adult_middle" ${payload.step3 === 'adult_middle' ? 'selected' : ''}>Adulto (36-55 anos)</option>
          <option value="adult_senior" ${payload.step3 === 'adult_senior' ? 'selected' : ''}>Senior (56+ anos)</option>
        </select>
      </div>

      <div class="edit-draft-form-group">
        <label>Descreva a personalidade dessa pessoa</label>
        <div class="field-name">payload.step4</div>
        <textarea id="edit_step4" rows="4" placeholder="Ex: Alegre, extrovertida, adora dan√ßar...">${payload.step4 || ''}</textarea>
      </div>

      <div class="edit-draft-form-group">
        <label>Caracter√≠sticas especiais ou hist√≥rias √∫nicas (opcional)</label>
        <div class="field-name">payload.step5</div>
        <textarea id="edit_step5" rows="3" placeholder="Ex: Faz bolos incr√≠veis, plantava suas pr√≥prias verduras...">${payload.step5 || ''}</textarea>
      </div>

      <div class="edit-draft-section-title">üéâ Ocasi√£o</div>

      <div class="edit-draft-form-group">
        <label>Qual a ocasi√£o especial?</label>
        <div class="field-name">payload.step6</div>
        <select id="edit_step6">
          <option value="proposal" ${payload.step6 === 'proposal' ? 'selected' : ''}>Pedido de Casamento</option>
          <option value="birthday" ${payload.step6 === 'birthday' ? 'selected' : ''}>Anivers√°rio</option>
          <option value="confession" ${payload.step6 === 'confession' ? 'selected' : ''}>Declara√ß√£o de Amor</option>
          <option value="tribute" ${payload.step6 === 'tribute' ? 'selected' : ''}>Homenagem especial</option>
          <option value="goodbye" ${payload.step6 === 'goodbye' ? 'selected' : ''}>Despedida/Adeus</option>
          <option value="celebration" ${payload.step6 === 'celebration' ? 'selected' : ''}>Comemora√ß√£o (formatura, promo√ß√£o, etc)</option>
          <option value="apology" ${payload.step6 === 'apology' ? 'selected' : ''}>Pedido de desculpas</option>
          <option value="friendship" ${payload.step6 === 'friendship' ? 'selected' : ''}>Comemora√ß√£o de amizade</option>
          <option value="other" ${payload.step6 === 'other' ? 'selected' : ''}>Outra ocasi√£o</option>
        </select>
      </div>

      ${payload.step6 === 'other' && payload['step6.5'] ? `
      <div class="edit-draft-form-group">
        <label>Descreva a ocasi√£o em detalhes</label>
        <div class="field-name">payload.step6.5</div>
        <textarea id="edit_step6_5" rows="3" placeholder="Ex: Aposentadoria ap√≥s 40 anos de trabalho...">${payload['step6.5'] || ''}</textarea>
      </div>
      ` : ''}

      <div class="edit-draft-form-group">
        <label>Data da ocasi√£o (opcional)</label>
        <div class="field-name">payload.step7</div>
        <input type="date" id="edit_step7" value="${payload.step7 || ''}">
      </div>

      <div class="edit-draft-section-title">üéµ Estilo Musical</div>

      <div class="edit-draft-form-group">
        <label>G√™nero musical</label>
        <div class="field-name">payload.step8</div>
        <select id="edit_step8">
          <option value="pop" ${payload.step8 === 'pop' ? 'selected' : ''}>Pop moderno</option>
          <option value="sertanejo" ${payload.step8 === 'sertanejo' ? 'selected' : ''}>Sertanejo</option>
          <option value="rock" ${payload.step8 === 'rock' ? 'selected' : ''}>Rock/Rock alternativo</option>
          <option value="rap" ${payload.step8 === 'rap' ? 'selected' : ''}>Rap/Trap</option>
          <option value="samba" ${payload.step8 === 'samba' ? 'selected' : ''}>Samba/Pagode</option>
          <option value="acoustic" ${payload.step8 === 'acoustic' ? 'selected' : ''}>Ac√∫stico/MPB</option>
          <option value="electronic" ${payload.step8 === 'electronic' ? 'selected' : ''}>Eletr√¥nico/House</option>
          <option value="reggae" ${payload.step8 === 'reggae' ? 'selected' : ''}>Reggae</option>
          <option value="funk" ${payload.step8 === 'funk' ? 'selected' : ''}>Funk/Dance</option>
          <option value="forro" ${payload.step8 === 'forro' ? 'selected' : ''}>Forr√≥</option>
          <option value="gospel" ${payload.step8 === 'gospel' ? 'selected' : ''}>Gospel/Espiritual</option>
          <option value="other" ${payload.step8 === 'other' ? 'selected' : ''}>Outro</option>
        </select>
      </div>

      ${payload.step8 === 'other' && payload['step8.5'] ? `
      <div class="edit-draft-form-group">
        <label>Qual gnero ou mistura voc√™ prefere?</label>
        <div class="field-name">payload.step8.5</div>
        <textarea id="edit_step8_5" rows="2" placeholder="Ex: Eletr√¥nico com influ√™ncia de samba...">${payload['step8.5'] || ''}</textarea>
      </div>
      ` : ''}

      <div class="edit-draft-form-group">
        <label>Tempo/ritmo ideal</label>
        <div class="field-name">payload.step9</div>
        <select id="edit_step9">
          <option value="slow" ${payload.step9 === 'slow' ? 'selected' : ''}>Lenta e contemplativa (60-80 BPM)</option>
          <option value="moderate" ${payload.step9 === 'moderate' ? 'selected' : ''}>Moderada e equilibrada (80-110 BPM)</option>
          <option value="fast" ${payload.step9 === 'fast' ? 'selected' : ''}>R√°pida e energ√©tica (110+ BPM)</option>
        </select>
      </div>

      <div class="edit-draft-form-group">
        <label>Energia da m√∫sica</label>
        <div class="field-name">payload.step10</div>
        <select id="edit_step10">
          <option value="low" ${payload.step10 === 'low' ? 'selected' : ''}>Baixa (suave, intimista, relax)</option>
          <option value="medium" ${payload.step10 === 'medium' ? 'selected' : ''}>M√©dia (natural, fluida, equilibrada)</option>
          <option value="high" ${payload.step10 === 'high' ? 'selected' : ''}>Alta (impacto, poderosa, celebrativa)</option>
        </select>
      </div>

      <div class="edit-draft-section-title">üéº Refer√™ncias Musicais</div>

      <div class="edit-draft-form-group">
        <label>Artistas e m√∫sicas que inspiram (at√© 3)</label>
        <div class="field-name">payload.step11</div>
        <div class="edit-draft-references" id="referencesContainer">
          ${(payload.step11 || []).slice(0, 3).map((ref, i) => `
            <div class="edit-draft-reference-item">
              <input type="text" placeholder="Artista" value="${ref.artist || ''}" data-ref-idx="${i}" data-ref-type="artist">
              <input type="text" placeholder="M√∫sica" value="${ref.song || ''}" data-ref-idx="${i}" data-ref-type="song">
            </div>
          `).join('')}
          ${payload.step11?.length < 3 ? Array.from({length: 3 - (payload.step11?.length || 0)}, (_, i) => `
            <div class="edit-draft-reference-item">
              <input type="text" placeholder="Artista" data-ref-idx="${(payload.step11?.length || 0) + i}" data-ref-type="artist">
              <input type="text" placeholder="M√∫sica" data-ref-idx="${(payload.step11?.length || 0) + i}" data-ref-type="song">
            </div>
          `).join('') : ''}
        </div>
      </div>

      <div class="edit-draft-section-title">üí¨ Mensagem e Emo√ß√£o</div>

      <div class="edit-draft-form-group">
        <label>Sentimento ou mensagem PRINCIPAL</label>
        <div class="field-name">payload.step12</div>
        <textarea id="edit_step12" rows="4" placeholder="Ex: Quero contar nossa hist√≥ria de vida juntos...">${payload.step12 || ''}</textarea>
      </div>

      <div class="edit-draft-form-group">
        <label>Hist√≥rias, mem√≥rias ou men√ß√µes espec√≠ficas (opcional)</label>
        <div class="field-name">payload.step13</div>
        <textarea id="edit_step13" rows="3" placeholder="Ex: Mencionar Dourados, aquela viagem para o Rio...">${payload.step13 || ''}</textarea>
      </div>

      <div class="edit-draft-form-group">
        <label>Tom/estilo de linguagem</label>
        <div class="field-name">payload.step14</div>
        <select id="edit_step14">
          <option value="poetic" ${payload.step14 === 'poetic' ? 'selected' : ''}>Po√©tico e rom√¢ntico (com met√°foras)</option>
          <option value="conversational" ${payload.step14 === 'conversational' ? 'selected' : ''}>Conversacional e natural</option>
          <option value="storytelling" ${payload.step14 === 'storytelling' ? 'selected' : ''}>Storytelling (contando uma hist√≥ria)</option>
          <option value="direct" ${payload.step14 === 'direct' ? 'selected' : ''}>Direto e emotivo</option>
          <option value="humorous" ${payload.step14 === 'humorous' ? 'selected' : ''}>Bem-humorado (com humor e leveza)</option>
        </select>
      </div>

      <div class="edit-draft-section-title">üéôÔ∏è Produ√ß√£o</div>

      <div class="edit-draft-form-group">
        <label>Tipo de voz</label>
        <div class="field-name">payload.step15</div>
        <select id="edit_step15">
          <option value="female_warm" ${payload.step15 === 'female_warm' ? 'selected' : ''}>Voz feminina suave (calorosa, emotiva)</option>
          <option value="female_strong" ${payload.step15 === 'female_strong' ? 'selected' : ''}>Voz feminina poderosa (energ√©tica, clara)</option>
          <option value="male_soft" ${payload.step15 === 'male_soft' ? 'selected' : ''}>Voz masculina suave (intimista, delicada)</option>
          <option value="male_strong" ${payload.step15 === 'male_strong' ? 'selected' : ''}>Voz masculina poderosa (grave, marcante)</option>
          <option value="duo" ${payload.step15 === 'duo' ? 'selected' : ''}>Dueto homem+mulher (alternando)</option>
          <option value="duo_harmony" ${payload.step15 === 'duo_harmony' ? 'selected' : ''}>Dueto homem+mulher (harmonizando)</option>
        </select>
      </div>

      <div class="edit-draft-form-group">
        <label>Estilo de produ√ß√£o</label>
        <div class="field-name">payload.step16</div>
        <select id="edit_step16">
          <option value="acoustic" ${payload.step16 === 'acoustic' ? 'selected' : ''}>Ac√∫stico puro (viol√£o, piano, natural)</option>
          <option value="acoustic_backing" ${payload.step16 === 'acoustic_backing' ? 'selected' : ''}>Ac√∫stico com backing</option>
          <option value="studio_polish" ${payload.step16 === 'studio_polish' ? 'selected' : ''}>Studio polish (profissional, limpo)</option>
          <option value="live_feel" ${payload.step16 === 'live_feel' ? 'selected' : ''}>Live feel (como se ao vivo)</option>
          <option value="cinematic" ${payload.step16 === 'cinematic' ? 'selected' : ''}>Cinematic (√©pico, orquestrado)</option>
          <option value="electronic_modern" ${payload.step16 === 'electronic_modern' ? 'selected' : ''}>Eletr√¥nico/Moderno (sintetizadores, beats)</option>
        </select>
      </div>

      <div class="edit-draft-actions">
        <button type="button" class="edit-draft-btn edit-draft-btn-cancel" onclick="closeEditDraftModal()">
          Cancelar
        </button>
        <button type="button" class="edit-draft-btn edit-draft-btn-save" onclick="saveEditDraft()">
          üíæ Salvar Altera√ß√µes
        </button>
      </div>
    `;

    loading.style.display = 'none';
    form.style.display = 'block';

  } catch (error) {
    console.error('‚ùå Erro ao carregar rascunho:', error);
    showEditDraftToast(`Erro: ${error.message}`, 'error');
    closeEditDraftModal();
  }
}


   async function saveEditDraft() {
  if (!editDraftCurrentPedidoId) return;

  const btn = document.querySelector('.edit-draft-btn-save');
  btn.disabled = true;
  btn.innerText = '‚è≥ Salvando...';

  try {
    // Coletar refer√™ncias
    const references = [];
    document.querySelectorAll('[data-ref-type="artist"]').forEach((artistInput, idx) => {
      const songInput = document.querySelector(`[data-ref-idx="${idx}"][data-ref-type="song"]`);
      const artist = artistInput.value.trim();
      const song = songInput?.value.trim();
      
      if (artist && song) {
        references.push({ artist, song });
      }
    });

    const updatedPayload = {
      step1: document.getElementById('edit_step1')?.value,
      'step1.5': document.getElementById('edit_step1_5')?.value || undefined,
      step2: document.getElementById('edit_step2')?.value,
      step3: document.getElementById('edit_step3')?.value,
      step4: document.getElementById('edit_step4')?.value,
      step5: document.getElementById('edit_step5')?.value,
      step6: document.getElementById('edit_step6')?.value,
      'step6.5': document.getElementById('edit_step6_5')?.value || undefined,
      step7: document.getElementById('edit_step7')?.value,
      step8: document.getElementById('edit_step8')?.value,
      'step8.5': document.getElementById('edit_step8_5')?.value || undefined,
      step9: document.getElementById('edit_step9')?.value,
      step10: document.getElementById('edit_step10')?.value,
      step11: references.length > 0 ? references : undefined,
      step12: document.getElementById('edit_step12')?.value,
      step13: document.getElementById('edit_step13')?.value,
      step14: document.getElementById('edit_step14')?.value,
      step15: document.getElementById('edit_step15')?.value,
      step16: document.getElementById('edit_step16')?.value
    };

    // Remove undefined values
    Object.keys(updatedPayload).forEach(key => {
      if (updatedPayload[key] === undefined || updatedPayload[key] === '') {
        delete updatedPayload[key];
      }
    });

    const { error } = await sb
      .from('musicas_pedidos')
      .update({ 
        payload: updatedPayload,
        
      })
      .eq('id', editDraftCurrentPedidoId);

    if (error) throw error;

    showEditDraftToast('‚úÖ Rascunho atualizado com sucesso!', '');
    closeEditDraftModal();

    userData.orders = await loadOrdersFromSupabase();
    localStorage.setItem("tuneCraftUser", JSON.stringify(userData));
    renderSections();

  } catch (error) {
    console.error('‚ùå Erro ao salvar:', error);
    showEditDraftToast(`Erro: ${error.message}`, 'error');
    btn.disabled = false;
    btn.innerText = 'üíæ Salvar Altera√ß√µes';
  }
}

  </script>

</body>
</html>




