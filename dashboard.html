<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Cliente | TuneCraft</title>
  <link rel="stylesheet" href="chat.css" />

  <!-- Supabase JS (apenas UMA vez) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
 /* ==========================================
   DARK THEME PATCH + MOBILE SAFE BOTTOM
   Cole no FINAL do seu <style>
   ========================================== */

/* Tokens do tema */
:root{
  --bg: #0b1020;
  --surface: #0f172a;
  --surface-2: #111c33;
  --text: #e5e7eb;
  --muted: #94a3b8;
  --border: rgba(148,163,184,.22);
  --shadow: 0 14px 40px rgba(0,0,0,.45);

  --primary: #00d9ff;
  --primary-2: #6366f1;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;

  --radius: 14px;
}

/* Base */
html, body{
  background: var(--bg) !important;
  color: var(--text) !important;
}

body{
  -webkit-font-smoothing: antialiased;
}

/* Sidebar (desktop) */
.sidebar{
  background: #070b18 !important;
  border-right: 1px solid rgba(148,163,184,.10);
}

/* Menu */
.menu-item{
  color: rgba(148,163,184,.92) !important;
}
.menu-item:hover{
  background: rgba(255,255,255,.06) !important;
  color: var(--text) !important;
}
.menu-item.active{
  background: rgba(0,217,255,.10) !important;
  color: var(--text) !important;
  border-left: 3px solid var(--primary) !important;
}

/* Conte√∫do */
.main-content{
  background: var(--bg) !important;
  color: var(--text) !important;
}

/* Header */
#pageTitle, .header h2{
  color: var(--text) !important;
}
.user-profile span{
  color: var(--muted) !important;
}
.avatar{
  background: rgba(148,163,184,.12) !important;
  color: var(--text) !important;
}

/* Cards */
.card{
  background: var(--surface) !important;
  border: 1px solid var(--border) !important;
  box-shadow: var(--shadow) !important;
  border-radius: var(--radius) !important;
}
.card-header h3{
  color: var(--text) !important;
}
.card p{
  color: var(--muted) !important;
}

/* Status badges (mant√©m ‚Äúcara de sistema‚Äù) */
.status-badge{
  border: 1px solid rgba(255,255,255,.08);
}
.status-pending{ background: rgba(245,158,11,.12) !important; color: #fbbf24 !important; }
.status-production{ background: rgba(59,130,246,.12) !important; color: #93c5fd !important; }
.status-completed{ background: rgba(16,185,129,.12) !important; color: #6ee7b7 !important; }
.status-awaiting{ background: rgba(245,158,11,.12) !important; color: #fbbf24 !important; }
.status-draft{ background: rgba(236,72,153,.12) !important; color: #f9a8d4 !important; }

/* Draft summary */
.draft-summary{
  background: rgba(148,163,184,.06) !important;
  border-left: 4px solid rgba(236,72,153,.75) !important;
}
.draft-summary p{ color: var(--muted) !important; }
.draft-summary p strong{ color: var(--text) !important; }

/* Lyrics box */
.lyrics-box{
  background: rgba(148,163,184,.06) !important;
  border: 1px solid rgba(148,163,184,.22) !important;
  color: var(--text) !important;
}

/* Version cards (compara√ß√£o) */
.version-card{
  background: rgba(148,163,184,.06) !important;
  border: 1px solid rgba(148,163,184,.22) !important;
}
.version-card.selected{
  border-color: rgba(0,217,255,.8) !important;
  background: rgba(0,217,255,.07) !important;
}
.version-card h4{ color: var(--text) !important; }
.version-changelog{
  background: rgba(245,158,11,.10) !important;
  border-left: 3px solid rgba(245,158,11,.9) !important;
  color: var(--text) !important;
}

/* Inputs */
.profile-form input,
.edit-draft-form-group input,
.edit-draft-form-group textarea,
.edit-draft-form-group select,
.alterar-step textarea{
  background: rgba(148,163,184,.06) !important;
  color: var(--text) !important;
  border: 1px solid rgba(148,163,184,.22) !important;
}
.profile-form label,
.edit-draft-form-group label,
.edit-draft-section-title,
.alterar-step h3{
  color: var(--text) !important;
}
.edit-draft-form-group .field-name,
.char-count{
  color: var(--muted) !important;
}

/* Bot√µes */
.btn{
  border-radius: 10px !important;
}
.btn-approve{
  background: linear-gradient(135deg, var(--success), #059669) !important;
  color: #062016 !important;
}
.btn-revise{
  background: transparent !important;
  border: 1px solid rgba(245,158,11,.8) !important;
  color: #fbbf24 !important;
}
.btn-download{
  background: rgba(148,163,184,.10) !important;
  color: var(--text) !important;
  border: 1px solid rgba(148,163,184,.22) !important;
}
.btn-select{
  background: linear-gradient(135deg, var(--primary), var(--primary-2)) !important;
  color: #00131a !important;
}

/* Toasts */
.toast-message{
  background: rgba(16,185,129,.95) !important;
  color: #062016 !important;
  border: 1px solid rgba(255,255,255,.10);
}
.toast-message.error{ background: rgba(239,68,68,.95) !important; color: #2b0606 !important; }
.toast-message.info{ background: rgba(59,130,246,.95) !important; color: #061323 !important; }

/* Modais */
.alterar-content,
.edit-draft-content{
  background: var(--surface) !important;
  border: 1px solid rgba(148,163,184,.22) !important;
  box-shadow: var(--shadow) !important;
}
.alterar-close, .edit-draft-close{
  color: var(--muted) !important;
}
.alterar-step p{
  color: var(--muted) !important;
}

/* ==========================================
   ‚úÖ Corrige ‚Äúbot√µes escondidos‚Äù no mobile
   - garante √°rea extra abaixo do conte√∫do
   - considera safe-area do iPhone
   ========================================== */
@media (max-width: 768px){
  /* A tua bottom-nav tem altura ~74px e o FAB fica acima.
     Aqui a gente garante folga real para cards/bot√µes. */
  .main-content{
    padding-bottom: calc(160px + env(safe-area-inset-bottom)) !important;
  }

  /* Cards com um ‚Äúrespiro‚Äù extra no fim */
  .card{
    margin-bottom: 18px !important;
  }

  /* Toast sempre acima do bottom-nav */
  .toast-message{
    bottom: calc(92px + env(safe-area-inset-bottom)) !important;
    right: 14px !important;
    left: 14px !important;
  }

  /* Bottom-nav com cara dark real */
  .sidebar{
    background: #070b18 !important;
    border-top: 1px solid rgba(148,163,184,.16) !important;
  }

  /* Bot√£o flutuante (Nova M√∫sica) com contraste melhor */
  .new-music-btn{
    background: linear-gradient(135deg, var(--primary), var(--primary-2)) !important;
    color: #00131a !important;
  }
}

@media (max-width: 420px){
  .main-content{
    padding-bottom: calc(170px + env(safe-area-inset-bottom)) !important;
  }
}

  </style>

</head>
<body>

  <!-- Chat Modal (criar nova m√∫sica) -->
  <div class="chat-modal" id="chatModal">
    <div class="chat-container">
      <div class="chat-header">
        <h2>üéµ Criar Nova M√∫sica</h2>
        <button class="close-chat" onclick="closeChat()">√ó</button>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-section" id="inputSection"></div>
    </div>
  </div>

  <!-- ‚úÖ Modal de Altera√ß√£o de Letra -->
  <div class="alterar-modal" id="alterarModal">
    <div class="alterar-content">
      <div class="alterar-header">
        <h2>‚úèÔ∏è Alterar Letra</h2>
        <button class="alterar-close" onclick="fecharAlterarModal()">√ó</button>
      </div>

      <div class="alterar-step">
        <h3>O que voc√™ gostaria de mudar na letra? üéµ</h3>
        <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 10px;">
          üí° Exemplos: "Tornar o refr√£o mais animado", "Adicionar men√ß√£o a Dourados", "Mudar o tom de rom√¢ntico para alegre"
        </p>
        <textarea
          id="mudancasDesejadas"
          placeholder="Ex: Gostaria que o refr√£o fosse mais energ√©tico e mencionasse nossa viagem para o Rio..."
          maxlength="500"
          oninput="updateAlterarCharCount('mudancasDesejadas', 'count1')"
        ></textarea>
        <div class="char-count"><span id="count1">0</span>/500</div>
      </div>

      <div class="alterar-step">
        <h3>H√° algo espec√≠fico que DEVE permanecer? üîí</h3>
        <textarea
          id="manterElementos"
          placeholder="Ex: Mantenha as refer√™ncias a Dourados e o nome 'Aline'..."
          maxlength="300"
          oninput="updateAlterarCharCount('manterElementos', 'count2')"
        ></textarea>
        <div class="char-count"><span id="count2">0</span>/300</div>
      </div>

      <div class="alterar-step">
        <h3>Observa√ß√µes finais sobre o tom ou estilo? üé® (Opcional)</h3>
        <textarea
          id="observacoesFinais"
          placeholder="Ex: Quero que seja mais emocionante, menos melanc√≥lica..."
          maxlength="200"
          oninput="updateAlterarCharCount('observacoesFinais', 'count3')"
        ></textarea>
        <div class="char-count"><span id="count3">0</span>/200</div>
      </div>

      <div class="alterar-buttons">
        <button class="btn-alterar-cancel" onclick="fecharAlterarModal()">Cancelar</button>
        <button class="btn-alterar-submit" id="btnSubmitAlteracao" onclick="submitAlteracao()">
          Enviar Altera√ß√µes ‚ú®
        </button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ MODAL DE EDI√á√ÉO DE RASCUNHO -->
  <div class="edit-draft-modal" id="editDraftModal">
    <div class="edit-draft-content">
      <div class="edit-draft-header">
        <div>
          <h2>‚úèÔ∏è Editar Rascunho</h2>
          <div class="edit-draft-header-info" id="editDraftHeaderInfo">Carregando...</div>
        </div>
        <button class="edit-draft-close" onclick="closeEditDraftModal()">√ó</button>
      </div>

      <div id="editDraftLoading" class="edit-draft-loading">
        ‚è≥ Carregando rascunho...
      </div>

      <form id="editDraftForm" style="display: none;">
        <!-- Formul√°rio ser√° populado dinamicamente -->
      </form>
    </div>
  </div>

  <div class="edit-draft-toast" id="editDraftToast"></div>

  <aside class="sidebar">
    <div class="logo-container">
      <img src="https://i.ibb.co/wFFzDMy9/tunecraft-logo-transparente.png" alt="TuneCraft" style="height: 50px;">
    </div>

    <nav style="flex: 1;">
      <div class="menu-item active" onclick="showSection('drafts', this)">
        üìã <span>Meus Rascunhos</span>
      </div>
      <div class="menu-item" onclick="showSection('pending', this)">
        üìù <span>Aprovar Letra</span>
      </div>
      <div class="menu-item" onclick="showSection('approved', this)">
        üéπ <span>Letras Aprovadas</span>
      </div>
      <div class="menu-item" onclick="showSection('received', this)">
        üéµ <span>M√∫sicas Recebidas</span>
      </div>
      <div class="menu-item" onclick="showSection('profile', this)">
        üë§ <span>Minha Conta</span>
      </div>
    </nav>

    <button class="new-music-btn" onclick="openChat()">
      + Nova M√∫sica
    </button>
  </aside>

  <main class="main-content">
    <div class="header">
      <h2 id="pageTitle">Meus Rascunhos</h2>
      <div class="user-profile">
        <span id="userName">Usu√°rio</span>
        <div class="avatar">U</div>
        <button onclick="logout()" style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:0.9rem; margin-left:10px;">Sair</button>
      </div>
    </div>

    <div id="drafts" class="section active"></div>

    <div id="pending" class="section"></div>

    <div id="approved" class="section">
      <h2>Em Produ√ß√£o</h2>
      <p style="color:#64748b; margin-bottom: 20px;">Nossos artistas est√£o gravando essas m√∫sicas agora.</p>
      <div id="approved-list"></div>
    </div>

    <div id="received" class="section">
      <h2>M√∫sicas Prontas</h2>
      <p style="color:#64748b; margin-bottom: 20px;">Baixe e compartilhe suas cria√ß√µes.</p>
      <div id="received-list"></div>
    </div>

    <div id="profile" class="section">
      <h2>Meus Dados</h2>
      <div class="card profile-form">
        <label>Nome Completo</label>
        <input type="text" id="profName">

        <label>Email</label>
        <input type="email" id="profEmail" readonly style="background:#f1f5f9; color:#64748b;">

        <label>Nova Senha (deixe em branco para manter)</label>
        <input type="password" id="profPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">

        <button class="btn-save-profile" onclick="saveProfile()">Salvar Altera√ß√µes</button>
      </div>
    </div>
  </main>

  <!-- Toast de notifica√ß√µes -->
  <div class="toast-message" id="toastMessage"></div>

  <!-- NOVO: Config Global -->
  <script src="config.js"></script>
  <script src="form_options.js"></script> 
  <!-- Chat JS (agora sem redeclara√ß√£o) -->
  <script src="chat.js"></script>
  <script src="chat_themes_full.js"></script>


  

  <script>
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let userData = JSON.parse(localStorage.getItem("tuneCraftUser")) || { name: "Visitante", email: "", user_id: null, orders: [] };
    let currentAlterandoId = null;
    let editDraftCurrentPedidoId = null;

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toastMessage');
      toast.innerText = message;
      toast.className = `toast-message ${type}`;
      toast.style.display = 'block';

      setTimeout(() => {
        toast.style.display = 'none';
      }, 4000);
    }

    function normalizeStatus(s) {
      const v = (s || "").toLowerCase().replace(/\s+/g, "");
      if (v === "draft") return "draft";
      if (v === "pendingapproval" || v === "pending_approval" || v === "waiting_user_approval" || v === "waitinguserapproval") return "pending_approval";
      if (v === "aguardandoaprovacao" || v === "aguardando_aprovacao") return "aguardando_aprovacao";
      if (v === "production" || v === "inproduction" || v === "generatingaudio" || v === "generating_audio") return "production";
      if (v === "completed" || v === "done" || v === "received") return "completed";
      return v || "pending_approval";
    }

    function escapeHtml(str) {
      return (str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "'");
    }

    function extractSummaryFromPayload(payload) {
    const answers = payload.answers || {};
    const asked = payload.asked || [];
    const theme = answers.ai_metadata?.themeId || "indefinido";
    const genre = answers.musicStyle?.primaryGenre || "indefinido";
    
    // ‚úÖ Usar FORM_OPTIONS (vem de form_options.js)
    
    // Mapear tema usando FORM_OPTIONS.themes
    const themeOption = FORM_OPTIONS.themes.find(t => t.value === theme);
    const themeLabel = themeOption ? themeOption.label : "üé≠ Indefinido";
    
    // Mapear g√™nero usando FORM_OPTIONS.genres
    const genreOption = FORM_OPTIONS.genres.find(g => g.value === genre);
    const genreLabel = genreOption ? genreOption.label : "N√£o definido";
    
    // Obter primeira linha da mensagem principal
    const messagePreview = answers.lyricDetails?.mainMessage 
        ? answers.lyricDetails.mainMessage.substring(0, 70) + "..."
        : "Sem mensagem";
    
    return {
        recipient: themeLabel,  // Tema com emoji
        genre: genreLabel,      // G√™nero com emoji
        message: messagePreview,  // Pr√©via da mensagem
        asked_count: asked.length  // Quantas perguntas respondidas
    };
}

    async function getSessionOrRedirect() {
      const { data, error } = await sb.auth.getSession();
      if (error) console.warn("getSession error:", error);

      const session = data?.session;
      if (!session?.access_token || !session?.user?.id) {
        window.location.href = "login.html";
        return null;
      }
      return session;
    }

    async function loadOrdersFromSupabase() {
      const { data, error } = await sb
        .from("musicas_pedidos")
        .select("id,title,lyrics,status,created_at,audio_urls,versao_original,versao_modificada,versao_aprovada,alteracao_usada,versao_aprovada_tipo,alteracao_solicitada,payload")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Erro sb.from(musicas_pedidos):", error);
        return [];
      }

      return (data || []).map(r => {
        let audioUrls = r.audio_urls;

        if (Array.isArray(audioUrls) && audioUrls.length > 0 && typeof audioUrls[0] === 'string') {
          try {
            audioUrls = audioUrls.map(url => JSON.parse(url));
          } catch (e) {
            console.error("‚ùå Erro ao fazer parse de audio_urls:", e);
            audioUrls = [];
          }
        }

        return {
          id: r.id,
          title: r.title || "Sem t√≠tulo",
          lyrics: r.lyrics || "",
          status: normalizeStatus(r.status),
          created_at: r.created_at,
          audio_urls: audioUrls,
          versao_original: r.versao_original,
          versao_modificada: r.versao_modificada,
          versao_aprovada: r.versao_aprovada,
          alteracao_usada: r.alteracao_usada,
          versao_aprovada_tipo: r.versao_aprovada_tipo,
          alteracao_solicitada: r.alteracao_solicitada,
          payload: r.payload
        };
      });
    }

    async function initDashboard() {
      const session = await getSessionOrRedirect();
      if (!session) return;

      const fullName = session.user.user_metadata?.full_name || userData.name || "Usu√°rio";
      userData.name = fullName;
      userData.email = session.user.email || userData.email || "";
      userData.user_id = session.user.id;

      const orders = await loadOrdersFromSupabase();
      userData.orders = orders;

      localStorage.setItem("tuneCraftUser", JSON.stringify(userData));

      document.getElementById("userName").innerText = userData.name.split(" ")[0];
      document.querySelector(".avatar").innerText = userData.name.charAt(0);

      document.getElementById("profName").value = userData.name;
      document.getElementById("profEmail").value = userData.email;

      renderSections();
    }

    initDashboard();

    function showSection(id, element) {
      if (element) {
        document.querySelectorAll(".menu-item").forEach(i => i.classList.remove("active"));
        element.classList.add("active");
      }

      const titles = {
        drafts: "Meus Rascunhos",
        pending: "Aprovar Letra",
        approved: "Letras Aprovadas",
        received: "M√∫sicas Recebidas",
        profile: "Minha Conta"
      };
      document.getElementById("pageTitle").innerText = titles[id] || "Painel";

      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    function renderSections() {
      const draftsContainer = document.getElementById("drafts");
      const pendingContainer = document.getElementById("pending");
      const approvedContainer = document.getElementById("approved-list");
      const receivedContainer = document.getElementById("received-list");

      draftsContainer.innerHTML = "";
      pendingContainer.innerHTML = "";
      approvedContainer.innerHTML = "";
      receivedContainer.innerHTML = "";

      let hasDrafts = false;
      let hasPending = false;
      let hasApproved = false;
      let hasReceived = false;

      if (userData.orders && userData.orders.length > 0) {
        userData.orders.forEach(order => {
          const title = escapeHtml(order.title);
          const lyrics = escapeHtml(order.lyrics);

          if (order.status === "draft") {
            hasDrafts = true;
            const summary = extractSummaryFromPayload(order.payload);
draftsContainer.innerHTML += `
    <div class="card draft-card">
        <div class="card-header">
            <h3>üéµ ${summary.recipient}</h3>
            <span class="status-badge status-draft">Rascunho</span>
        </div>
        <div class="draft-summary">
            <p><strong>Tema:</strong> ${summary.recipient}</p>
            <p><strong>G√™nero:</strong> ${summary.genre}</p>
            <p><strong>Perguntas:</strong> ${summary.asked_count} respondidas</p>
            <p><strong>Descri√ß√£o:</strong> "${summary.message}"</p>
        </div>
        <div class="action-row">
                  <button class="btn btn-revise" onclick="editarDraft('${order.id}')">
                    ‚úèÔ∏è Editar Formul√°rio
                  </button>
                  <button class="btn btn-approve" onclick="irParaCheckout('${order.id}')">
                    üí≥ Pagar e Gerar Letra (R$ 49,90)
                  </button>
        </div>
    </div>
`;
          }
          else if (order.status === "pending_approval" && !order.versao_modificada) {
            hasPending = true;
            const podeAlterar = !order.alteracao_usada;

            pendingContainer.innerHTML += `
              <div class="card">
                <div class="card-header">
                  <h3>${title}</h3>
                  <span class="status-badge status-pending">Aguardando Aprova√ß√£o</span>
                </div>
                <p style="font-size:0.9rem; color:#64748b;">Leia a letra gerada abaixo.</p>
                <div class="lyrics-box">${lyrics}</div>
                <div class="action-row">
                  <button
                    class="btn btn-revise"
                    onclick="abrirModalAlteracao('${order.id}')"
                    ${!podeAlterar ? 'disabled title="Altera√ß√£o j√° foi usada"' : ''}
                  >
                    ${podeAlterar ? '‚úèÔ∏è Solicitar Altera√ß√£o (1x)' : 'üîí Altera√ß√£o Usada'}
                  </button>
                  <button class="btn btn-approve" id="btn-${order.id}" onclick="aprovarLetraOriginal('${order.id}')">
                    ‚úÖ Aprovar e Gerar √Åudio
                  </button>
                </div>
              </div>
            `;
          }
          else if (order.status === "aguardando_aprovacao" && order.versao_modificada) {
            hasPending = true;

            const versaoOriginal = order.versao_original || { customer_lyrics: order.lyrics };
            const versaoModificada = order.versao_modificada;

            pendingContainer.innerHTML += `
              <div class="card">
                <div class="card-header">
                  <h3>${title}</h3>
                  <span class="status-badge status-awaiting">Escolha uma Vers√£o</span>
                </div>

                <p style="font-size:0.9rem; color:#64748b; margin-bottom: 15px;">
                  Compare as duas vers√µes e escolha sua favorita:
                </p>

                ${versaoModificada.changelog ? `
                  <div class="version-changelog">
                    <strong>üìù O que foi alterado:</strong><br>
                    ${escapeHtml(versaoModificada.changelog)}
                  </div>
                ` : ''}

                <div class="comparison-container">
                  <div class="version-card">
                    <h4>üìÑ Vers√£o Original</h4>
                    <div class="lyrics-box" style="max-height: 250px;">
                      ${escapeHtml(versaoOriginal.customer_lyrics || versaoOriginal.lyrics)}
                    </div>
                    <button class="btn btn-select" onclick="aprovarVersao('${order.id}', 'original')">
                      ‚úÖ Escolher Esta
                    </button>
                  </div>

                  <div class="version-card">
                    <h4>‚ú® Vers√£o Modificada</h4>
                    <div class="lyrics-box" style="max-height: 250px;">
                      ${escapeHtml(versaoModificada.customer_lyrics)}
                    </div>
                    <button class="btn btn-select" onclick="aprovarVersao('${order.id}', 'modificada')">
                      ‚úÖ Escolher Esta
                    </button>
                  </div>
                </div>
              </div>
            `;
          }
          else if (order.status === "production") {
            hasApproved = true;
            approvedContainer.innerHTML += `
              <div class="card">
                <div class="card-header">
                  <h3>${title}</h3>
                  <span class="status-badge status-production">Em Produ√ß√£o</span>
                </div>
                <p>Letra aprovada! Estamos trabalhando no √°udio.</p>
              </div>
            `;
          }
          else if (order.status === "completed") {
            hasReceived = true;
            const urls = Array.isArray(order.audio_urls) ? order.audio_urls : [];

            receivedContainer.innerHTML += `
              <div class="card">
                <div class="card-header">
                  <h3>${title}</h3>
                  <span class="status-badge status-completed">Pronta</span>
                </div>

                ${
                  urls.length >= 2
                    ? `
                      <strong>üéß Vers√£o A</strong>
                      <audio controls src="${urls[0].audio_url || urls[0]}" style="width:100%; margin:10px 0;"></audio>

                      <strong>üéß Vers√£o B</strong>
                      <audio controls src="${urls[1].audio_url || urls[1]}" style="width:100%; margin:10px 0;"></audio>

                      <div class="action-row" style="margin-top:10px">
                        <a class="btn btn-download" href="${urls[0].audio_url || urls[0]}" download>‚¨áÔ∏è Baixar A</a>
                        <a class="btn btn-download" href="${urls[1].audio_url || urls[1]}" download>‚¨áÔ∏è Baixar B</a>
                      </div>
                    `
                    : urls.length === 1
                    ? `
                      <strong>üéß √Åudio</strong>
                      <audio controls src="${urls[0].audio_url || urls[0]}" style="width:100%; margin:10px 0;"></audio>
                      <a class="btn btn-download" href="${urls[0].audio_url || urls[0]}" download>‚¨áÔ∏è Baixar</a>
                    `
                    : `<p>Sua m√∫sica foi finalizada e est√° sendo preparada para audi√ß√£o.</p>`
                }
              </div>
            `;
          }
        });
      }

      if (!hasDrafts) {
        draftsContainer.innerHTML = `
          <div class="empty-state">
            <span class="empty-icon">üìã</span>
            <h3>Sem rascunhos no momento</h3>
            <p>Crie uma nova m√∫sica para come√ßar!</p>
            <button class="btn btn-approve" onclick="openChat()" style="margin-top:20px;">Criar Nova M√∫sica</button>
          </div>
        `;
      }

      if (!hasPending) {
        pendingContainer.innerHTML = `
          <div class="empty-state">
            <span class="empty-icon">‚ú®</span>
            <h3>Tudo em dia!</h3>
            <p>Voc√™ n√£o tem letras pendentes.</p>
            <button class="btn btn-approve" onclick="openChat()" style="margin-top:20px;">Criar Nova M√∫sica</button>
          </div>
        `;
      }

      if (!hasApproved) {
        approvedContainer.innerHTML = `
          <div class="empty-state" style="padding:20px;">
            <p>Sem m√∫sicas em produ√ß√£o no momento.</p>
          </div>
        `;
      }

      if (!hasReceived) {
        receivedContainer.innerHTML = `
          <div class="empty-state" style="padding:20px;">
            <p>Sem m√∫sicas prontas no momento.</p>
          </div>
        `;
      }
    }

    // ‚úÖ ALTERA√á√ÉO 4: FUN√á√ÉO EDITARDRAFT MODIFICADA
    function editarDraft(pedidoId) {
      console.log("üìù Abrindo editor para:", pedidoId);

      // ‚úÖ Abre o modal
      openEditDraftModal(pedidoId);
    }

    async function irParaCheckout(pedidoId) {
      try {
        localStorage.setItem('tuneCraft_pendingOrderId', pedidoId);
        localStorage.setItem('tuneCraft_checkoutEmail', userData.email);
        localStorage.setItem('tuneCraft_checkoutName', userData.name);


        console.log("üí≥ Redirecionando para checkout:", pedidoId);
        showToast("Redirecionando para checkout...", "info");


        setTimeout(() => {
          window.location.href = 'checkout.html';
        }, 500);


      } catch (error) {
        console.error("Erro ao redirecionar:", error);
        showToast(`‚ùå Erro: ${error.message}`, "error");
      }
    }

    function abrirModalAlteracao(pedidoId) {
      currentAlterandoId = pedidoId;
      document.getElementById('alterarModal').classList.add('active');

      document.getElementById('mudancasDesejadas').value = '';
      document.getElementById('manterElementos').value = '';
      document.getElementById('observacoesFinais').value = '';
      document.getElementById('count1').innerText = '0';
      document.getElementById('count2').innerText = '0';
      document.getElementById('count3').innerText = '0';
    }

    function fecharAlterarModal() {
      document.getElementById('alterarModal').classList.remove('active');
      currentAlterandoId = null;
    }

    function updateAlterarCharCount(fieldId, countId) {
      const field = document.getElementById(fieldId);
      const count = field.value.length;
      document.getElementById(countId).innerText = count;
    }

    async function submitAlteracao() {
      const mudancas = document.getElementById('mudancasDesejadas').value.trim();
      const manter = document.getElementById('manterElementos').value.trim();
      const obs = document.getElementById('observacoesFinais').value.trim();

      if (mudancas.length < 20) {
        showToast("Por favor, descreva as mudan√ßas com pelo menos 20 caracteres", "error");
        return;
      }

      if (manter.length < 10) {
        showToast("Por favor, especifique o que deve ser mantido (m√≠nimo 10 caracteres)", "error");
        return;
      }

      const btn = document.getElementById('btnSubmitAlteracao');
      btn.disabled = true;
      btn.innerText = "Processando...";

      const sugestoes = `
MUDAN√áAS DESEJADAS:
${mudancas}

ELEMENTOS QUE DEVEM PERMANECER:
${manter}

${obs ? `OBSERVA√á√ïES ADICIONAIS:\n${obs}` : ''}
      `.trim();

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/alterar-letra`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            pedidoId: currentAlterandoId,
            sugestoes: sugestoes
          })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Erro ao processar altera√ß√µes');
        }

        showToast("‚úÖ Vers√£o modificada criada! Compare as vers√µes.", "");
        fecharAlterarModal();

        userData.orders = await loadOrdersFromSupabase();
        localStorage.setItem("tuneCraftUser", JSON.stringify(userData));
        renderSections();

      } catch (error) {
        showToast(`‚ùå Erro: ${error.message}`, "error");
        btn.disabled = false;
        btn.innerText = "Enviar Altera√ß√µes ‚ú®";
      }
    }

   async function aprovarLetraOriginal(pedidoId) {
  try {
    console.log("‚úÖ Aprovando letra original e gerando √°udio para:", pedidoId);

    if (!pedidoId) {
      showToast("‚ùå Erro: ID do pedido n√£o encontrado", "error");
      return;
    }

    // ============================================
    // PASSO 1: Atualizar versao_escolhida no banco
    // ============================================

    console.log("üìù PASSO 1: Marcando vers√£o como escolhida...");

    const { error: updateErr } = await sb
      .from("musicas_pedidos")
      .update({
        versao_escolhida: "original",
        versao_aprovada_tipo: "original",
      })
      .eq("id", pedidoId);

    if (updateErr) {
      console.error("‚ùå Erro ao marcar vers√£o:", updateErr);
      showToast(`‚ùå Erro ao salvar: ${updateErr.message}`, "error");
      return;
    }

    console.log("‚úÖ Vers√£o marcada como original");

    // ============================================
    // PASSO 2: Gerar √°udio chamando generate-audio
    // ============================================

    console.log("üéµ PASSO 2: Chamando generate-audio...");

    const btn = document.getElementById(`btn-${pedidoId}`);
    if (btn) {
      btn.disabled = true;
      btn.textContent = "‚è≥ Gerando √°udio...";
    }

    showToast("üéµ Gerando √°udio da m√∫sica...", "info");

    // ‚úÖ CERTIFIQUE-SE DE CHAMAR COM JSON V√ÅLIDO
    const response = await fetch(
      "https://miupzfchvfbqbznfhvix.supabase.co/functions/v1/generate-audio",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          pedido_id: pedidoId,  // ‚úÖ KEY CORRETO!
        }),
      }
    );

    console.log("üì§ Status da resposta:", response.status);

    // ============================================
    // VERIFICAR RESPOSTA
    // ============================================

    if (!response.ok) {
      const errorText = await response.text().catch(() => "Erro desconhecido");
      console.error("‚ùå Erro de resposta:", response.status, errorText);
      showToast(`‚ùå Erro ao gerar √°udio: ${response.status}`, "error");

      if (btn) {
        btn.disabled = false;
        btn.textContent = "‚úÖ Aprovar e Gerar √Åudio";
      }
      return;
    }

    const result = await response.json().catch(() => ({}));
    console.log("‚úÖ Resposta da gera√ß√£o:", result);

    // ============================================
    // SUCESSO
    // ============================================

    showToast("‚úÖ √Åudio enviado para produ√ß√£o! Voc√™ receber√° em breve.", "success");

    setTimeout(() => {
      location.reload();
    }, 2000);

  } catch (error) {
    console.error("‚ùå ERRO em aprovarLetraOriginal:", error);
    showToast(`‚ùå ${error.message}`, "error");

    const btn = document.getElementById(`btn-${pedidoId}`);
    if (btn) {
      btn.disabled = false;
      btn.textContent = "‚úÖ Aprovar e Gerar √Åudio";
    }
  }
}
   async function aprovarVersao(pedidoId, tipo) {
  try {
    console.log(`‚úÖ Aprovando vers√£o ${tipo} para:`, pedidoId);

    if (!pedidoId || !tipo) {
      showToast("‚ùå Erro: Dados inv√°lidos", "error");
      return;
    }

    const tipoNormalizado = tipo.toLowerCase();
    if (!["original", "modificada"].includes(tipoNormalizado)) {
      showToast("‚ùå Erro: Tipo de vers√£o inv√°lido", "error");
      return;
    }

    // ============================================
    // PASSO 1: Atualizar versao_escolhida
    // ============================================

    console.log("üìù PASSO 1: Marcando vers√£o escolhida...");

    const { error: updateErr } = await sb
      .from("musicas_pedidos")
      .update({
        versao_escolhida: tipoNormalizado,
        versao_aprovada_tipo: tipoNormalizado,
        status: "production",
      })
      .eq("id", pedidoId);

    if (updateErr) {
      console.error("‚ùå Erro ao marcar vers√£o:", updateErr);
      showToast(`‚ùå Erro ao salvar: ${updateErr.message}`, "error");
      return;
    }

    console.log("‚úÖ Vers√£o marcada como aprovada");

    // ============================================
    // PASSO 2: Gerar √°udio
    // ============================================

    console.log("üéµ PASSO 2: Gerando √°udio...");

    showToast("üéµ Gerando √°udio da m√∫sica...", "info");

    const response = await fetch(
      "https://miupzfchvfbqbznfhvix.supabase.co/functions/v1/generate-audio",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          pedido_id: pedidoId,
        }),
      }
    );

    console.log("üì§ Status:", response.status);

    if (!response.ok) {
      const errorText = await response.text().catch(() => "Erro desconhecido");
      console.error("‚ùå Erro:", response.status, errorText);
      showToast(`‚ùå Erro ao gerar √°udio: ${response.status}`, "error");
      return;
    }

    const result = await response.json().catch(() => ({}));
    console.log("‚úÖ √Åudio enviado:", result);

    showToast("‚úÖ M√∫sica em produ√ß√£o! Voc√™ receber√° em breve.", "success");

    setTimeout(() => {
      location.reload();
    }, 2000);

  } catch (error) {
    console.error("‚ùå ERRO em aprovarVersao:", error);
    showToast(`‚ùå ${error.message}`, "error");
  }
}

// ============================================
// VERIFICA√á√ÉO AO CARREGAR
// ============================================

document.addEventListener("DOMContentLoaded", function() {
  console.log("‚úÖ Fun√ß√µes de aprova√ß√£o carregadas");
  console.log("üìç URL generate-audio configurada como:");
  console.log("   https://miupzfchvfbqbznfhvix.supabase.co/functions/v1/generate-audio");
});

    function saveProfile() {
      const newName = document.getElementById("profName").value;
      const newPass = document.getElementById("profPass").value;

      userData.name = newName;
      if (newPass) userData.password = newPass;

      localStorage.setItem("tuneCraftUser", JSON.stringify(userData));

      document.getElementById("userName").innerText = newName.split(" ")[0];
      document.querySelector(".avatar").innerText = newName.charAt(0);

      showToast("‚úÖ Perfil atualizado com sucesso!", "");
    }

    async function logout() {
      try {
        await sb.auth.signOut();
      } catch (e) {
        console.error("Erro ao deslogar:", e);
      }

      localStorage.removeItem("tuneCraftUser");
      window.location.href = "login.html";
    }
  </script>

  <!-- ‚úÖ ALTERA√á√ÉO 3: JAVASCRIPT DO MODAL DE EDI√á√ÉO -->
  <script>
    function showEditDraftToast(message, type = 'info') {
      const toast = document.getElementById('editDraftToast');
      toast.innerText = message;
      toast.className = `edit-draft-toast ${type}`;
      toast.style.display = 'block';
      
      setTimeout(() => {
        toast.style.display = 'none';
      }, 4000);
    }

    // ============================================
// FUN√á√ÉO: Converter asked[] ‚Üí campos edit√°veis
// ============================================

function convertAskedToEditFormat(asked) {
    /**
     * Transforma o array asked[] em objeto com step0, step1, step2...
     * Para compatibilidade com o formul√°rio de edi√ß√£o
     */
    
    const result = {};
    
    if (!asked || !Array.isArray(asked)) {
        return result;
    }

    asked.forEach((item, index) => {
        // Cada item tem:
        // - fieldName: "recipient.name"
        // - answerValue: "Maria"
        
        // Para manter compatibilidade com step0, step1, step2...
        // Precisamos mapear o fieldName de volta para stepX
        
        const fieldName = item.fieldName; // ex: "recipient.name"
        const answerValue = item.answerValue;
        
        // Mapeamento: tema ‚Üí step0, recipient.name ‚Üí step2, etc
        const fieldToStepMap = {
            "ai_metadata.themeId": "step0",
            
            // Birthday
            "recipient.name": "step2",
            "ai_metadata.relationship": "step1",
            "lyricDetails.mainMessage": "step4",
            "ai_metadata.pov": "step3",
            "lyricDetails.specialMentions": "step5",
            "recipient.personality": "step6",
            "lyricDetails.secretDetail": "step7",
            "recipient.specialCharacteristics": "step8",
            "final.futureWish": "step9",
            "musicStyle.primaryGenre": "step10",
            "musicStyle.mood": "step11",
            "musicStyle.tempo": "step12",
            "lyricDetails.language": "step13",
            "productionDetails.vocalApproach": "step14",
            
            // Pregnancy announcement
            "ai_metadata.audience": "step1",
            "ai_metadata.narratorRole": "step2",
            "ai_metadata.pregnancyStage": "step3",
            "lyricDetails.scene": "step5",
            "lyricDetails.desiredImpact": "step6",
            "lyricDetails.symbolicDetail": "step7",
            "lyricDetails.announcementLine": "step8",
            "lyricDetails.avoid": "step9",
            
            // Love declaration
            "lyricDetails.origin": "step1",
            "lyricDetails.turningPoint": "step2",
            "lyricDetails.transformation": "step3",
            "lyricDetails.unsaid": "step4",
            "lyricDetails.simpleScene": "step5",
            "lyricDetails.withYouI": "step7",
        };
        
        const stepKey = fieldToStepMap[fieldName];
        
        if (stepKey) {
            result[stepKey] = answerValue;
        }
        
        // Adicionar tamb√©m por √≠ndice original (seguran√ßa)
        result[`asked_${index}`] = {
            fieldName: fieldName,
            value: answerValue,
            question: item.question
        };
    });
    
    return result;
}
    
    async function openEditDraftModal(pedidoId) {
      editDraftCurrentPedidoId = pedidoId;
      const modal = document.getElementById('editDraftModal');
      modal.classList.add('active');
      
      await loadEditDraft(pedidoId);
    }

    function closeEditDraftModal() {
      const modal = document.getElementById('editDraftModal');
      modal.classList.remove('active');
      editDraftCurrentPedidoId = null;
    }

   async function loadEditDraft(pedidoId) {
    const loading = document.getElementById("editDraftLoading");
    const form = document.getElementById("editDraftForm");
    
    loading.style.display = "flex";
    form.style.display = "none";
    
    try {
        console.log("üì• Carregando draft:", pedidoId);
        
        const { data, error } = await sb
            .from("musicas_pedidos")
            .select()
            .eq("id", pedidoId)
            .single();
        
        if (error) throw error;
        
        const payload = data.payload;
        console.log("üìä Payload completo:", payload);
        console.log("üìã Array asked[]:", payload.asked);
        console.log("üíæ Objeto answers{}:", payload.answers);
        
        document.getElementById("editDraftHeaderInfo").innerText = 
            `Criado em ${new Date(data.created_at).toLocaleDateString("pt-BR")}`;
        
        const asked = payload.asked || [];
        const answers = payload.answers || {};
        
        if (!asked || asked.length === 0) {
            throw new Error("Nenhuma resposta encontrada neste rascunho");
        }
        
        // ============================================
        // RENDERIZAR DIN√ÇMICAMENTE A PARTIR DE asked[]
        // ============================================
        
        let formHTML = "";
        let currentSection = null;
        
        asked.forEach((item, index) => {
            // Agrupar por se√ß√£o
            if (item.section !== currentSection) {
                currentSection = item.section;
                formHTML += `<div class="edit-draft-section-title">${currentSection}</div>`;
            }
            
            // Gerar ID √∫nico para o campo
            const fieldId = `edit_${item.fieldName.replace(/\./g, "_")}`;
            const fieldValue = item.answerValue || "";
            const labelText = item.question || item.fieldName;
            
            // Renderizar de acordo com o tipo
            formHTML += `
                <div class="edit-draft-form-group">
                    <label>${labelText}</label>
                    <div class="field-name">${item.fieldName}</div>
            `;
            
            // ‚úÖ Se √© um select com op√ß√µes (dedu conforme answerValue)
            if (item.answerValue && 
                (item.fieldName.includes("themeId") || 
                 item.fieldName.includes("mood") || 
                 item.fieldName.includes("tempo") ||
                 item.fieldName.includes("genre") ||
                 item.fieldName.includes("audience") ||
                 item.fieldName.includes("narratorRole") ||
                 item.fieldName.includes("pregnancyStage") ||
                 item.fieldName.includes("language") ||
                 item.fieldName.includes("vocalApproach") ||
                 item.fieldName.includes("pov"))) {
                
                formHTML += renderSelectField(fieldId, item.fieldName, fieldValue);
            }
            // ‚úÖ Se √© textarea (longo)
            else if (item.answerValue && item.answerValue.length > 50) {
                formHTML += `
                    <textarea id="${fieldId}" rows="3">${escapeHtml(fieldValue)}</textarea>
                `;
            }
            // ‚úÖ Default: input text
            else {
                formHTML += `
                    <input type="text" id="${fieldId}" value="${escapeHtml(fieldValue)}" />
                `;
            }
            
            formHTML += `</div>`;
        });
        
        // BOT√ïES
        formHTML += `
            <div class="edit-draft-actions">
                <button type="button" class="edit-draft-btn edit-draft-btn-cancel" onclick="closeEditDraftModal()">Cancelar</button>
                <button type="button" class="edit-draft-btn edit-draft-btn-save" onclick="saveEditDraftDynamic()">Salvar Altera√ß√µes</button>
            </div>
        `;
        
        form.innerHTML = formHTML;
        
        // Guardar dados originais para facilitar salvamento
        window.editDraftData = {
            pedidoId: pedidoId,
            asked: asked,
            answers: answers
        };
        
        loading.style.display = "none";
        form.style.display = "block";
        
    } catch (error) {
        console.error("‚ùå Erro ao carregar rascunho:", error);
        showEditDraftToast(`Erro: ${error.message}`, "error");
        closeEditDraftModal();
    }
}

    // ============================================
// HELPER: Renderizar select fields dinamicamente
// ============================================

function renderSelectField(fieldId, fieldName, currentValue) {
    const options = getOptionsForField(fieldName, currentValue);
    
    let html = `<select id="${fieldId}">`;
    options.forEach(opt => {
        const selected = currentValue === opt.value ? "selected" : "";
        html += `<option value="${opt.value}" ${selected}>${opt.label}</option>`;
    });
    html += `</select>`;
    
    return html;
}

// ============================================
// HELPER: Retornar op√ß√µes de cada campo
// ============================================

function getOptionsForField(fieldName, currentValue) {
    if (fieldName.includes("themeId")) return FORM_OPTIONS.themes;
    if (fieldName.includes("mood")) return FORM_OPTIONS.moods;
    if (fieldName.includes("tempo")) return FORM_OPTIONS.tempos;
    if (fieldName.includes("genre") || fieldName.includes("Genre")) return FORM_OPTIONS.genres;
    if (fieldName.includes("audience")) return FORM_OPTIONS.audiences;
    if (fieldName.includes("narratorRole")) return FORM_OPTIONS.narratorRoles;
    if (fieldName.includes("pregnancyStage")) return FORM_OPTIONS.pregnancyStages;
    if (fieldName.includes("language")) return FORM_OPTIONS.languages;
    if (fieldName.includes("vocalApproach")) return FORM_OPTIONS.vocalApproaches;
    if (fieldName.includes("pov")) return FORM_OPTIONS.povs;
    if (fieldName.includes("ageGroup")) return FORM_OPTIONS.ageGroups;
    
    return [];
}

// ============================================
// HELPER: Escape HTML
// ============================================

function escapeHtml(str) {
    if (!str) return "";
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

    async function saveEditDraftDynamic() {
    if (!editDraftCurrentPedidoId || !window.editDraftData) return;
    
    const btn = document.querySelector(".edit-draft-btn-save");
    btn.disabled = true;
    btn.innerText = "Salvando...";
    
    try {
        console.log("üíæ Salvando draft:", editDraftCurrentPedidoId);
        
        const originalAsked = window.editDraftData.asked;
        const updatedAnswers = {};
        
        // Iterar sobre CADA item respondido originalmente
        originalAsked.forEach((item) => {
            const fieldId = `edit_${item.fieldName.replace(/\./g, "_")}`;
            const inputElement = document.getElementById(fieldId);
            
            if (inputElement) {
                const newValue = inputElement.value || inputElement.textContent;
                
                // Organizar em estrutura de answers{}
                const parts = item.fieldName.split(".");
                if (parts.length === 2) {
                    const [parent, child] = parts;
                    if (!updatedAnswers[parent]) {
                        updatedAnswers[parent] = {};
                    }
                    updatedAnswers[parent][child] = newValue;
                } else {
                    updatedAnswers[item.fieldName] = newValue;
                }
                
                console.log(`‚úèÔ∏è ${item.fieldName} ‚Üí ${newValue}`);
            }
        });
        
        console.log("üìä Answers atualizado:", updatedAnswers);
        
        // Salvar no Supabase
        const { error } = await sb
            .from("musicas_pedidos")
            .update({
                payload: {
                    form_id: "tc_chat_v2",
                    form_version: 2,
                    asked: originalAsked,  // Manter o asked original
                    answers: updatedAnswers,  // Atualizar answers
                    updated_at: new Date().toISOString()
                }
            })
            .eq("id", editDraftCurrentPedidoId);
        
        if (error) throw error;
        
        console.log("‚úÖ Draft salvo!");
        showEditDraftToast("Rascunho atualizado com sucesso!", "success");
        closeEditDraftModal();
        
        // Recarregar dados
        userData.orders = await loadOrdersFromSupabase();
        localStorage.setItem("tuneCraftUser", JSON.stringify(userData));
        renderSections();
        
    } catch (error) {
        console.error("‚ùå Erro ao salvar:", error);
        showEditDraftToast(`Erro: ${error.message}`, "error");
        btn.disabled = false;
        btn.innerText = "Salvar Altera√ß√µes";
    }
}
    
   
    // ============================================
// NOVA FUN√á√ÉO: saveEditDraftNew() - Salvar formato correto
// ============================================

async function saveEditDraftNew() {
    if (!editDraftCurrentPedidoId) return;
    
    const btn = document.querySelector(".edit-draft-btn-save");
    btn.disabled = true;
    btn.innerText = "Salvando...";
    
    try {
        console.log("üíæ Salvando draft:", editDraftCurrentPedidoId);
        
        // Coletar dados do formul√°rio
        const updatedAnswers = {
            ai_metadata: {
                themeId: document.getElementById("editStep0")?.value
            },
            recipient: {
                name: document.getElementById("editRecipientName")?.value
            },
            ai_metadata: {
                ...document.getElementById("editStep0") ? {themeId: document.getElementById("editStep0").value} : {},
                relationship: document.getElementById("editRelationship")?.value
            },
            lyricDetails: {
                mainMessage: document.getElementById("editMainMessage")?.value,
                scene: document.getElementById("editScene")?.value,
                secretDetail: document.getElementById("editSecretDetail")?.value
            },
            musicStyle: {
                primaryGenre: document.getElementById("editGenre")?.value,
                mood: document.getElementById("editMood")?.value,
                tempo: document.getElementById("editTempo")?.value
            }
        };
        
        // Remover campos undefined/vazios
        const cleanPayload = {};
        Object.keys(updatedAnswers).forEach(key => {
            if (updatedAnswers[key] && Object.keys(updatedAnswers[key]).length > 0) {
                cleanPayload[key] = updatedAnswers[key];
            }
        });
        
        console.log("üìä Payload atualizado:", cleanPayload);
        
        // Atualizar no Supabase
        const { error } = await sb
            .from("musicas_pedidos")
            .update({
                payload: cleanPayload
            })
            .eq("id", editDraftCurrentPedidoId);
        
        if (error) throw error;
        
        console.log("‚úÖ Draft salvo!");
        showEditDraftToast("Rascunho atualizado com sucesso!", "success");
        closeEditDraftModal();
        
        // Recarregar dados
        userData.orders = await loadOrdersFromSupabase();
        localStorage.setItem("tuneCraftUser", JSON.stringify(userData));
        renderSections();
        
    } catch (error) {
        console.error("‚ùå Erro ao salvar:", error);
        showEditDraftToast(`Erro: ${error.message}`, "error");
        btn.disabled = false;
        btn.innerText = "Salvar Alteraes";
    }
}

  </script>

</body>
</html>
























