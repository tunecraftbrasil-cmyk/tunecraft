<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout | TuneCraft</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://js.stripe.com/v3/"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
      color: #1e293b;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 500px;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .logo {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .logo-text {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #00d9ff, #6366f1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #64748b;
      margin-top: 5px;
    }

    .product-summary {
      background: #f8fafc;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #e2e8f0;
    }

    .product-name {
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 5px;
    }

    .product-description {
      font-size: 0.85rem;
      color: #64748b;
      margin-bottom: 15px;
    }

    .product-price {
      font-size: 1.5rem;
      font-weight: 700;
      color: #00d9ff;
    }

    .divider {
      height: 1px;
      background: #e2e8f0;
      margin: 20px 0;
    }

    .form-section {
      margin-bottom: 25px;
    }

    .form-label {
      display: block;
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 8px;
      color: #1e293b;
    }

    .form-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #00d9ff;
      box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
    }

    .form-input:disabled {
      background: #f1f5f9;
      color: #94a3b8;
    }

    #card-element {
      padding: 12px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      background: white;
    }

    .stripe-error {
      color: #ef4444;
      font-size: 0.85rem;
      margin-top: 5px;
      display: none;
    }

    .stripe-success {
      color: #10b981;
      font-size: 0.85rem;
      margin-top: 5px;
      display: none;
    }

    .btn-pay {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #00d9ff, #6366f1);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 20px;
    }

    .btn-pay:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 217, 255, 0.3);
    }

    .btn-pay:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .spinner {
      border: 3px solid #f1f5f9;
      border-top: 3px solid #00d9ff;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .footer-text {
      text-align: center;
      font-size: 0.75rem;
      color: #94a3b8;
      margin-top: 20px;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #00d9ff;
      text-decoration: none;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .info-box {
      background: #eff6ff;
      border-left: 3px solid #00d9ff;
      padding: 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      color: #0369a1;
      margin-bottom: 20px;
      display: none;
    }

    @media (max-width: 600px) {
      .container {
        padding: 25px;
      }

      .logo-text {
        font-size: 1.2rem;
      }

      .product-price {
        font-size: 1.3rem;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <a href="javascript:voltarDashboard()" class="back-link">‚Üê Voltar</a>

  <div class="header">
    <div class="logo">üéµ</div>
    <div class="logo-text">TuneCraft</div>
    <div class="subtitle">Checkout Seguro</div>
  </div>

  <div class="product-summary">
    <div class="product-name">üéµ Gera√ß√£o de M√∫sica</div>
    <div class="product-description">Gera uma m√∫sica personalizada com IA</div>
    <div class="product-price">R$ 39,90</div>
  </div>

  <div class="divider"></div>

  <div class="info-box" id="info-box"></div>

  <form id="payment-form">
    <div class="form-section">
      <label class="form-label">Nome Completo *</label>
      <input type="text" id="customer-name" class="form-input" placeholder="Jo√£o Silva" required>
    </div>

    <div class="form-section">
      <label class="form-label">Email *</label>
      <input type="email" id="customer-email" class="form-input" placeholder="joao@example.com" required>
    </div>

    <div class="form-section">
      <label class="form-label">Cart√£o de Cr√©dito *</label>
      <div id="card-element"></div>
      <div id="card-errors" class="stripe-error"></div>
    </div>

    <button type="submit" class="btn-pay" id="pay-button">
      Pagar R$ 39,90
    </button>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Processando pagamento...</p>
    </div>
  </form>

  <div class="footer-text">
    üí≥ Pagamento seguro processado por Stripe
  </div>
</div>

<script>
  const SUPABASE_URL = "https://miupzfchvfbqbznfhvix.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1pdXB6ZmNodmZicWJ6bmZodml4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxOTYwNzksImV4cCI6MjA4NDc3MjA3OX0.rz0W9qVovRvAeyBQ55LRewOAOM5a8pNJs1-UwWttATw";
  const STRIPE_PUBLIC_KEY = "pk_test_51StZvo1wgBnYhkbFGEWUqMCIhCzXBCzUrDxypLj7ge0InE6ZlQj4QXWHPmljSyaLqaC4hNxZvA0oZ4PWCEh6FJj10072HL9w8v";

  const stripe = Stripe(STRIPE_PUBLIC_KEY);
  const elements = stripe.elements();
  const cardElement = elements.create('card');
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  cardElement.mount('#card-element');

  // ‚úÖ Fun√ß√£o para preparar headers do Supabase
  function sbHeaders({ prefer = true } = {}) {
    const h = {
      apikey: SUPABASE_ANON_KEY,
      'Content-Type': 'application/json',
    };
    if (prefer) h.Prefer = "return=representation";
    return h;
  }

  // ‚úÖ Carregar dados do localStorage ao abrir p√°gina
  function loadCheckoutData() {
    const pedidoId = localStorage.getItem('tuneCraft_pendingOrderId');
    const email = localStorage.getItem('tuneCraft_checkoutEmail');
    const name = localStorage.getItem('tuneCraft_checkoutName');
    
    if (!pedidoId || !email || !name) {
      showInfo("‚ùå Nenhum pagamento pendente. Redirecionando...");
      setTimeout(() => {
        window.location.href = "index.html";
      }, 2000);
      return;
    }

    // ‚úÖ Pr√©-preencher campos
    document.getElementById('customer-name').value = name;
    document.getElementById('customer-email').value = email;
    
    console.log("‚úÖ Dados carregados:", { pedidoId, name, email });
  }

  function showInfo(message) {
    const box = document.getElementById('info-box');
    box.textContent = message;
    box.style.display = 'block';
  }

  // ‚úÖ Verificar erros do Stripe
  cardElement.addEventListener('change', (event) => {
    const displayError = document.getElementById('card-errors');
    if (event.error) {
      displayError.textContent = event.error.message;
      displayError.style.display = 'block';
    } else {
      displayError.textContent = '';
      displayError.style.display = 'none';
    }
  });

  // ‚úÖ Fun√ß√£o para voltar ao dashboard
  function voltarDashboard() {
    if (confirm("Descartar esta compra e voltar?")) {
      localStorage.removeItem('tuneCraft_pendingOrderId');
      localStorage.removeItem('tuneCraft_checkoutEmail');
      localStorage.removeItem('tuneCraft_checkoutName');
      window.location.href = "dashboard.html";
    }
  }

  // ‚úÖ Submeter pagamento
  document.getElementById('payment-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('customer-name').value.trim();
    const email = document.getElementById('customer-email').value.trim();
    const pedidoId = localStorage.getItem('tuneCraft_pendingOrderId');

    if (!name || !email) {
      alert("Preencha nome e email!");
      return;
    }

    document.getElementById('loading').style.display = 'block';
    document.getElementById('pay-button').disabled = true;

    try {
      // ‚úÖ 1. Criar Payment Intent na Edge Function do Supabase
      console.log("üì§ Chamando Edge Function: create-payment-intent");
      
      const piResponse = await fetch(`${SUPABASE_URL}/functions/v1/create-payment-intent`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify({
          amount: 3990, // R$ 39,90 em centavos
          currency: 'brl',
          customerName: name,
          customerEmail: email,
          orderId: pedidoId  // ‚Üê Enviar o ID do pedido para rastrear no webhook
        })
      });

      const piData = await piResponse.json();

      if (!piResponse.ok) {
        console.error("‚ùå Erro da Edge Function:", piData);
        throw new Error(piData.error || `Erro HTTP ${piResponse.status}: ${piData.message}`);
      }

      if (!piData.clientSecret) {
        console.error("‚ùå clientSecret n√£o retornado:", piData);
        throw new Error('Resposta inv√°lida do servidor');
      }

      console.log("‚úÖ Payment Intent criado:", piData.clientSecret);

      // ‚úÖ 2. Confirmar pagamento com Stripe usando confirmCardPayment
      console.log("üí≥ Confirmando pagamento com Stripe...");
      
      const result = await stripe.confirmCardPayment(piData.clientSecret, {
        payment_method: {
          card: cardElement,
          billing_details: {
            name: name,
            email: email
          }
        }
      });

      console.log("Resultado Stripe:", result);

      if (result.error) {
        console.error("‚ùå Erro Stripe:", result.error);
        throw new Error(result.error.message);
      }

      if (result.paymentIntent.status !== 'succeeded') {
        console.error("‚ùå Pagamento n√£o foi aprovado:", result.paymentIntent.status);
        throw new Error(`Pagamento ${result.paymentIntent.status}`);
      }

      // ‚úÖ 3. NOVO: Ap√≥s pagamento aprovado
      console.log("‚úÖ Pagamento aprovado! ID:", result.paymentIntent.id);

      // ‚úÖ 3.1. Atualizar status para 'payment_received' no Supabase
      console.log("üìù Atualizando status para 'payment_received'...");
      
      const updateResp = await fetch(`${SUPABASE_URL}/rest/v1/musicas_pedidos?id=eq.${pedidoId}`, {
        method: 'PATCH',
        headers: sbHeaders({ prefer: true }),
        body: JSON.stringify({
          status: 'payment_received',
          stripe_payment_intent_id: result.paymentIntent.id,
          payment_date: new Date().toISOString()
        })
      });

      if (!updateResp.ok) {
        const errText = await updateResp.text();
        console.error("‚ùå Erro ao atualizar status:", updateResp.status, errText);
        throw new Error(`Erro ao atualizar pedido: ${updateResp.status}`);
      }

      console.log("‚úÖ Status atualizado para 'payment_received'");

      // ‚úÖ 3.2. Chamar Edge Function para gerar letra
      console.log("üéµ Chamando Edge Function: generate-lyrics...");
      
      const genResp = await fetch(`${SUPABASE_URL}/functions/v1/generate-lyrics`, {
        method: 'POST',
        headers: sbHeaders({ prefer: false }),
        body: JSON.stringify({ pedidoId })
      });

      if (!genResp.ok) {
        const errText = await genResp.text();
        console.error("‚ùå Erro ao gerar letra:", genResp.status, errText);
        throw new Error(`Erro ao gerar letra: ${genResp.status}`);
      }

      const genData = await genResp.json();
      console.log("‚úÖ Letra gerada com sucesso:", genData);

      showToast("‚úÖ Pagamento confirmado! Gerando letra...", "success");

      // ‚úÖ 3.3. Limpar localStorage
      localStorage.removeItem('tuneCraft_pendingOrderId');
      localStorage.removeItem('tuneCraft_checkoutEmail');
      localStorage.removeItem('tuneCraft_checkoutName');

      // ‚úÖ 3.4. Redirecionar para dashboard (se√ß√£o de letras para aprovar)
      setTimeout(() => {
        window.location.href = 'dashboard.html?section=pending';
      }, 2000);

    } catch (error) {
      console.error("‚ùå Erro completo:", error);
      
      const errorDisplay = document.getElementById('card-errors');
      errorDisplay.textContent = `‚ùå ${error.message}`;
      errorDisplay.style.display = 'block';
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('pay-button').disabled = false;
    }
  });

  function showToast(message, type) {
    const div = document.createElement('div');
    div.textContent = message;
    div.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: ${type === 'success' ? '#10b981' : '#ef4444'};
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      z-index: 9999;
      font-weight: 600;
    `;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 4000);
  }

  // ‚úÖ Carregar dados ao abrir p√°gina
  window.addEventListener('load', loadCheckoutData);
</script>

</body>
</html>
