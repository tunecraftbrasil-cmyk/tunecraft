<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Editar Rascunho | TuneCraft</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f1f5f9;
      color: #1e293b;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 30px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 20px;
    }

    .header h1 {
      color: #1e293b;
      font-size: 28px;
    }

    .header-info {
      font-size: 0.9rem;
      color: #64748b;
    }

    .back-btn {
      background: #64748b;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
    }

    .back-btn:hover {
      background: #475569;
    }

    .form-group {
      margin-bottom: 25px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #00d9ff;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #1e293b;
      font-size: 0.95rem;
    }

    .form-group .field-name {
      font-size: 0.8rem;
      color: #94a3b8;
      margin-bottom: 5px;
      font-family: monospace;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #cbd5e1;
      border-radius: 6px;
      font-size: 15px;
      font-family: inherit;
      transition: 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #00d9ff;
      box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .references-container {
      display: grid;
      gap: 12px;
    }

    .reference-item {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .reference-item input {
      padding: 10px;
      border: 2px solid #cbd5e1;
      border-radius: 6px;
      font-size: 14px;
    }

    .reference-item input:focus {
      outline: none;
      border-color: #00d9ff;
      box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #1e293b;
      margin-top: 30px;
      margin-bottom: 15px;
      padding: 10px 0;
      border-bottom: 2px solid #e2e8f0;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 40px;
      padding-top: 30px;
      border-top: 2px solid #e2e8f0;
      justify-content: space-between;
    }

    .btn {
      padding: 14px 30px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: 0.3s;
      font-size: 15px;
    }

    .btn-save {
      background: linear-gradient(135deg, #00d9ff, #6366f1);
      color: white;
      flex: 2;
    }

    .btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 217, 255, 0.3);
    }

    .btn-save:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
      transform: none;
    }

    .btn-cancel {
      background: white;
      border: 2px solid #cbd5e1;
      color: #64748b;
      flex: 1;
    }

    .btn-cancel:hover {
      background: #f1f5f9;
      border-color: #94a3b8;
    }

    .toast-message {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: none;
      z-index: 9999;
      animation: slideIn 0.3s;
    }

    .toast-message.error {
      background: #ef4444;
    }

    .toast-message.info {
      background: #3b82f6;
    }

    @keyframes slideIn {
      from { transform: translateX(400px); }
      to { transform: translateX(0); }
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 300px;
      font-size: 18px;
      color: #94a3b8;
    }

    .field-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 768px) {
      .field-row {
        grid-template-columns: 1fr;
      }

      .container {
        padding: 20px;
      }

      .header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }

      .action-buttons {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <div>
        <h1>‚úèÔ∏è Editar Rascunho</h1>
        <div class="header-info" id="headerInfo">Carregando...</div>
      </div>
      <button class="back-btn" onclick="goBack()">‚Üê Voltar</button>
    </div>

    <div id="loadingState" class="loading">
      ‚è≥ Carregando rascunho...
    </div>

    <form id="editForm" style="display: none;">
      <!-- DESTINAT√ÅRIO -->
      <div class="section-title">üë§ DESTINAT√ÅRIO</div>

      <div class="form-group">
        <label>Relacionamento</label>
        <div class="field-name">step1</div>
        <select id="step1">
          <option value="">-- Selecionar --</option>
          <option value="romantic">Namorada/Namorado üíï</option>
          <option value="parent">M√£e/Pai üë®‚Äçüë©‚Äçüëß</option>
          <option value="child">Filho/Filha üë∂</option>
          <option value="grandparent">Av√≥/Av√¥ üëµ</option>
          <option value="friend">Amigo/Amiga üë•</option>
          <option value="colleague">Colega de trabalho üíº</option>
          <option value="sibling">Irm√£o/Irm√£ üë¨</option>
          <option value="mentor">Professor/Mentora üéì</option>
          <option value="group">Grupo/Fam√≠lia üë®‚Äçüë©‚Äçüëß‚Äçüë¶</option>
          <option value="other">Outro üé≠</option>
        </select>
      </div>

      <div class="form-group" id="step1_5_group" style="display: none;">
        <label>Descreva o relacionamento</label>
        <div class="field-name">step1.5</div>
        <textarea id="step1_5" placeholder="Ex: Meu vizinho que √© como um pai para mim..."></textarea>
      </div>

      <div class="form-group">
        <label>Nome da pessoa</label>
        <div class="field-name">step2</div>
        <input type="text" id="step2" placeholder="Ex: Maria" />
      </div>

      <div class="form-group">
        <label>Faixa et√°ria</label>
        <div class="field-name">step3</div>
        <select id="step3">
          <option value="">-- Selecionar --</option>
          <option value="child_12">Crian√ßa (at√© 12 anos)</option>
          <option value="teen">Teen (13-19 anos)</option>
          <option value="adult_young">Jovem adulto (20-35 anos)</option>
          <option value="adult_middle">Adulto (36-55 anos)</option>
          <option value="adult_senior">Senior (56+ anos)</option>
        </select>
      </div>

      <div class="form-group">
        <label>Personalidade</label>
        <div class="field-name">step4</div>
        <textarea id="step4" placeholder="Ex: Alegre, extrovertida, adora dan√ßar..."></textarea>
      </div>

      <div class="form-group">
        <label>Caracter√≠sticas especiais (Opcional)</label>
        <div class="field-name">step5</div>
        <textarea id="step5" placeholder="Ex: Faz bolos incr√≠veis..."></textarea>
      </div>

      <!-- OCASI√ÉO -->
      <div class="section-title">üéâ OCASI√ÉO</div>

      <div class="form-group">
        <label>Tipo de ocasi√£o</label>
        <div class="field-name">step6</div>
        <select id="step6">
          <option value="">-- Selecionar --</option>
          <option value="proposal">Pedido de Casamento üíç</option>
          <option value="birthday">Anivers√°rio üéÇ</option>
          <option value="confession">Declara√ß√£o de Amor üíï</option>
          <option value="tribute">Homenagem especial üåπ</option>
          <option value="goodbye">Despedida/Adeus üëã</option>
          <option value="celebration">Comemora√ß√£o (formatura, promo√ß√£o, etc) üéì</option>
          <option value="apology">Pedido de desculpas ü§ù</option>
          <option value="friendship">Comemora√ß√£o de amizade üë•</option>
          <option value="other">Outra ocasi√£o üìÖ</option>
        </select>
      </div>

      <div class="form-group" id="step6_5_group" style="display: none;">
        <label>Descreva a ocasi√£o</label>
        <div class="field-name">step6.5</div>
        <textarea id="step6_5" placeholder="Ex: Aposentadoria ap√≥s 40 anos..."></textarea>
      </div>

      <div class="form-group">
        <label>Data da ocasi√£o (Opcional)</label>
        <div class="field-name">step7</div>
        <input type="date" id="step7" />
      </div>

      <!-- ESTILO MUSICAL -->
      <div class="section-title">üéµ ESTILO MUSICAL</div>

      <div class="form-group">
        <label>G√™nero musical</label>
        <div class="field-name">step8</div>
        <select id="step8">
          <option value="">-- Selecionar --</option>
          <option value="pop">Pop moderno</option>
          <option value="sertanejo">Sertanejo</option>
          <option value="rock">Rock/Rock alternativo</option>
          <option value="rap">Rap/Trap</option>
          <option value="samba">Samba/Pagode</option>
          <option value="acoustic">Ac√∫stico/MPB</option>
          <option value="electronic">Eletr√¥nico/House</option>
          <option value="reggae">Reggae</option>
          <option value="funk">Funk/Dance</option>
          <option value="forro">Forr√≥</option>
          <option value="gospel">Gospel/Espiritual</option>
          <option value="other">Outro üé∂</option>
        </select>
      </div>

      <div class="form-group" id="step8_5_group" style="display: none;">
        <label>Qual g√™nero ou mistura?</label>
        <div class="field-name">step8.5</div>
        <textarea id="step8_5" placeholder="Ex: Eletr√¥nico com influ√™ncia de samba..."></textarea>
      </div>

      <div class="form-group">
        <label>Tempo/ritmo</label>
        <div class="field-name">step9</div>
        <select id="step9">
          <option value="">-- Selecionar --</option>
          <option value="slow">Lenta e contemplativa (60-80 BPM)</option>
          <option value="moderate">Moderada e equilibrada (80-110 BPM)</option>
          <option value="fast">R√°pida e energ√©tica (110+ BPM)</option>
        </select>
      </div>

      <div class="form-group">
        <label>Energia da m√∫sica</label>
        <div class="field-name">step10</div>
        <select id="step10">
          <option value="">-- Selecionar --</option>
          <option value="low">Baixa (suave, intimista, relax)</option>
          <option value="medium">M√©dia (natural, fluida, equilibrada)</option>
          <option value="high">Alta (impacto, poderosa, celebrativa)</option>
        </select>
      </div>

      <!-- REFER√äNCIAS -->
      <div class="section-title">üé§ REFER√äNCIAS MUSICAIS</div>

      <div class="form-group">
        <label>Artistas e m√∫sicas que inspiram (at√© 3)</label>
        <div class="field-name">step11</div>
        <div class="references-container" id="referencesContainer">
          <!-- Preenchido por JS -->
        </div>
      </div>

      <!-- MENSAGEM -->
      <div class="section-title">üíñ MENSAGEM E EMO√á√ÉO</div>

      <div class="form-group">
        <label>Mensagem principal</label>
        <div class="field-name">step12</div>
        <textarea id="step12" placeholder="Ex: Quero contar nossa hist√≥ria..."></textarea>
      </div>

      <div class="form-group">
        <label>Men√ß√µes espec√≠ficas (Opcional)</label>
        <div class="field-name">step13</div>
        <textarea id="step13" placeholder="Ex: Mencionar Dourados, viagem para o Rio..."></textarea>
      </div>

      <div class="form-group">
        <label>Estilo de linguagem</label>
        <div class="field-name">step14</div>
        <select id="step14">
          <option value="">-- Selecionar --</option>
          <option value="poetic">Po√©tico e rom√¢ntico (com met√°foras)</option>
          <option value="conversational">Conversacional e natural</option>
          <option value="storytelling">Storytelling (contando uma hist√≥ria)</option>
          <option value="direct">Direto e emotivo</option>
          <option value="humorous">Bem-humorado (com humor e leveza)</option>
        </select>
      </div>

      <!-- PRODU√á√ÉO -->
      <div class="section-title">üéöÔ∏è PRODU√á√ÉO</div>

      <div class="form-group">
        <label>Tipo de voz</label>
        <div class="field-name">step15</div>
        <select id="step15">
          <option value="">-- Selecionar --</option>
          <option value="female_warm">Voz feminina (suave, calorosa, emotiva)</option>
          <option value="female_strong">Voz feminina (poderosa, energ√©tica, clara)</option>
          <option value="male_soft">Voz masculina (suave, intimista, delicada)</option>
          <option value="male_strong">Voz masculina (poderosa, grave, marcante)</option>
          <option value="duo">Dueto (homem + mulher alternando)</option>
          <option value="duo_harmony">Dueto (homem + mulher harmonizando)</option>
        </select>
      </div>

      <div class="form-group">
        <label>Estilo de produ√ß√£o</label>
        <div class="field-name">step16</div>
        <select id="step16">
          <option value="">-- Selecionar --</option>
          <option value="acoustic">Ac√∫stico puro (viol√£o, piano, natural)</option>
          <option value="acoustic_backing">Ac√∫stico com backing</option>
          <option value="studio_polish">Studio polish (profissional, limpo, brilhante)</option>
          <option value="live_feel">Live feel (como se tivesse ao vivo)</option>
          <option value="cinematic">Cinematic (√©pico, cinematogr√°fico, orquestrado)</option>
          <option value="electronic_modern">Eletr√¥nico/Moderno</option>
        </select>
      </div>

      <!-- BOT√ïES DE A√á√ÉO -->
      <div class="action-buttons">
        <button type="button" class="btn btn-cancel" onclick="goBack()">Cancelar</button>
        <button type="submit" class="btn btn-save" id="saveBtn">üíæ Salvar Altera√ß√µes</button>
      </div>
    </form>
  </div>

  <div class="toast-message" id="toastMessage"></div>

  <script>
    let currentPedidoId = null;
    let originalPayload = {};

    // ‚úÖ CRIAR CLIENT SUPABASE (se n√£o existir)
    if (!window.sb) {
      window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log("‚úÖ Supabase client criado em edit-draft.html");
    }

    // ‚úÖ Buscar pedidoId da URL
    const urlParams = new URLSearchParams(window.location.search);
    currentPedidoId = urlParams.get('id');

    if (!currentPedidoId) {
      showToast("‚ùå ID do rascunho n√£o fornecido", "error");
      setTimeout(() => window.location.href = 'dashboard.html', 2000);
    }

    // ============================================
    // CARREGAR DADOS DO RASCUNHO
    // ============================================

    async function loadDraft() {
      try {
        console.log("üîç Carregando rascunho:", currentPedidoId);

        const { data, error } = await window.sb
          .from('musicas_pedidos')
          .select('payload, created_at')
          .eq('id', currentPedidoId)
          .single();

        if (error) {
          console.error("‚ùå Erro ao carregar:", error);
          showToast("‚ùå Erro ao carregar rascunho", "error");
          return;
        }

        if (!data) {
          showToast("‚ùå Rascunho n√£o encontrado", "error");
          return;
        }

        originalPayload = { ...data.payload };
        console.log("‚úÖ Rascunho carregado:", originalPayload);

        // ‚úÖ Preencher formul√°rio
        preencherFormulario(data.payload);

        // ‚úÖ Atualizar header
        const criadoEm = new Date(data.created_at).toLocaleDateString('pt-BR');
        document.getElementById('headerInfo').innerHTML = `
          Rascunho ID: <strong>${currentPedidoId.substring(0, 8)}...</strong> | 
          Criado em: <strong>${criadoEm}</strong>
        `;

        // ‚úÖ Mostrar formul√°rio
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('editForm').style.display = 'block';

      } catch (err) {
        console.error("‚ùå Erro fatal:", err);
        showToast(`‚ùå Erro: ${err.message}`, "error");
      }
    }

    // ============================================
    // PREENCHER FORMUL√ÅRIO
    // ============================================

    function preencherFormulario(payload) {
      // Steps simples (select, input, textarea)
      for (let i = 1; i <= 16; i++) {
        const key = `step${i}`;
        const elem = document.getElementById(key);

        if (elem && payload[key]) {
          elem.value = payload[key];
        }
      }

      // Step 1.5 (customRelationship)
      if (payload.step1_5) {
        document.getElementById('step1_5').value = payload.step1_5;
      }

      // Step 6.5 (customDescription)
      if (payload.step6_5) {
        document.getElementById('step6_5').value = payload.step6_5;
      }

      // Step 8.5 (customGenre)
      if (payload.step8_5) {
        document.getElementById('step8_5').value = payload.step8_5;
      }

      // Step 11 (References array)
      const refsContainer = document.getElementById('referencesContainer');
      refsContainer.innerHTML = '';

      const refs = payload.step11 || [{}, {}, {}];
      for (let i = 0; i < 3; i++) {
        const ref = refs[i] || {};
        const html = `
          <div class="reference-item">
            <input type="text" id="ref_artist_${i}" placeholder="Artista" value="${ref.artist || ''}" />
            <input type="text" id="ref_song_${i}" placeholder="M√∫sica" value="${ref.song || ''}" />
          </div>
        `;
        refsContainer.innerHTML += html;
      }

      // ‚úÖ Atualizar visibilidade de campos condicionais
      atualizarCamposCondicionais();
    }

    // ============================================
    // CAMPOS CONDICIONAIS
    // ============================================

    function atualizarCamposCondicionais() {
      const step1 = document.getElementById('step1').value;
      document.getElementById('step1_5_group').style.display = step1 === 'other' ? 'block' : 'none';

      const step6 = document.getElementById('step6').value;
      document.getElementById('step6_5_group').style.display = step6 === 'other' ? 'block' : 'none';

      const step8 = document.getElementById('step8').value;
      document.getElementById('step8_5_group').style.display = step8 === 'other' ? 'block' : 'none';
    }

    // Event listeners para mostrar/esconder campos
    document.getElementById('step1').addEventListener('change', atualizarCamposCondicionais);
    document.getElementById('step6').addEventListener('change', atualizarCamposCondicionais);
    document.getElementById('step8').addEventListener('change', atualizarCamposCondicionais);

    // ============================================
    // SALVAR ALTERA√á√ïES
    // ============================================

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      try {
        showToast("üíæ Salvando altera√ß√µes...", "info");

        // ‚úÖ Coletar dados do formul√°rio
        const newPayload = {};

        // Steps simples
        for (let i = 1; i <= 16; i++) {
          const key = `step${i}`;
          const elem = document.getElementById(key);
          if (elem) {
            const value = elem.value.trim();
            newPayload[key] = value || undefined;
          }
        }

        // Step 1.5, 6.5, 8.5
        if (document.getElementById('step1_5')) {
          const val = document.getElementById('step1_5').value.trim();
          if (val) newPayload.step1_5 = val;
        }
        if (document.getElementById('step6_5')) {
          const val = document.getElementById('step6_5').value.trim();
          if (val) newPayload.step6_5 = val;
        }
        if (document.getElementById('step8_5')) {
          const val = document.getElementById('step8_5').value.trim();
          if (val) newPayload.step8_5 = val;
        }

        // Step 11 (References)
        const refs = [];
        for (let i = 0; i < 3; i++) {
          const artist = document.getElementById(`ref_artist_${i}`).value.trim();
          const song = document.getElementById(`ref_song_${i}`).value.trim();
          if (artist || song) {
            refs.push({ artist, song });
          }
        }
        if (refs.length > 0) newPayload.step11 = refs;

        console.log("üì¶ Novo payload:", newPayload);

        // ‚úÖ Atualizar no Supabase
        const { error } = await window.sb
          .from('musicas_pedidos')
          .update({
            payload: newPayload,
            updated_at: new Date().toISOString()
          })
          .eq('id', currentPedidoId);

        if (error) {
          console.error("‚ùå Erro ao atualizar:", error);
          showToast(`‚ùå Erro: ${error.message}`, "error");
          return;
        }

        console.log("‚úÖ Rascunho atualizado com sucesso!");
        showToast("‚úÖ Rascunho atualizado! Redirecionando...", "success");

        // ‚úÖ Redirecionar para dashboard
        setTimeout(() => {
          window.location.href = 'dashboard.html';
        }, 1500);

      } catch (err) {
        console.error("‚ùå Erro fatal:", err);
        showToast(`‚ùå Erro: ${err.message}`, "error");
      }
    });

    // ============================================
    // HELPERS
    // ============================================

    function goBack() {
      window.location.href = 'dashboard.html';
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toastMessage');
      toast.textContent = message;
      toast.className = `toast-message ${type}`;
      toast.style.display = 'block';

      setTimeout(() => {
        toast.style.display = 'none';
      }, 4000);
    }

    // ============================================
    // INIT
    // ============================================

    window.addEventListener('load', loadDraft);
  </script>
</body>
</html>
